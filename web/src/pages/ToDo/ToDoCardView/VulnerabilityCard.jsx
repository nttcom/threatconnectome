import ChevronRightIcon from "@mui/icons-material/ChevronRight";
import DnsOutlinedIcon from "@mui/icons-material/DnsOutlined";
import GroupOutlinedIcon from "@mui/icons-material/GroupOutlined";
import Inventory2OutlinedIcon from "@mui/icons-material/Inventory2Outlined";
import PersonOutlineIcon from "@mui/icons-material/PersonOutline";
import {
  Box,
  Button,
  Card,
  CardActions,
  CardContent,
  Chip,
  Divider,
  Grid,
  Typography,
} from "@mui/material";
import PropTypes from "prop-types";
import { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";

import { ResponsiveDrawer } from "../../../components/ResponsiveDrawer";
import { useTodoItemState } from "../../../hooks/ToDo/useTodoItemState";
import { getSsvcPriorityProps } from "../../../utils/ssvcUtils";
import { preserveParams } from "../../../utils/urlUtils";
import { TicketDetailView } from "../TicketDetailView";

export function VulnerabilityCard({ ticket }) {
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const navigate = useNavigate();
  const location = useLocation();

  const {
    pteam,
    pteamIsLoading,
    service,
    serviceIsLoading,
    vuln,
    vulnIsLoading,
    serviceDependency,
    serviceDependencyIsLoading,
    displayAssignee,
  } = useTodoItemState(ticket);

  const handleCardClick = () => {
    if (!serviceDependency?.package_id) {
      console.warn("Package ID is not available.");
      return;
    }
    const params = preserveParams(location.search);
    params.set("pteamId", ticket.pteam_id);
    params.set("serviceId", ticket.service_id);
    navigate(`/packages/${serviceDependency.package_id}?` + params.toString());
  };

  const detailItems = [
    {
      label: "Team",
      value: pteamIsLoading ? "..." : pteam?.pteam_name || "-",
      icon: <GroupOutlinedIcon fontSize="small" />,
    },
    {
      label: "Package",
      value: serviceDependencyIsLoading ? "..." : serviceDependency?.package_name || "-",
      icon: <Inventory2OutlinedIcon fontSize="small" />,
    },
    {
      label: "Assignee",
      value: displayAssignee,
      icon: <PersonOutlineIcon fontSize="small" />,
    },
    {
      label: "Service",
      value: serviceIsLoading ? "..." : service?.service_name || "-",
      icon: <DnsOutlinedIcon fontSize="small" />,
    },
  ];

  const ssvcPriority =
    getSsvcPriorityProps()[ticket.ssvc_deployer_priority.toLowerCase()] ||
    getSsvcPriorityProps()["defer"];

  const cardSx = {
    borderRadius: 5,
    border: "2px solid rgba(0, 0, 0, 0.15)",
    boxShadow: "0 8px 32px rgba(0,0,0,0.1)",
    cursor: "pointer",
    transition: "transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out",
    "&:active:not(:has(button:active))": {
      transform: "scale(0.98) translateY(2px)",
      boxShadow: "0 4px 16px rgba(0,0,0,0.12)",
    },
  };

  const buttonSx = {
    borderRadius: "12px",
    textTransform: "none",
    fontWeight: 600,
    py: 1,
  };

  return (
    <>
      <Card sx={cardSx} onClick={handleCardClick}>
        <CardContent sx={{ pt: 3, px: 3 }}>
          <Box
            sx={{
              display: "flex",
              flexDirection: { xs: "column", sm: "row" },
              alignItems: { xs: "flex-start", sm: "center" },
              justifyContent: "space-between",
              gap: { xs: 1, sm: 2 },
              mb: 2,
            }}
          >
            <Typography variant="h6" component="div" fontWeight={600} color="text.primary">
              {vulnIsLoading ? "..." : vuln?.cve_id || "No Known CVE"}
            </Typography>
            <Chip
              label={ticket.ssvc_deployer_priority}
              size="small"
              sx={{
                fontWeight: 600,
                color: "#fff",
                backgroundColor: ssvcPriority.style.bgcolor,
              }}
            />
          </Box>
          <Divider sx={{ my: 2, borderColor: "rgba(0, 0, 0, 0.1)" }} />
          <Grid container rowSpacing={2.5} columnSpacing={2}>
            {detailItems.map((item) => (
              <Grid size={{ xs: 12, sm: 6 }} key={item.label}>
                <Typography variant="caption" color="text.secondary">
                  {item.label}
                </Typography>
                <Box
                  sx={{
                    display: "flex",
                    alignItems: "center",
                    gap: 1,
                    mt: 0.5,
                    color: "text.secondary",
                  }}
                >
                  {item.icon}
                  <Typography
                    variant="body2"
                    color="text.primary"
                    sx={{
                      overflowWrap: "break-word",
                      minWidth: 0,
                    }}
                  >
                    {item.value}
                  </Typography>
                </Box>
              </Grid>
            ))}
          </Grid>
        </CardContent>
        <CardActions sx={{ p: 2, justifyContent: "flex-end" }}>
          <Button
            size="medium"
            variant="contained"
            endIcon={<ChevronRightIcon />}
            sx={buttonSx}
            onClick={(e) => {
              e.stopPropagation();
              setIsDrawerOpen(true);
            }}
          >
            Details
          </Button>
        </CardActions>
      </Card>

      <ResponsiveDrawer
        open={isDrawerOpen}
        onClose={() => setIsDrawerOpen(false)}
        title={`Ticket #${ticket.ticket_id || ""}`}
      >
        <TicketDetailView ticket={ticket} />
      </ResponsiveDrawer>
    </>
  );
}

VulnerabilityCard.propTypes = {
  ticket: PropTypes.object.isRequired,
};
