import {
  Box,
  Card,
  Chip,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Typography,
} from "@mui/material";
import PropTypes from "prop-types";

import { ActionTypeIcon } from "../../components/ActionTypeIcon.jsx";
import { PackageView } from "../../components/PackageView.jsx";
import { createUpdateAction, findMatchedVulnPackage } from "../../utils/vulnUtils.js";

export function VulnerabilityView(props) {
  const { vuln, currentPackage } = props;
  // Get the matched vulnerable package from vulnerable_packages and currentPackage
  const matchedVulnPackage = findMatchedVulnPackage(vuln.vulnerable_packages, currentPackage);
  if (!matchedVulnPackage) throw new Error("No matching package found for the vulnerability.");

  const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
  const patchedVersions = matchedVulnPackage?.fixed_versions ?? [];
  const updateAction = createUpdateAction(
    affectedVersions,
    patchedVersions,
    matchedVulnPackage?.affected_name ?? "",
  );

  return (
    <>
      {/* Package */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Package
        </Typography>
        <PackageView vulnPackage={matchedVulnPackage} />
      </Box>
      {/* Update */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Update
        </Typography>
        <Card variant="outlined" sx={{ m: 1, p: 2 }}>
          <List>
            {updateAction === null ? (
              <ListItem>
                <ListItemText primary={"No data"} />
              </ListItem>
            ) : (
              <ListItem>
                <ListItemIcon>
                  <ActionTypeIcon />
                </ListItemIcon>
                <ListItemText primary={updateAction} />
              </ListItem>
            )}
          </List>
        </Card>
      </Box>
      {/* Vuln cve id */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          CVE ID
        </Typography>
        {vuln.cve_id === null ? (
          <Typography sx={{ margin: 1 }}>No Known CVE</Typography>
        ) : (
          <Box>{vuln.cve_id && <Chip label={vuln.cve_id} sx={{ m: 1 }} />}</Box>
        )}
      </Box>
      {/* Vuln Detail */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Detail
        </Typography>
        <Card variant="outlined" sx={{ m: 1, p: 2 }}>
          <Typography variant="body1">{vuln.detail}</Typography>
        </Card>
      </Box>
    </>
  );
}
VulnerabilityView.propTypes = {
  vuln: PropTypes.object.isRequired,
  currentPackage: PropTypes.object.isRequired,
};
