// VulnerabilityTodoList.jsx

import SearchIcon from "@mui/icons-material/Search";
import {
  Box,
  FormControl,
  InputAdornment,
  InputLabel,
  MenuItem,
  Pagination,
  Select,
  Stack,
  Switch,
  TextField,
  Typography,
} from "@mui/material";
import { useMemo, useState } from "react";

import { Android12Switch } from "../../../components/Android12Switch";

import { SortController } from "./SortController";
import { VulnerabilityCard } from "./VulnerabilityCard";

const originalMockTasks = [
  { cve: "CVE-2025-43859", team: "Metemcyber Dev Team Tokyo (Legacy System)", ssvc: "SCHEDULED" },
  { cve: "CVE-2025-12345", team: "Frontend Team", ssvc: "IMMEDIATE" },
  { cve: "CVE-2024-98765", team: "Backend Team", ssvc: "OUT_OF_CYCLE" },
];
const mockTasks = Array.from({ length: 50 }, (_, i) => ({
  ...originalMockTasks[i % 3],
  cve: `CVE-2025-${String(10000 + i).padStart(5, "0")}`,
  package: `package-name-example-${i}`,
  service: `service-instance-${i}`,
  assignee: `user${(i % 5) + 1}@demo.test`,
}));

export default function VulnerabilityTodoList() {
  const [tasks] = useState(mockTasks);
  const [sortConfig, setSortConfig] = useState({ key: "cve", direction: "ascending" });
  const [useCustomDesign, setUseCustomDesign] = useState(true);

  const [page, setPage] = useState(1);
  const [itemsPerPage, setItemsPerPage] = useState(10);

  const handlePageChange = (event, newPage) => {
    setPage(newPage);
  };

  const handleItemsPerPageChange = (event) => {
    setItemsPerPage(parseInt(event.target.value, 10));
    setPage(1);
  };

  const sortedTasks = useMemo(() => {
    const sortableItems = [...tasks];
    sortableItems.sort((a, b) => {
      const comparison = String(a[sortConfig.key]).localeCompare(String(b[sortConfig.key]));
      return sortConfig.direction === "ascending" ? comparison : -comparison;
    });
    return sortableItems;
  }, [tasks, sortConfig]);

  const pageCount = Math.ceil(sortedTasks.length / itemsPerPage);

  const paginatedTasks = useMemo(() => {
    const startIndex = (page - 1) * itemsPerPage;
    return sortedTasks.slice(startIndex, startIndex + itemsPerPage);
  }, [sortedTasks, page, itemsPerPage]);

  return (
    <Box sx={{ p: { xs: 2, sm: 3 } }}>
      <Stack
        direction="row"
        spacing={1}
        alignItems="center"
        sx={{ mb: 2, justifyContent: "flex-end" }}
      >
        <Typography>MUI Default</Typography>
        <Switch checked={useCustomDesign} onChange={(e) => setUseCustomDesign(e.target.checked)} />
        <Typography>Custom Design</Typography>
      </Stack>

      <Box sx={{ mb: 3 }}>
        <TextField
          fullWidth
          variant="outlined"
          placeholder="Search CVE ID"
          size="small"
          InputProps={{
            startAdornment: (
              <InputAdornment position="start">
                <SearchIcon />
              </InputAdornment>
            ),
            sx: {
              borderRadius: "12px",
              backgroundColor: "background.paper",
              "& fieldset": {
                borderColor: "rgba(0, 0, 0, 0.2)",
              },
            },
          }}
        />
      </Box>

      <Box sx={{ display: "flex", justifyContent: "space-between", mb: 2 }}>
        <Box sx={{ display: "flex", alignItems: "center" }}>
          <Android12Switch />
          <Typography>My tasks</Typography>
        </Box>
        <SortController sortConfig={sortConfig} onSortConfigChange={setSortConfig} />
      </Box>

      {/* ▼ 変更: 上部のページネーションに表示件数選択を追加 */}
      <Box
        sx={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          mb: 3,
          gap: 4,
          flexWrap: "wrap",
        }}
      >
        <Pagination count={pageCount} page={page} onChange={handlePageChange} color="primary" />
        <FormControl sx={{ m: 1, minWidth: 120 }} size="small">
          <InputLabel id="items-per-page-label-top">Rows per page</InputLabel>
          <Select
            labelId="items-per-page-label-top"
            id="items-per-page-select-top"
            value={itemsPerPage}
            label="Rows per page"
            onChange={handleItemsPerPageChange}
          >
            <MenuItem value={10}>10</MenuItem>
            <MenuItem value={25}>25</MenuItem>
            <MenuItem value={50}>50</MenuItem>
          </Select>
        </FormControl>
      </Box>

      <Stack spacing={3}>
        {paginatedTasks.map((task) => (
          <VulnerabilityCard
            key={task.cve}
            task={task}
            design={useCustomDesign ? "custom" : "default"}
          />
        ))}
      </Stack>

      <Box
        sx={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          mt: 4,
          gap: 4,
          flexWrap: "wrap",
        }}
      >
        <Pagination count={pageCount} page={page} onChange={handlePageChange} color="primary" />
        <FormControl sx={{ m: 1, minWidth: 120 }} size="small">
          <InputLabel id="items-per-page-label-bottom">Rows per page</InputLabel>
          <Select
            labelId="items-per-page-label-bottom"
            id="items-per-page-select-bottom"
            value={itemsPerPage}
            label="Rows per page"
            onChange={handleItemsPerPageChange}
          >
            <MenuItem value={10}>10</MenuItem>
            <MenuItem value={25}>25</MenuItem>
            <MenuItem value={50}>50</MenuItem>
          </Select>
        </FormControl>
      </Box>
    </Box>
  );
}
