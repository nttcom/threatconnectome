import ChevronRightIcon from "@mui/icons-material/ChevronRight";
import DnsOutlinedIcon from "@mui/icons-material/DnsOutlined";
import GroupOutlinedIcon from "@mui/icons-material/GroupOutlined";
import Inventory2OutlinedIcon from "@mui/icons-material/Inventory2Outlined";
import PersonOutlineIcon from "@mui/icons-material/PersonOutline";
import {
  Box,
  Button,
  Card,
  CardActions,
  CardContent,
  Chip,
  Divider,
  Grid,
  Typography,
} from "@mui/material";
import PropTypes from "prop-types";
import { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";

import { ResponsiveDrawer } from "../../../components/ResponsiveDrawer";
import { useGetDependencyQuery } from "../../../services/tcApi";
import { ssvcPriorityProps } from "../../../utils/const";
import { preserveParams } from "../../../utils/urlUtils";
import { TicketDetailView } from "../TicketDetailView";

export function VulnerabilityCard({ task }) {
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const navigate = useNavigate();
  const location = useLocation();

  const { data: serviceDependency, isLoading: serviceDependencyIsLoading } = useGetDependencyQuery(
    { pteamId: task.pteam_id, dependencyId: task.dependency_id },
    { skip: !task.pteam_id || !task.dependency_id },
  );

  const handleCardClick = () => {
    if (!serviceDependency?.package_id) {
      console.warn("Package ID is not available.");
      return;
    }
    const params = preserveParams(location.search);
    params.set("pteamId", task.pteam_id);
    params.set("serviceId", task.service_id);
    navigate(`/packages/${serviceDependency.package_id}?` + params.toString());
  };

  const displayAssignee =
    task.assignee && task.assignee.length > 0 ? task.assignee[0] : "Unassigned";

  const detailItems = [
    { label: "Team", value: task.team, icon: <GroupOutlinedIcon fontSize="small" /> },
    {
      label: "Package",
      value: serviceDependency?.package_name || task.package,
      icon: <Inventory2OutlinedIcon fontSize="small" />,
    },
    { label: "Assignee", value: displayAssignee, icon: <PersonOutlineIcon fontSize="small" /> },
    { label: "Service", value: task.service, icon: <DnsOutlinedIcon fontSize="small" /> },
  ];

  const ssvcPriority = ssvcPriorityProps[task.ssvc.toLowerCase()] || ssvcPriorityProps["defer"];

  const cardSx = {
    borderRadius: 5,
    border: "2px solid rgba(0, 0, 0, 0.15)",
    boxShadow: "0 8px 32px rgba(0,0,0,0.1)",
    cursor: "pointer",
    transition: "transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out",
    "&:active:not(:has(button:active))": {
      transform: "scale(0.98) translateY(2px)",
      boxShadow: "0 4px 16px rgba(0,0,0,0.12)",
    },
  };

  const buttonSx = {
    borderRadius: "12px",
    textTransform: "none",
    fontWeight: 600,
    py: 1,
  };

  return (
    <>
      <Card sx={cardSx} onClick={handleCardClick}>
        <CardContent sx={{ pt: 3, px: 3 }}>
          <Box
            sx={{
              display: "flex",
              flexDirection: { xs: "column", sm: "row" },
              alignItems: { xs: "flex-start", sm: "center" },
              justifyContent: "space-between",
              gap: { xs: 1, sm: 2 },
              mb: 2,
            }}
          >
            <Typography variant="h6" component="div" fontWeight={600} color="text.primary">
              {task.cve}
            </Typography>
            <Chip
              label={task.ssvc}
              size="small"
              sx={{
                fontWeight: 600,
                color: "#fff",
                backgroundColor: ssvcPriority.style.bgcolor,
              }}
            />
          </Box>
          <Divider sx={{ my: 2, borderColor: "rgba(0, 0, 0, 0.1)" }} />
          <Grid container rowSpacing={2.5} columnSpacing={2}>
            {detailItems.map((item) => (
              <Grid item xs={12} sm={6} key={item.label}>
                <Typography variant="caption" color="text.secondary">
                  {item.label}
                </Typography>
                <Box
                  sx={{
                    display: "flex",
                    alignItems: "center",
                    gap: 1,
                    mt: 0.5,
                    color: "text.secondary",
                  }}
                >
                  {item.icon}
                  <Typography
                    variant="body2"
                    color="text.primary"
                    sx={{
                      overflowWrap: "break-word",
                      minWidth: 0,
                    }}
                  >
                    {serviceDependencyIsLoading && item.label === "Package" ? "..." : item.value}
                  </Typography>
                </Box>
              </Grid>
            ))}
          </Grid>
        </CardContent>
        <CardActions sx={{ p: 2, justifyContent: "flex-end" }}>
          <Button
            size="medium"
            variant="contained"
            endIcon={<ChevronRightIcon />}
            sx={buttonSx}
            onClick={(e) => {
              e.stopPropagation(); // ▼ 追加: 親(Card)のonClickが発火しないようにする
              setIsDrawerOpen(true);
            }}
          >
            Details
          </Button>
        </CardActions>
      </Card>

      <ResponsiveDrawer
        open={isDrawerOpen}
        onClose={() => setIsDrawerOpen(false)}
        title={`Ticket #${task.ticket_id?.slice(-5) || ""}`}
      >
        <TicketDetailView ticket={task} />
      </ResponsiveDrawer>
    </>
  );
}

VulnerabilityCard.propTypes = {
  task: PropTypes.object.isRequired,
};
