import { useLocation } from "react-router-dom";

import { useSkipUntilAuthUserIsReady } from "../../hooks/auth";
import {
  useGetDependenciesQuery,
  useGetPTeamQuery,
  useGetVulnQuery,
  useGetVulnActionsQuery,
} from "../../services/tcApi";
import { APIError } from "../../utils/APIError";
import { rootPrefix } from "../../utils/const";
import { errorToString } from "../../utils/func";

import { VulnerabilityPageView } from "./VulnerabilityPageView";

export function Vulnerability() {
  const location = useLocation();
  const params = new URLSearchParams(location.search);
  const pteamId = params.get("pteamId");
  const serviceId = params.get("serviceId");
  const packageId = params.get("packageId");
  const vulnId = params.get("vulnId");

  const skip = useSkipUntilAuthUserIsReady();
  const getDependenciesReady = !skip && pteamId && serviceId;

  const offset = 0;
  const limit = 10000;
  const {
    data: serviceDependencies,
    error: serviceDependenciesError,
    isLoading: serviceDependenciesIsLoading,
  } = useGetDependenciesQuery(
    { pteamId, serviceId, offset, limit },
    { skip: !getDependenciesReady },
  );

  const {
    data: pteam,
    error: pteamError,
    isLoading: pteamIsLoading,
  } = useGetPTeamQuery(pteamId, { skip });
  const {
    data: vuln,
    error: vulnError,
    isLoading: vulnIsLoading,
  } = useGetVulnQuery(vulnId, { skip });
  const {
    data: vulnActions,
    error: vulnActionsError,
    isLoading: vulnActionsIsLoading,
  } = useGetVulnActionsQuery(vulnId, { skip });

  if (skip) return <></>;
  if (serviceDependenciesError)
    throw new APIError(errorToString(serviceDependenciesError), { api: "getDependencies" });
  if (pteamError) throw new APIError(errorToString(pteamError), { api: "getPTeam" });
  if (vulnError) throw new APIError(errorToString(vulnError), { api: "getVuln" });
  if (vulnActionsError)
    throw new APIError(errorToString(vulnActionsError), { api: "getVulnActions" });
  if (serviceDependenciesIsLoading) return <>Now loading Service Dependencies...</>;
  if (pteamIsLoading) return <>Now loading PTeam...</>;
  if (vulnIsLoading) return <>Now loading Vuln...</>;
  if (vulnActionsIsLoading) return <>Now loading VulnActions...</>;

  const service = pteam.services.find((service) => service.service_id === serviceId);
  if (!service) throw new Error("No such service.");

  const pteamServiceParams = new URLSearchParams();
  pteamServiceParams.set("pteamId", pteamId);
  pteamServiceParams.set("serviceId", serviceId);

  const hrefToServicePage = `${rootPrefix}/?` + pteamServiceParams.toString();
  const hrefToPackagePage = `${rootPrefix}/packages/${packageId}?` + pteamServiceParams.toString();

  const serviceDict = pteam.services.find((service) => service.service_id === serviceId);

  const currentPackageDependencies = (serviceDependencies ?? []).filter(
    (dependency) => dependency.package_id === packageId,
  );
  const references = currentPackageDependencies.map((dependency) => ({
    dependencyId: dependency.dependency_id,
    target: dependency.target,
    version: dependency.package_version,
    service: serviceDict.service_name,
    package_name: dependency.package_name,
    package_source_name: dependency.package_source_name,
    ecosystem: dependency.package_ecosystem,
  }));

  return (
    <VulnerabilityPageView
      vuln={vuln}
      vulnActions={vulnActions}
      service={service}
      hrefToServicePage={hrefToServicePage}
      hrefToPackagePage={hrefToPackagePage}
      references={references}
    />
  );
}
