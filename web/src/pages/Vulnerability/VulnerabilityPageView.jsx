import NavigateNextIcon from "@mui/icons-material/NavigateNext";
import { Box, Breadcrumbs, Link, Stack, Typography } from "@mui/material";
import PropTypes from "prop-types";
import { useNavigate } from "react-router-dom";

import { findMatchedVulnPackage } from "../../utils/vulnUtils.js";

import { VulnerabilityView } from "./VulnerabilityView";

export function VulnerabilityPageView(props) {
  const { vuln, vulnActions, service, hrefToServicePage, hrefToPackagePage, currentPackage } =
    props;

  window.scrollTo({ top: 0, behavior: "instant" });

  const navigate = useNavigate();

  // Get the matched vulnerable package from vulnerable_packages and currentPackage
  const matchedVulnPackage = findMatchedVulnPackage(vuln.vulnerable_packages, currentPackage);
  if (!matchedVulnPackage) throw new Error("No matching package found for the vulnerability.");

  return (
    <>
      <Breadcrumbs separator={<NavigateNextIcon fontSize="small" />} aria-label="breadcrumb">
        <Link
          onClick={() => navigate(hrefToServicePage)}
          sx={{ color: "text.primary", cursor: "pointer" }}
        >
          {service.service_name}
        </Link>
        <Link
          onClick={() => navigate(hrefToPackagePage)}
          sx={{ color: "text.primary", cursor: "pointer" }}
        >
          {`${matchedVulnPackage.affected_name}:${matchedVulnPackage.ecosystem}`}
        </Link>
        <Typography sx={{ color: "text.primary" }}>{vuln.title}</Typography>
      </Breadcrumbs>
      <Typography variant="h4" sx={{ fontWeight: "bold", py: 2 }}>
        {vuln.title}
      </Typography>
      <Box>
        <Stack spacing={2} sx={{ mb: 3 }}>
          <VulnerabilityView
            vuln={vuln}
            vulnActions={vulnActions}
            currentPackage={currentPackage}
          />
        </Stack>
      </Box>
    </>
  );
}
VulnerabilityPageView.propTypes = {
  vuln: PropTypes.object.isRequired,
  vulnActions: PropTypes.array.isRequired,
  service: PropTypes.object.isRequired,
  hrefToServicePage: PropTypes.string.isRequired,
  hrefToPackagePage: PropTypes.string.isRequired,
  currentPackage: PropTypes.object.isRequired,
};
