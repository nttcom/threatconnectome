import {
  Box,
  Card,
  Chip,
  List,
  ListItem,
  ListItemIcon,
  ListItemText,
  Typography,
} from "@mui/material";
import PropTypes from "prop-types";
import { createActionText } from "../../utils/vulnUtils.js";

import { ActionTypeIcon } from "../../components/ActionTypeIcon";
import { PackageView } from "../../components/PackageView";

export function VulnerabilityView(props) {
  const { packageId, vuln, vulnActions, matchedVulnPackage } = props;
  // vulnerable_package: package obtained by packageId
  const vulnerable_package = vuln.vulnerable_packages.find((pkg) => pkg.package_id === packageId);
  if (!vulnerable_package) throw new Error("No packageId for the vuln.");
  const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
  const patchedVersions = vulnerable_package?.fixed_versions ?? [];
  const actionText = createActionText(
    affectedVersions.join(),
    patchedVersions.join(),
    vulnerable_package?.name ?? "",
  );
  const actions = [actionText, ...vulnActions];

  return (
    <>
      {/* Package */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Package
        </Typography>
        <PackageView
          packageInfo={matchedVulnPackage}
          affect={{ affected_versions: affectedVersions }}
        />
      </Box>
      {/* Mitigations -- show actions currently */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Mitigations
        </Typography>
        <Card variant="outlined" sx={{ m: 1, p: 2 }}>
          <List>
            {vulnActions.length === 0 ? (
              <ListItem>
                <ListItemText primary={"No data"} />
              </ListItem>
            ) : (
              vulnActions.map((action) => (
                <ListItem key={action.action_id}>
                  <ListItemIcon>
                    <ActionTypeIcon
                      actionType={action.action_type}
                      disabled={!action.recommended}
                    />
                  </ListItemIcon>
                  <ListItemText primary={action.action} />
                </ListItem>
              ))
            )}
          </List>
        </Card>
      </Box>
      {/* Vuln cve id */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          CVE ID
        </Typography>
        {vuln.cve_id && <Chip label={vuln.cve_id} sx={{ m: 1 }} />}
        {Array.isArray(vuln.cve_ids) && vuln.cve_ids.length > 0 && (
          <Box>
            {vuln.cve_ids.map((cveId) => (
              <Chip key={cveId.package_id} label={cveId.package_name} sx={{ m: 1 }} />
            ))}
          </Box>
        )}
      </Box>
      {/* Vuln Detail */}
      <Box>
        <Typography variant="h6" sx={{ fontWeight: "bold" }}>
          Detail
        </Typography>
        <Card variant="outlined" sx={{ m: 1, p: 2 }}>
          <Typography variant="body1">{vuln.detail}</Typography>
        </Card>
      </Box>
    </>
  );
}
VulnerabilityView.propTypes = {
  vuln: PropTypes.object.isRequired,
  vulnActions: PropTypes.array.isRequired,
  matchedVulnPackage: PropTypes.object.isRequired,
  service: PropTypes.object.isRequired,
};
