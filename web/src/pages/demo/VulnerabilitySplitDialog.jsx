import {
  InfoOutlined,
  VerifiedUserOutlined,
  WarningAmber,
  Settings,
  Article,
  ExpandMore,
  ArrowBackIosNew,
  ConfirmationNumberOutlined,
  Close,
  Fingerprint,
} from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  List,
  ListItemButton,
  Typography,
  Grid,
  Paper,
  TextField,
  MenuItem,
  Stack,
  ListItemText,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  ListItem,
  Chip,
  useTheme,
  useMediaQuery,
  IconButton,
  Slide,
} from "@mui/material";
import { useState } from "react";

const vulnerabilitiesData = [
  {
    id: "CVE-2024-12345",
    title: "package.json",
    status: "対応中",
    assignee: "山田太郎",
    deadline: "2025-11-01",
    ssvc: "Immediate", // 変更
    safetyImpact: "Critical",
    packageManager: "npm",
    target: "WebApp Server",
    affectedVersions: "1.0.0 - 1.2.0",
    fixedVersions: "1.2.1",
    mitigation: "パッケージをバージョン1.2.1にアップデートしてください。",
    description:
      "この脆弱性は、特定の条件下でリモートの攻撃者が任意のコードを実行できる可能性があるものです。影響を受けるシステムでは早急な対応が求められます。",
  },
  {
    id: "CVE-2024-54321",
    title: "requirements.txt",
    status: "未着手",
    assignee: "佐藤花子",
    deadline: "2025-12-15",
    ssvc: "Scheduled", // 変更
    safetyImpact: "High",
    packageManager: "pip",
    target: "Admin Panel",
    affectedVersions: "0.9.0 - 1.0.5",
    fixedVersions: "1.1.0",
    mitigation: "パッチの適用、またはWAFでのフィルタリングを推奨します。",
    description:
      "入力値のサニタイズが不十分なため、クロスサイトスクリプティングの攻撃に対して脆弱です。",
  },
  {
    id: "CVE-2024-55678",
    title: "pom.xml",
    status: "対応中",
    assignee: "鈴木次郎",
    deadline: "2025-10-20",
    ssvc: "Out-of-cycle", // 変更
    safetyImpact: "Critical",
    packageManager: "maven",
    target: "Database Server",
    affectedVersions: "2.0.0 - 2.1.3",
    fixedVersions: "2.1.4",
    mitigation: "パラメータ化クエリを利用し、最新バージョンにアップデートしてください。",
    description:
      "SQLインジェクションにより、攻撃者が任意のSQLコマンドを実行できる可能性があります。",
  },
  {
    id: "CVE-2024-56789",
    title: "Gemfile.lock",
    status: "未着手",
    assignee: "田中一郎",
    deadline: "2025-11-30",
    ssvc: "Defer", // 変更
    safetyImpact: "Moderate",
    packageManager: "gem",
    target: "API Gateway",
    affectedVersions: "3.0.0 - 3.2.1",
    fixedVersions: "3.2.2",
    mitigation: "最新パッチの適用を推奨します。",
    description: "大量のリクエストによりサービスが停止する可能性があります。",
  },
  {
    id: "CVE-2024-67890",
    title: "package.json",
    status: "対応中",
    assignee: "高橋美咲",
    deadline: "2025-10-31",
    ssvc: "Immediate", // 変更
    safetyImpact: "Critical",
    packageManager: "npm",
    target: "Authentication Service",
    affectedVersions: "4.5.0 - 4.7.2",
    fixedVersions: "4.7.3",
    mitigation: "パッチ適用後にサービスを再起動してください。",
    description: "攻撃者が不正に権限を昇格させる可能性があります。",
  },
  {
    id: "CVE-2024-78901",
    title: "requirements.txt",
    status: "完了",
    assignee: "佐々木健",
    deadline: "2025-09-15",
    ssvc: "Scheduled", // 変更
    safetyImpact: "High",
    packageManager: "pip",
    target: "User Data Service",
    affectedVersions: "1.3.0 - 1.4.5",
    fixedVersions: "1.4.6",
    mitigation: "暗号化通信の導入を推奨します。",
    description: "ユーザ情報が第三者に漏洩するリスクがあります。",
  },
  {
    id: "CVE-2024-89012",
    title: "package.json",
    status: "未着手",
    assignee: "中村葵",
    deadline: "2025-12-01",
    ssvc: "Defer", // 変更
    safetyImpact: "High",
    packageManager: "npm",
    target: "WebApp Client",
    affectedVersions: "0.8.0 - 1.0.0",
    fixedVersions: "1.0.1",
    mitigation: "CSRFトークンの実装を推奨します。",
    description: "不正なリクエストをユーザの意図に反して実行させる攻撃を防ぎます。",
  },
  {
    id: "CVE-2024-90123",
    title: "requirements.txt",
    status: "対応中",
    assignee: "松本大輔",
    deadline: "2025-11-15",
    ssvc: "Immediate", // 変更
    safetyImpact: "Critical",
    packageManager: "pip",
    target: "File Server",
    affectedVersions: "2.5.0 - 2.7.0",
    fixedVersions: "2.7.1",
    mitigation: "入力検証の強化を推奨します。",
    description: "不正なパス操作により任意のファイルにアクセスされる危険があります。",
  },
  {
    id: "CVE-2024-91234",
    title: "pom.xml",
    status: "完了",
    assignee: "小林真一",
    deadline: "2025-10-05",
    ssvc: "Out-of-cycle", // 変更
    safetyImpact: "Moderate",
    packageManager: "maven",
    target: "Authentication Service",
    affectedVersions: "3.1.0 - 3.3.5",
    fixedVersions: "3.3.6",
    mitigation: "ログイン試行の監視を推奨します。",
    description: "認証バイパスにより不正アクセスの可能性があります。",
  },
];

const statuses = ["未着手", "対応中", "完了"];
const assignees = ["山田太郎", "佐藤花子", "鈴木次郎"];
const safetyImpacts = ["Critical", "High", "Medium", "Low"];

// 固定表示用のカスタムコンポーネント
const FixedInfoItem = ({ label, value, icon }) => (
  <Box
    sx={{
      p: 1,
      height: "100%",
      display: "flex",
      flexDirection: "column",
      justifyContent: "center",
    }}
  >
    <Typography
      variant="caption"
      color="text.secondary"
      sx={{ display: "flex", alignItems: "center", gap: 0.5 }}
    >
      {icon}
      {label}
    </Typography>
    <Typography sx={{ fontWeight: 500, pl: 2.5 }}>{value}</Typography>
  </Box>
);

const getSsvcStyles = (ssvc) => {
  if (!ssvc) return { backgroundColor: "#bdbdbd", color: "black" }; // デフォルト（グレー）

  const lowerSsvc = ssvc.toLowerCase();

  switch (lowerSsvc) {
    case "immediate":
      return { backgroundColor: "#d32f2f", color: "white", fontWeight: "bold" }; // 赤
    case "out-of-cycle":
      return { backgroundColor: "#f57c00", color: "white", fontWeight: "bold" }; // オレンジ
    case "scheduled":
      return { backgroundColor: "#fbc02d", color: "black", fontWeight: "bold" }; // 黄色
    case "defer":
      return { backgroundColor: "#9e9e9e", color: "white", fontWeight: "bold" }; // 緑
    default:
      return { backgroundColor: "#bdbdbd", color: "black", fontWeight: "bold" }; // その他
  }
};

export default function VulnerabilitySplitDialog({ open, onClose }) {
  // --- ⬇ 2. 画面サイズ検知フックを追加 ⬇ ---
  const theme = useTheme();
  // 'md' (900px) より狭い画面をモバイルと判定
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  // --- ⬇ 3. 状態の初期値を変更 (未選択状態にする) ⬇ ---
  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [selectedStatus, setSelectedStatus] = useState(null);

  const groupedVulnerabilitiesData = vulnerabilitiesData.reduce((acc, vul) => {
    (acc[vul.status] = acc[vul.status] || []).push(vul);
    return acc;
  }, {});

  const selectedVulnerability =
    selectedStatus && groupedVulnerabilitiesData[selectedStatus] && selectedIndex >= 0
      ? groupedVulnerabilitiesData[selectedStatus][selectedIndex]
      : null;

  const handleListItemClick = (status, index) => {
    setSelectedStatus(status);
    setSelectedIndex(index);
  };

  const handleCloseDetailView = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  const handleExited = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  // --- 🎨 6. 左ペイン（一覧）のコンテンツ ---
  const ListPane = (
    <Box
      sx={{
        width: { xs: "100%", md: "40%" }, // レスポンシブ対応
        height: "100%",
        overflowY: "auto",
        borderRight: { xs: "none", md: "1px solid #ddd" },
        bgcolor: "grey.50",
      }}
    >
      {statuses.map((status) => (
        <Accordion
          key={status}
          square
          disableGutters
          elevation={0}
          sx={{ "&:before": { display: "none" } }}
          // selectedStatusがnullの場合も考慮し、デフォルトは「未着手」を開く
          defaultExpanded={status === "未着手"}
        >
          <AccordionSummary
            expandIcon={<ExpandMore />}
            sx={{
              bgcolor: "grey.200",
              borderBottom: "1px solid",
              borderColor: "grey.300",
            }}
          >
            <Typography component="span" sx={{ fontWeight: "bold" }}>
              {status} {`(${groupedVulnerabilitiesData[status]?.length || 0})`}
            </Typography>
          </AccordionSummary>
          <AccordionDetails sx={{ p: 0 }}>
            <List component="div" disablePadding>
              {groupedVulnerabilitiesData[status]?.length > 0 ? (
                groupedVulnerabilitiesData[status].map((vul, index) => {
                  return (
                    <ListItemButton
                      key={vul.id}
                      selected={status === selectedStatus && index === selectedIndex}
                      onClick={() => handleListItemClick(status, index)}
                      sx={{
                        pl: 4,
                        borderLeft: "4px solid transparent",
                        "&.Mui-selected": {
                          borderLeftColor: "primary.main",
                          backgroundColor: "blue.50",
                          "&:hover": {
                            backgroundColor: "blue.100",
                          },
                        },
                      }}
                    >
                      <ListItemText
                        primary={
                          <Typography component="span" noWrap>
                            {vul.title}
                          </Typography>
                        }
                        secondary={
                          <Chip
                            label={vul.ssvc}
                            size="small"
                            sx={{
                              ...getSsvcStyles(vul.ssvc),
                              borderRadius: "16px",
                              mt: 0.5,
                              height: "auto",
                              "& .MuiChip-label": {
                                paddingTop: "2px",
                                paddingBottom: "2px",
                              },
                            }}
                          />
                        }
                      />
                    </ListItemButton>
                  );
                })
              ) : (
                <ListItem sx={{ pl: 4 }}>
                  <ListItemText primary="No tasks" sx={{ color: "grey.500" }} />
                </ListItem>
              )}
            </List>
          </AccordionDetails>
        </Accordion>
      ))}
    </Box>
  );

  // --- 🎨 6. 右ペイン（詳細）のコンテンツ ---
  const DetailPane = selectedVulnerability ? (
    // 1. 全体を囲む親コンテナ: ブラーの基準点になります
    <Box
      sx={{
        position: "relative",
        width: { xs: "100%", md: "60%" },
        height: "100%",
        bgcolor: "grey.50",
        overflow: "hidden", // はみ出した部分を隠すため
      }}
    >
      {/* 2. 上側のブラー（常に表示） */}
      <Box
        sx={{
          position: "absolute",
          top: isMobile ? "47px" : 0,
          left: 0,
          right: 0,
          height: "50px",
          // 'grey.50' の色(rgba(248, 249, 250, 1))を直接指定
          background: `linear-gradient(to bottom, rgba(248, 249, 250, 1) 30%, transparent 100%)`,
          pointerEvents: "none", // マウス操作を透過させる
        }}
      />

      {/* 3. スクロールするコンテンツ本体 */}
      <Box
        sx={{
          height: "100%",
          overflowY: "auto", // このBoxがスクロールを担当
        }}
      >
        {/* --- ⬇ モバイル専用の「戻る」ヘッダー ⬇ --- */}
        {isMobile && (
          <Box
            sx={{
              p: 1,
              borderBottom: 1,
              borderColor: "divider",
              display: "flex",
              alignItems: "center",
              position: "sticky", // スクロールに追従
              top: 0,
              bgcolor: "grey.50",
              zIndex: 1,
            }}
          >
            <IconButton onClick={handleCloseDetailView} size="small" sx={{ mr: 1 }}>
              <ArrowBackIosNew fontSize="small" />
            </IconButton>
            <Typography variant="subtitle1" sx={{ fontWeight: 600 }} noWrap>
              {selectedVulnerability.title}
            </Typography>
          </Box>
        )}

        {/* 詳細カードのラッパー (paddingをここに移す) */}
        <Box sx={{ "& > .MuiPaper-root": { mb: 1 }, p: 1, mt: 3, mb: 3 }}>
          {/* カード1: 設定 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <Settings color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                設定
              </Typography>
            </Box>
            <Stack spacing={2} sx={{ p: 2 }}>
              <TextField label="担当者" select fullWidth value={selectedVulnerability.assignee}>
                {assignees.map((a) => (
                  <MenuItem key={a} value={a}>
                    {a}
                  </MenuItem>
                ))}
              </TextField>
              <Stack spacing={2}>
                {/* StatusとSafety Impactをグループ化する新しいStack */}
                <Stack direction={{ xs: "column", sm: "row" }} spacing={2}>
                  <TextField label="Status" select fullWidth value={selectedVulnerability.status}>
                    {statuses.map((s) => (
                      <MenuItem key={s} value={s}>
                        {s}
                      </MenuItem>
                    ))}
                  </TextField>

                  <TextField
                    label="Safety Impact"
                    select
                    fullWidth
                    value={selectedVulnerability.safetyImpact}
                  >
                    {safetyImpacts.map((si) => (
                      <MenuItem key={si} value={si}>
                        {si}
                      </MenuItem>
                    ))}
                  </TextField>
                </Stack>

                <div>
                  <Accordion variant="outlined" sx={{ borderColor: "divider" }}>
                    <AccordionSummary
                      expandIcon={<ExpandMore />} // MUI iconsからインポートが必要
                      aria-controls="safety-impact-reason-content"
                      id="safety-impact-reason-header"
                    >
                      <Typography variant="body2" sx={{ color: "text.secondary" }}>
                        Safety Impact 変更理由・履歴
                      </Typography>
                    </AccordionSummary>
                    <AccordionDetails>
                      {/* 変更理由のテキストや履歴リストをここに入れます */}
                      <Typography variant="body2">
                        ここに変更理由のテキストや、過去の変更履歴リストなどを表示します。
                      </Typography>
                      {/* (例: 履歴リスト) */}
                      <List dense>
                        <ListItem>
                          <ListItemText
                            primary="2023-10-28: 'High' -> 'Medium'"
                            secondary="理由: 脆弱性の詳細な調査により、影響範囲が限定的であることが判明したため。"
                          />
                        </ListItem>
                      </List>
                    </AccordionDetails>
                  </Accordion>
                </div>
              </Stack>
            </Stack>
          </Paper>

          {/* カード2: 固定表示の情報 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <Article color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                詳細情報
              </Typography>
            </Box>
            <Box p={2}>
              <Grid container spacing={2}>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="チケットID"
                    value="ticket-1" // (※props名は仮のものです)
                    icon={<ConfirmationNumberOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="完了期限"
                    value={selectedVulnerability.deadline}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="最終更新"
                    value="2025-10-21 09:35:12" // (ダミーデータ)
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="Target名"
                    value={selectedVulnerability.target}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="CVE ID"
                    value="CVE-2024-98765" // (※cveIdはselectedVulnerability内の正しいキー名に要変更)
                    icon={<Fingerprint fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="SSVC"
                    value={selectedVulnerability.ssvc}
                    icon={<WarningAmber fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="パッケージマネージャー"
                    value={selectedVulnerability.packageManager}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
              </Grid>
            </Box>
          </Paper>

          {/* カード3: 影響と対策 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <InfoOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                影響
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Typography variant="subtitle2" color="text.secondary">
                検出バージョン
              </Typography>
              <Typography sx={{ fontWeight: 500, mb: 1.5 }}>
                1.12.1 {/* (仮のprops名 - これは元コードのまま) */}
              </Typography>
              <Typography variant="subtitle2" color="text.secondary">
                影響バージョンと修正バージョン
              </Typography>
              <Typography
                sx={{ fontWeight: 500 }}
              >{`${selectedVulnerability.affectedVersions} → ${selectedVulnerability.fixedVersions}`}</Typography>
            </Box>
          </Paper>

          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <InfoOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                緩和策
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Typography sx={{ whiteSpace: "pre-line", fontWeight: 500 }}>
                {selectedVulnerability.mitigation}
              </Typography>
            </Box>
          </Paper>

          {/* カード4: 脆弱性詳細 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <VerifiedUserOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                脆弱性詳細
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Typography sx={{ whiteSpace: "pre-line" }}>
                {selectedVulnerability.description}
              </Typography>
            </Box>
          </Paper>
        </Box>
      </Box>

      {/* 4. 下側のブラー（常に表示） */}
      <Box
        sx={{
          position: "absolute",
          bottom: 0,
          left: 0,
          right: 0,
          height: "50px",
          background: `linear-gradient(to top, rgba(248, 249, 250, 1) 30%, transparent 100%)`,
          pointerEvents: "none",
        }}
      />
    </Box>
  ) : // --- PCで未選択時のプレースホルダー (この部分は変更なし) ---
  !isMobile ? (
    <Box
      sx={{
        width: "60%",
        height: "100%",
        display: "flex",
        alignItems: "center",
        justifyContent: "center",
        bgcolor: "grey.100",
      }}
    >
      <Typography color="text.secondary">タスクを選択してください</Typography>
    </Box>
  ) : null;

  return (
    <Dialog
      open={open}
      onClose={onClose}
      maxWidth="lg"
      fullWidth
      TransitionProps={{ onExited: handleExited }}
    >
      <DialogTitle
        sx={{
          fontWeight: 700,
          borderBottom: 1,
          borderColor: "divider",
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        CVE-2024-99999
        <IconButton
          aria-label="close"
          onClick={onClose}
          sx={{
            p: 0.5,
          }}
        >
          <Close />
        </IconButton>
      </DialogTitle>

      {/* === DialogContent (ここからがレイアウトの本体) === */}
      <DialogContent sx={{ bgcolor: "grey.50", p: 0 }}>
        <Box sx={{ height: "85vh", display: "flex", flexDirection: "column" }}>
          {/* ========================== */}
          {/* ⭐ 共通情報エリア (Accordionで折りたたみ) */}
          {/* ========================== */}
          <Box
            sx={{
              // p: 2, // Accordionが内部にpaddngを持つため、外側のpは削除または調整
              borderBottom: 1,
              borderColor: "divider",
              bgcolor: "background.paper",
              flexShrink: 0,
              overflowY: "auto", // アコーディオン展開時のために残す
              maxHeight: "40vh", // 展開時の最大高さ (調整可能)
            }}
          >
            {/* --- 常に表示する情報 (IDと最終更新) --- */}

            {/* --- 折りたたむ詳細情報 --- */}
            <div>
              <Accordion
                variant="outlined"
                elevation={0} // 影を消す
                sx={{
                  borderTop: 1, // 上のBoxとの境界線
                  borderColor: "divider",
                  "&:before": { display: "none" }, // Accordionデフォルトの上線を消す
                  m: 0, // マージンを消す
                }}
                square
                // defaultExpanded // デフォルトで開いておく場合
              >
                <AccordionSummary
                  expandIcon={<ExpandMore />}
                  aria-controls="vulnerability-details-content"
                  id="vulnerability-details-header"
                  sx={{
                    minHeight: "48px",
                    bgcolor: "grey.200",
                    "&.Mui-expanded": { minHeight: "48px" },
                  }}
                >
                  <Typography variant="body1" fontWeight="bold">
                    脆弱性の詳細とバージョン情報
                  </Typography>
                </AccordionSummary>
                <AccordionDetails sx={{ pt: 0 }}>
                  <Stack spacing={2} sx={{ mt: 1 }}>
                    {/* Summaryとの隙間を詰める */}
                    {/* --- 2段目: バージョン情報 --- */}
                    <Grid container spacing={2} sx={{ mb: 2 }}>
                      <Grid item xs={12} sm={6}>
                        <Typography variant="body2" fontWeight="bold" gutterBottom>
                          影響バージョン:
                        </Typography>
                        <Typography variant="body2" sx={{ pl: 1 }}>
                          1.0.0 から 1.2.3 まで
                        </Typography>
                      </Grid>
                      <Grid item xs={12} sm={6}>
                        <Typography variant="body2" fontWeight="bold" gutterBottom>
                          修正バージョン:
                        </Typography>
                        <Typography variant="body2" sx={{ pl: 1 }}>
                          1.2.4 以降
                        </Typography>
                      </Grid>
                    </Grid>
                    {/* --- 3段目: 脆弱性詳細 --- */}
                    <Box>
                      <Typography variant="body2" fontWeight="bold" gutterBottom>
                        脆弱性詳細:
                      </Typography>
                      <Typography variant="body2" sx={{ pl: 1 }}>
                        このコンポーネントにはXSS（クロスサイトスクリプティング）の脆弱性が存在し...
                      </Typography>
                    </Box>
                    {/* --- 4段目: 緩和策 --- */}
                    <Box>
                      <Typography variant="body2" fontWeight="bold" gutterBottom>
                        緩和策:
                      </Typography>
                      <Typography variant="body2" sx={{ pl: 1 }}>
                        修正バージョンへのアップグレードが不可能な場合...
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="body2" fontWeight="bold" gutterBottom>
                        最終更新:
                      </Typography>
                      <Typography variant="body2" sx={{ pl: 1 }}>
                        2025/10/29
                      </Typography>
                    </Box>
                  </Stack>
                </AccordionDetails>
              </Accordion>
            </div>
          </Box>

          {/* ========================== */}
          {/* 👇 可変エリア (リスト/詳細) */}
          {/* ========================== */}
          <Box sx={{ flexGrow: 1, overflow: "hidden" }}>
            {isMobile ? (
              // ==========================
              //  📱 モバイル表示
              // ==========================
              <Box sx={{ height: "100%", position: "relative" }}>
                {/* --- ステージ1: タスク一覧 --- */}
                <Box
                  sx={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    width: "100%",
                    height: "100%",
                  }}
                >
                  {ListPane}
                </Box>

                {/* --- ステージ2: タスク詳細 --- */}
                <Slide direction="left" in={!!selectedVulnerability} mountOnEnter unmountOnExit>
                  <Box
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      height: "100%",
                      // bgcolorはDetailPane側で指定
                    }}
                  >
                    {DetailPane}
                  </Box>
                </Slide>
              </Box>
            ) : (
              // ==========================
              //  🖥️ PC表示
              // ==========================
              <Box sx={{ display: "flex", height: "100%" }}>
                {ListPane}
                {DetailPane}
              </Box>
            )}
          </Box>
        </Box>
      </DialogContent>
    </Dialog>
  );
}
