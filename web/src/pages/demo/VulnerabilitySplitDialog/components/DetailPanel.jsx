import {
  ExpandMore,
  ArrowBackIosNew,
  ConfirmationNumberOutlined,
  InfoOutlined,
  WarningAmber,
  Fingerprint,
  Settings,
  Article,
  VerifiedUserOutlined,
} from "@mui/icons-material";
import {
  Box,
  Typography,
  Grid,
  Paper,
  TextField,
  MenuItem,
  Stack,
  IconButton,
  List,
  ListItem,
  ListItemText,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  ListItemIcon,
} from "@mui/material";
import PropTypes from "prop-types";

import { ActionTypeIcon } from "../../../../components/ActionTypeIcon";
import { statuses, assignees, safetyImpacts } from "../constants/vulnerabilityData";

import { FixedInfoItem } from "./FixedInfoItem";

/**
 * 右ペイン（詳細）のコンポーネント
 */
export const DetailPanel = ({
  selectedVulnerability,
  vulnData,
  actionsWithUiId,
  isMobile,
  onCloseDetailView,
}) => {
  if (!selectedVulnerability) {
    return !isMobile ? (
      <Box
        sx={{
          width: "60%",
          height: "100%",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          bgcolor: "grey.100",
        }}
      >
        <Typography color="text.secondary">タスクを選択してください</Typography>
      </Box>
    ) : null;
  }

  return (
    <Box
      sx={{
        position: "relative",
        width: { xs: "100%", md: "60%" },
        height: "100%",
        bgcolor: "grey.50",
        overflow: "hidden",
      }}
    >
      {/* 上側のブラー */}
      <Box
        sx={{
          position: "absolute",
          top: isMobile ? "47px" : 0,
          left: 0,
          right: 0,
          height: "50px",
          background: `linear-gradient(to bottom, rgba(248, 249, 250, 1) 30%, transparent 100%)`,
          pointerEvents: "none",
        }}
      />

      {/* スクロールするコンテンツ本体 */}
      <Box
        sx={{
          height: "100%",
          overflowY: "auto",
        }}
      >
        {/* モバイル専用の「戻る」ヘッダー */}
        {isMobile && (
          <Box
            sx={{
              p: 1,
              borderBottom: 1,
              borderColor: "divider",
              display: "flex",
              alignItems: "center",
              position: "sticky",
              top: 0,
              bgcolor: "grey.50",
              zIndex: 1,
            }}
          >
            <IconButton onClick={onCloseDetailView} size="small" sx={{ mr: 1 }}>
              <ArrowBackIosNew fontSize="small" />
            </IconButton>
            <Typography variant="subtitle1" sx={{ fontWeight: 600 }} noWrap>
              {selectedVulnerability.title}
            </Typography>
          </Box>
        )}

        {/* 詳細カードのラッパー */}
        <Box sx={{ "& > .MuiPaper-root": { mb: 1 }, p: 1, mt: 3, mb: 3 }}>
          {/* カード1: 設定 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <Settings color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                設定
              </Typography>
            </Box>
            <Stack spacing={2} sx={{ p: 2 }}>
              <TextField label="担当者" select fullWidth value={selectedVulnerability.assignee}>
                {assignees.map((a) => (
                  <MenuItem key={a} value={a}>
                    {a}
                  </MenuItem>
                ))}
              </TextField>
              <Stack spacing={2}>
                <Stack direction={{ xs: "column", sm: "row" }} spacing={2}>
                  <TextField label="Status" select fullWidth value={selectedVulnerability.status}>
                    {statuses.map((s) => (
                      <MenuItem key={s} value={s}>
                        {s}
                      </MenuItem>
                    ))}
                  </TextField>

                  <TextField
                    label="Safety Impact"
                    select
                    fullWidth
                    value={selectedVulnerability.safetyImpact}
                  >
                    {safetyImpacts.map((si) => (
                      <MenuItem key={si} value={si}>
                        {si}
                      </MenuItem>
                    ))}
                  </TextField>
                </Stack>

                <div>
                  <Accordion variant="outlined" sx={{ borderColor: "divider" }}>
                    <AccordionSummary
                      expandIcon={<ExpandMore />}
                      aria-controls="safety-impact-reason-content"
                      id="safety-impact-reason-header"
                    >
                      <Typography variant="body2" sx={{ color: "text.secondary" }}>
                        Safety Impact 変更理由・履歴
                      </Typography>
                    </AccordionSummary>
                    <AccordionDetails>
                      <Typography variant="body2">
                        ここに変更理由のテキストや、過去の変更履歴リストなどを表示します。
                      </Typography>
                      <List dense>
                        <ListItem>
                          <ListItemText
                            primary="2023-10-28: 'High' -> 'Medium'"
                            secondary="理由: 脆弱性の詳細な調査により、影響範囲が限定的であることが判明したため。"
                          />
                        </ListItem>
                      </List>
                    </AccordionDetails>
                  </Accordion>
                </div>
              </Stack>
            </Stack>
          </Paper>

          {/* カード2: 固定表示の情報 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <Article color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                詳細情報
              </Typography>
            </Box>
            <Box p={2}>
              <Grid container spacing={2}>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="チケットID"
                    value="ticket-1"
                    icon={<ConfirmationNumberOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="完了期限"
                    value={selectedVulnerability.deadline}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="最終更新"
                    value="2025-10-21 09:35:12"
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="Target名"
                    value={selectedVulnerability.target}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="CVE ID"
                    value={vulnData?.cve_id || "-"}
                    icon={<Fingerprint fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="SSVC"
                    value={selectedVulnerability.ssvc}
                    icon={<WarningAmber fontSize="small" />}
                  />
                </Grid>
                <Grid size={{ xs: 12, sm: 6 }}>
                  <FixedInfoItem
                    label="パッケージマネージャー"
                    value={selectedVulnerability.packageManager}
                    icon={<InfoOutlined fontSize="small" />}
                  />
                </Grid>
              </Grid>
            </Box>
          </Paper>

          {/* カード3: 影響と対策 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <InfoOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                影響
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Typography variant="subtitle2" color="text.secondary">
                影響バージョン
              </Typography>
              <Typography sx={{ fontWeight: 500, mb: 1.5 }}>
                {vulnData?.vulnerable_packages?.[0]?.affected_versions?.join(", ") || "-"}
              </Typography>
              <Typography variant="subtitle2" color="text.secondary">
                修正バージョン
              </Typography>
              <Typography sx={{ fontWeight: 500 }}>
                {vulnData?.vulnerable_packages?.[0]?.fixed_versions?.join(", ") || "-"}
              </Typography>
            </Box>
          </Paper>

          {/* カード4: 緩和策 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <VerifiedUserOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                緩和策
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <List>
                {actionsWithUiId.length === 0 ? (
                  <ListItem>
                    <ListItemText primary={"緩和策情報がありません"} />
                  </ListItem>
                ) : (
                  actionsWithUiId.map((action) => (
                    <ListItem key={action.uiId}>
                      <ListItemIcon>
                        <ActionTypeIcon
                          actionType={action.action_type}
                          disabled={!action.recommended}
                        />
                      </ListItemIcon>
                      <ListItemText primary={action.action} />
                    </ListItem>
                  ))
                )}
              </List>
            </Box>
          </Paper>

          {/* カード5: 脆弱性詳細 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <InfoOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                脆弱性詳細
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Typography sx={{ whiteSpace: "pre-line" }}>{vulnData?.detail || "-"}</Typography>
            </Box>
          </Paper>

          {/* カード6: CVSS情報 */}
          <Paper variant="outlined">
            <Box
              sx={{
                p: 2,
                display: "flex",
                alignItems: "center",
                gap: 1,
                borderBottom: 1,
                borderColor: "divider",
              }}
            >
              <InfoOutlined color="action" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                CVSS情報
              </Typography>
            </Box>
            <Box sx={{ p: 2 }}>
              <Stack spacing={1}>
                <Box>
                  <Typography variant="subtitle2" color="text.secondary">
                    CVSS v3 Score
                  </Typography>
                  <Typography sx={{ fontWeight: 500 }}>{vulnData?.cvss_v3_score || "-"}</Typography>
                </Box>
                <Box>
                  <Typography variant="subtitle2" color="text.secondary">
                    Exploitation
                  </Typography>
                  <Typography sx={{ fontWeight: 500 }}>{vulnData?.exploitation || "-"}</Typography>
                </Box>
                <Box>
                  <Typography variant="subtitle2" color="text.secondary">
                    Automatable
                  </Typography>
                  <Typography sx={{ fontWeight: 500 }}>{vulnData?.automatable || "-"}</Typography>
                </Box>
              </Stack>
            </Box>
          </Paper>
        </Box>
      </Box>

      {/* 下側のブラー */}
      <Box
        sx={{
          position: "absolute",
          bottom: 0,
          left: 0,
          right: 0,
          height: "50px",
          background: `linear-gradient(to top, rgba(248, 249, 250, 1) 30%, transparent 100%)`,
          pointerEvents: "none",
        }}
      />
    </Box>
  );
};

DetailPanel.propTypes = {
  selectedVulnerability: PropTypes.object,
  vulnData: PropTypes.object,
  actionsWithUiId: PropTypes.array.isRequired,
  isMobile: PropTypes.bool.isRequired,
  onCloseDetailView: PropTypes.func.isRequired,
};
