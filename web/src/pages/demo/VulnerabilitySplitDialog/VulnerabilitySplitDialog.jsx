import { Close } from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  Slide,
} from "@mui/material";
import PropTypes from "prop-types";
import { useState, useMemo } from "react";

import { createActionByFixedVersions } from "../../../utils/vulnUtils";

import { CommonInfoAccordion } from "./components/CommonInfoAccordion";
import { DetailPanel } from "./components/DetailPanel";
import { ListPanel } from "./components/ListPanel";
import { vulnerabilitiesData, statuses } from "./constants/vulnerabilityData";

export default function VulnerabilitySplitDialog({ open, onClose, vulnData, vulnActions = [] }) {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [selectedStatus, setSelectedStatus] = useState(null);

  // 緩和策を生成
  const actionsWithUiId = useMemo(() => {
    if (!vulnData?.vulnerable_packages?.[0]) return [];

    const matchedVulnPackage = vulnData.vulnerable_packages[0];
    const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
    const patchedVersions = matchedVulnPackage?.fixed_versions ?? [];
    const actionByFixedVersions = createActionByFixedVersions(
      affectedVersions,
      patchedVersions,
      matchedVulnPackage?.affected_name ?? "",
    );

    const actions = actionByFixedVersions ? [actionByFixedVersions, ...vulnActions] : vulnActions;
    return actions.map((action, index) => ({
      ...action,
      uiId: `action-${index}`,
    }));
  }, [vulnData, vulnActions]);

  const groupedVulnerabilitiesData = vulnerabilitiesData.reduce((acc, vul) => {
    (acc[vul.status] = acc[vul.status] || []).push(vul);
    return acc;
  }, {});

  const selectedVulnerability =
    selectedStatus && groupedVulnerabilitiesData[selectedStatus] && selectedIndex >= 0
      ? groupedVulnerabilitiesData[selectedStatus][selectedIndex]
      : null;

  const handleListItemClick = (status, index) => {
    setSelectedStatus(status);
    setSelectedIndex(index);
  };

  const handleCloseDetailView = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  const handleExited = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  return (
    <Dialog
      open={open}
      onClose={onClose}
      maxWidth="lg"
      fullWidth
      TransitionProps={{ onExited: handleExited }}
    >
      <DialogTitle
        sx={{
          fontWeight: 700,
          borderBottom: 1,
          borderColor: "divider",
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        {vulnData?.cve_id || "CVE情報なし"}
        <IconButton
          aria-label="close"
          onClick={onClose}
          sx={{
            p: 0.5,
          }}
        >
          <Close />
        </IconButton>
      </DialogTitle>

      <DialogContent sx={{ bgcolor: "grey.50", p: 0 }}>
        <Box sx={{ height: "85vh", display: "flex", flexDirection: "column" }}>
          {/* 共通情報エリア (Accordionで折りたたみ) */}
          <CommonInfoAccordion vulnData={vulnData} actionsWithUiId={actionsWithUiId} />

          {/* 可変エリア (リスト/詳細) */}
          <Box sx={{ flexGrow: 1, overflow: "hidden" }}>
            {isMobile ? (
              // モバイル表示
              <Box sx={{ height: "100%", position: "relative" }}>
                {/* ステージ1: タスク一覧 */}
                <Box
                  sx={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    width: "100%",
                    height: "100%",
                  }}
                >
                  <ListPanel
                    groupedVulnerabilitiesData={groupedVulnerabilitiesData}
                    statuses={statuses}
                    selectedStatus={selectedStatus}
                    selectedIndex={selectedIndex}
                    onListItemClick={handleListItemClick}
                  />
                </Box>

                {/* ステージ2: タスク詳細 */}
                <Slide direction="left" in={!!selectedVulnerability} mountOnEnter unmountOnExit>
                  <Box
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      height: "100%",
                    }}
                  >
                    <DetailPanel
                      selectedVulnerability={selectedVulnerability}
                      vulnData={vulnData}
                      actionsWithUiId={actionsWithUiId}
                      isMobile={isMobile}
                      onCloseDetailView={handleCloseDetailView}
                    />
                  </Box>
                </Slide>
              </Box>
            ) : (
              // PC表示
              <Box sx={{ display: "flex", height: "100%" }}>
                <ListPanel
                  groupedVulnerabilitiesData={groupedVulnerabilitiesData}
                  statuses={statuses}
                  selectedStatus={selectedStatus}
                  selectedIndex={selectedIndex}
                  onListItemClick={handleListItemClick}
                />
                <DetailPanel
                  selectedVulnerability={selectedVulnerability}
                  vulnData={vulnData}
                  actionsWithUiId={actionsWithUiId}
                  isMobile={isMobile}
                  onCloseDetailView={handleCloseDetailView}
                />
              </Box>
            )}
          </Box>
        </Box>
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
  vulnData: PropTypes.object,
  vulnActions: PropTypes.array,
};
