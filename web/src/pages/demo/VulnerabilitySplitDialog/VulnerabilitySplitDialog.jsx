import { Close } from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  Slide,
} from "@mui/material";
import PropTypes from "prop-types";
import { useState, useMemo } from "react";

import { createActionByFixedVersions } from "../../../utils/vulnUtils";

import { CommonInfoAccordion } from "./components/CommonInfoAccordion";
import { DetailPanel } from "./components/DetailPanel";
import { ListPanel } from "./components/ListPanel";

export default function VulnerabilitySplitDialog({
  open,
  onClose,
  vulnData,
  vulnActions = [],
  tickets = [],
  references = [],
}) {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [selectedStatus, setSelectedStatus] = useState(null);

  // 緩和策を生成
  const actionsWithUiId = useMemo(() => {
    if (!vulnData?.vulnerable_packages?.[0]) return [];

    const matchedVulnPackage = vulnData.vulnerable_packages[0];
    const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
    const patchedVersions = matchedVulnPackage?.fixed_versions ?? [];
    const actionByFixedVersions = createActionByFixedVersions(
      affectedVersions,
      patchedVersions,
      matchedVulnPackage?.affected_name ?? "",
    );

    const actions = actionByFixedVersions ? [actionByFixedVersions, ...vulnActions] : vulnActions;
    return actions.map((action, index) => ({
      ...action,
      uiId: `action-${index}`,
    }));
  }, [vulnData, vulnActions]);

  // チケットをreferencesと結合して表示用データを生成
  const ticketsWithDetails = useMemo(() => {
    return tickets.map((ticket) => {
      const matchedReference = references.find(
        (reference) => reference.dependency_id === ticket.dependency_id,
      );
      return {
        id: ticket.ticket_id,
        target: matchedReference?.target || "Unknown Target",
        status: ticket.ticket_status.ticket_handling_status || "alerted",
        assignee: ticket.ticket_status.assignees?.[0] || "未割当",
        deadline: ticket.ticket_status.scheduled_at,
        ssvc: ticket.ssvc_deployer_priority,
        safetyImpact: ticket.ticket_status.current_safety_impact || "-",
        packageManager: matchedReference?.package_manager || "-",
        ticket: ticket, // 元のticketデータも保持
      };
    });
  }, [tickets, references]);

  // ステータスのグループ定義
  const statusGroups = useMemo(
    () => ({
      未着手: ["alerted"],
      対応中: ["acknowledged", "scheduled"],
      完了: ["completed"],
    }),
    [],
  );

  // チケットをグループごとに分類
  const groupedTicketsData = useMemo(() => {
    const grouped = {
      未着手: [],
      対応中: [],
      完了: [],
    };

    ticketsWithDetails.forEach((ticket) => {
      const status = ticket.status;
      if (statusGroups.未着手.includes(status)) {
        grouped.未着手.push(ticket);
      } else if (statusGroups.対応中.includes(status)) {
        grouped.対応中.push(ticket);
      } else if (statusGroups.完了.includes(status)) {
        grouped.完了.push(ticket);
      }
    });

    return grouped;
  }, [ticketsWithDetails, statusGroups]);

  // 表示用のステータスグループ一覧
  const statusGroupNames = useMemo(() => ["未着手", "対応中", "完了"], []);

  const selectedTicket =
    selectedStatus && groupedTicketsData[selectedStatus] && selectedIndex >= 0
      ? groupedTicketsData[selectedStatus][selectedIndex]
      : null;

  const handleListItemClick = (status, index) => {
    setSelectedStatus(status);
    setSelectedIndex(index);
  };

  const handleCloseDetailView = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  const handleExited = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  return (
    <Dialog
      open={open}
      onClose={onClose}
      maxWidth="lg"
      fullWidth
      TransitionProps={{ onExited: handleExited }}
    >
      <DialogTitle
        sx={{
          fontWeight: 700,
          borderBottom: 1,
          borderColor: "divider",
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        {vulnData?.cve_id || "CVE情報なし"}
        <IconButton
          aria-label="close"
          onClick={onClose}
          sx={{
            p: 0.5,
          }}
        >
          <Close />
        </IconButton>
      </DialogTitle>

      <DialogContent sx={{ bgcolor: "grey.50", p: 0 }}>
        <Box sx={{ height: "85vh", display: "flex", flexDirection: "column" }}>
          {/* 共通情報エリア (Accordionで折りたたみ) */}
          <CommonInfoAccordion vulnData={vulnData} actionsWithUiId={actionsWithUiId} />

          {/* 可変エリア (リスト/詳細) */}
          <Box sx={{ flexGrow: 1, overflow: "hidden" }}>
            {isMobile ? (
              // モバイル表示
              <Box sx={{ height: "100%", position: "relative" }}>
                {/* ステージ1: タスク一覧 */}
                <Box
                  sx={{
                    position: "absolute",
                    top: 0,
                    left: 0,
                    width: "100%",
                    height: "100%",
                  }}
                >
                  <ListPanel
                    groupedTicketsData={groupedTicketsData}
                    statusGroups={statusGroupNames}
                    selectedStatus={selectedStatus}
                    selectedIndex={selectedIndex}
                    onListItemClick={handleListItemClick}
                  />
                </Box>

                {/* ステージ2: タスク詳細 */}
                <Slide direction="left" in={!!selectedTicket} mountOnEnter unmountOnExit>
                  <Box
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      height: "100%",
                    }}
                  >
                    <DetailPanel
                      selectedTicket={selectedTicket}
                      vulnData={vulnData}
                      actionsWithUiId={actionsWithUiId}
                      isMobile={isMobile}
                      onCloseDetailView={handleCloseDetailView}
                    />
                  </Box>
                </Slide>
              </Box>
            ) : (
              // PC表示
              <Box sx={{ display: "flex", height: "100%" }}>
                <ListPanel
                  groupedTicketsData={groupedTicketsData}
                  statusGroups={statusGroupNames}
                  selectedStatus={selectedStatus}
                  selectedIndex={selectedIndex}
                  onListItemClick={handleListItemClick}
                />
                <DetailPanel
                  selectedTicket={selectedTicket}
                  vulnData={vulnData}
                  actionsWithUiId={actionsWithUiId}
                  isMobile={isMobile}
                  onCloseDetailView={handleCloseDetailView}
                />
              </Box>
            )}
          </Box>
        </Box>
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
  vulnData: PropTypes.object,
  vulnActions: PropTypes.array,
  tickets: PropTypes.array,
  references: PropTypes.array,
};
