import { TableCell, TableRow, Box } from "@mui/material";
import PropTypes from "prop-types";
import { useLocation } from "react-router-dom";

import { useGetVulnQuery, useGetPteamTicketsQuery } from "../../../services/tcApi";

export default function VulnerabilityTableRow({ vuln, onRowClick }) {
  const params = new URLSearchParams(useLocation().search);
  const pteamId = params.get("pteamId");
  const serviceId = params.get("serviceId");
  const packageId = params.get("packageId");

  const { data: vulnData, isLoading: vulnIsLoading, error: vulnError } = useGetVulnQuery(vuln);
  const {
    data: tickets = [],
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useGetPteamTicketsQuery(
    { pteamId, serviceId, vulnId: vuln, packageId },
    { skip: !pteamId || !serviceId || !vuln },
  );

  if (vulnIsLoading) {
    return (
      <TableRow>
        <TableCell colSpan={6} align="center">
          Loading...
        </TableCell>
      </TableRow>
    );
  }

  if (vulnError) {
    return (
      <TableRow>
        <TableCell colSpan={6} align="center" sx={{ color: "error.main" }}>
          Error loading vulnerability data
        </TableCell>
      </TableRow>
    );
  }

  return (
    <TableRow
      key={vuln}
      onClick={() => onRowClick(vuln)}
      hover
      sx={(theme) => ({
        // theme を引数に取る
        cursor: "pointer",
        display: { xs: "block", sm: "table-row" },
        // xs: カード型の時の下線 (カード間の境界)
        borderBottom: { xs: `1px solid ${theme.palette.divider}`, sm: "none" },
        padding: { xs: "16px", sm: 0 },
        "&:last-of-type": {
          borderBottom: { xs: "none" }, // 最後のカードの下線は消す
        },

        // ▼▼▼ 修正点 ▼▼▼
        // sm以上の時、すべての子(TableCell)に強制的に下線を引く
        "& > .MuiTableCell-root": {
          borderBottom: { sm: `1px solid ${theme.palette.divider}` },
        },
        // ▲▲▲ 修正点 ▲▲▲
      })}
    >
      {/* Title */}
      <TableCell
        sx={{
          display: { xs: "block", sm: "table-cell" },
          padding: { xs: 0, sm: "16px" },
          // xsの時は borderBottom を 'none' に (親の指定を上書き)
          borderBottom: { xs: "none" },
          marginBottom: { xs: "12px", sm: 0 },
        }}
      >
        <Box
          component="span"
          sx={{
            display: { xs: "block", sm: "none" },
            fontWeight: "bold",
            fontSize: "0.75rem",
            color: "text.secondary",
            marginBottom: "2px",
          }}
        >
          Title
        </Box>
        {vulnData?.title || "No Title"}
      </TableCell>

      {/* Tasks (sm以上で表示) */}
      <TableCell
        align="center"
        sx={{
          display: { xs: "none", sm: "table-cell" },
          // borderBottomの指定は不要 (親のTableRowが設定してくれる)
        }}
      >
        {ticketsIsLoading ? "-" : ticketsError ? "Error" : tickets.length}
      </TableCell>

      {/* Highest SSVC */}
      <TableCell
        align="center"
        sx={{
          display: { xs: "block", sm: "table-cell" },
          padding: { xs: 0, sm: "16px" },
          // xsの時は borderBottom を 'none' に (親の指定を上書き)
          borderBottom: { xs: "none" },
          textAlign: { xs: "left", sm: "center" },
        }}
      >
        <Box
          component="span"
          sx={{
            display: { xs: "block", sm: "none" },
            fontWeight: "bold",
            fontSize: "0.75rem",
            color: "text.secondary",
            marginBottom: "4px",
          }}
        >
          Highest SSVC
        </Box>
        {/* SSVCチップはあとで実装 */}
      </TableCell>

      {/* Last Updated (md以上で表示) */}
      <TableCell
        sx={{
          display: { xs: "none", sm: "none", md: "table-cell" },
          // borderBottomの指定は不要 (親のTableRowが設定してくれる)
        }}
      >
        {vulnData?.updated_at ? new Date(vulnData.updated_at).toLocaleDateString() : "-"}
      </TableCell>

      {/* Affected Version (lg以上で表示) */}
      <TableCell
        sx={{
          display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
          // borderBottomの指定は不要 (親のTableRowが設定してくれる)
        }}
      >
        {(vuln.affected_versions || []).join("\n")}
      </TableCell>

      {/* Patched Version (lg以上で表示) */}
      <TableCell
        sx={{
          display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
          // borderBottomの指定は不要 (親のTableRowが設定してくれる)
        }}
      >
        {(vuln.patched_versions || []).join("\n")}
      </TableCell>
    </TableRow>
  );
}

VulnerabilityTableRow.propTypes = {
  vuln: PropTypes.string.isRequired,
  onRowClick: PropTypes.func.isRequired,
};
