import { http, HttpResponse } from "msw";

import { VulnerabilityTable } from "./VulnerabilityTable.jsx";
import { mockVulnIdsUnsolved, createVulnerabilityTableHandlers } from "./mocks/mockData.js";

const pteamId = "pteam-abc-123";
const serviceId = "service-a";
const packageId = "pkg-uuid-456";

export default {
  title: "PackagePage/VulnerabilityTable",
  component: VulnerabilityTable,
  tags: ["autodocs"],
  argTypes: {
    relatedTicketStatus: {
      control: { type: "select", options: ["unsolved", "solved"] },
      description: "Filter tickets by status (unsolved or solved)",
    },
  },
  decorators: [
    (Story) => (
      <div style={{ padding: "20px" }}>
        <Story />
      </div>
    ),
  ],
};

// Create default handlers using the shared factory
const defaultHandlers = createVulnerabilityTableHandlers(pteamId, serviceId, packageId);

export const Default = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const Empty = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: [
        http.get("*/pteams/:pteamId/vuln_ids", () => {
          return HttpResponse.json({ vuln_ids: [] });
        }),
        http.get("*/pteams/:pteamId/ticket_counts", () => {
          return HttpResponse.json({
            ssvc_priority_count: {
              immediate: 0,
              out_of_cycle: 0,
              scheduled: 0,
              defer: 0,
            },
          });
        }),
        ...defaultHandlers,
      ],
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const MissingPteamId = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const MissingServiceId = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const AllParametersMissing = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: ["/packages/some-package"],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const WithPagination = {
  args: {
    relatedTicketStatus: "unsolved",
  },
  parameters: {
    msw: {
      handlers: [
        http.get("*/pteams/:pteamId/vuln_ids", () => {
          const manyVulnIds = [
            ...mockVulnIdsUnsolved.vuln_ids,
            ...Array.from({ length: 15 }, (_, i) => `vuln-extra-${i}`),
          ];
          return HttpResponse.json({ vuln_ids: manyVulnIds });
        }),
        http.get("*/pteams/:pteamId/ticket_counts", () => {
          return HttpResponse.json({
            ssvc_priority_count: {
              immediate: 5,
              out_of_cycle: 8,
              scheduled: 10,
              defer: 3,
            },
          });
        }),
        ...defaultHandlers,
      ],
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const SolvedVulnerabilities = {
  args: {
    relatedTicketStatus: "solved",
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};
