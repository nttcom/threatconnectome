
import VulnerabilityTable from "./VulnerabilityTable.jsx";
import {
  mockVulnIdsUnsolved,
  mockVulnIdsSolved,
  createVulnerabilityTableHandlers,
} from "./mocks/mockData.js";

const pteamId = "pteam-abc-123";
const serviceId = "service-a";
const packageId = "pkg-uuid-456";

export default {
  title: "PackagePage/VulnerabilityTable",
  component: VulnerabilityTable,
  tags: ["autodocs"],
  argTypes: {
    vulnIds: {
      control: "object",
      description: "Array of vulnerability IDs to display",
    },
    defaultSafetyImpact: {
      control: "text",
      description: "Default safety impact level for the service",
    },
    page: {
      control: "number",
      description: "Current page number (0-indexed)",
    },
    rowsPerPage: {
      control: { type: "select", options: [5, 10, 25] },
      description: "Number of rows per page",
    },
    ticketCounts: {
      control: "object",
      description: "SSVC priority counts for tickets",
    },
  },
  decorators: [
    (Story) => (
      <div style={{ padding: "20px" }}>
        <Story />
      </div>
    ),
  ],
};

// Create default handlers using the shared factory
const defaultHandlers = createVulnerabilityTableHandlers(pteamId, serviceId, packageId);

export const Default = {
  args: {
    vulnIds: mockVulnIdsUnsolved.vuln_ids,
    defaultSafetyImpact: "high",
    page: 0,
    rowsPerPage: 10,
    ticketCounts: {
      immediate: 2,
      out_of_cycle: 3,
      scheduled: 5,
      defer: 1,
    },
    onPageChange: (newPage) => console.log("Page changed to:", newPage),
    onRowsPerPageChange: (newRowsPerPage) =>
      console.log("Rows per page changed to:", newRowsPerPage),
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const Empty = {
  args: {
    vulnIds: [],
    defaultSafetyImpact: "high",
    page: 0,
    rowsPerPage: 10,
    ticketCounts: {
      immediate: 0,
      out_of_cycle: 0,
      scheduled: 0,
      defer: 0,
    },
    onPageChange: (newPage) => console.log("Page changed to:", newPage),
    onRowsPerPageChange: (newRowsPerPage) =>
      console.log("Rows per page changed to:", newRowsPerPage),
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

const manyVulnIds = [
  ...mockVulnIdsUnsolved.vuln_ids,
  ...Array.from({ length: 15 }, (_, i) => `vuln-extra-${i}`),
];

export const WithPagination = {
  args: {
    vulnIds: manyVulnIds,
    defaultSafetyImpact: "medium",
    page: 0,
    rowsPerPage: 5,
    ticketCounts: {
      immediate: 5,
      out_of_cycle: 8,
      scheduled: 10,
      defer: 3,
    },
    onPageChange: (newPage) => console.log("Page changed to:", newPage),
    onRowsPerPageChange: (newRowsPerPage) =>
      console.log("Rows per page changed to:", newRowsPerPage),
  },
  parameters: {
    msw: {
      // Use the same handlers - they support both existing and extra vulnerabilities
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};

export const SolvedVulnerabilities = {
  args: {
    vulnIds: mockVulnIdsSolved.vuln_ids,
    defaultSafetyImpact: "low",
    page: 0,
    rowsPerPage: 10,
    ticketCounts: {
      immediate: 0,
      out_of_cycle: 0,
      scheduled: 1,
      defer: 0,
    },
    onPageChange: (newPage) => console.log("Page changed to:", newPage),
    onRowsPerPageChange: (newRowsPerPage) =>
      console.log("Rows per page changed to:", newRowsPerPage),
  },
  parameters: {
    msw: {
      handlers: defaultHandlers,
    },
    router: {
      memoryRouterProps: {
        initialEntries: [`/packages/${packageId}?pteamId=${pteamId}&serviceId=${serviceId}`],
      },
      path: "/packages/:packageId",
      useRoutes: true,
    },
  },
};
