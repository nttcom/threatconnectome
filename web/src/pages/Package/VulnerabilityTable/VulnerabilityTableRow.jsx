import { TableCell, TableRow, Box } from "@mui/material";
import PropTypes from "prop-types";
import { useState } from "react";

import { SSVCPriorityStatusChip } from "../../../components/SSVCPriorityStatusChip";
import { usePageParams } from "../../../hooks/usePageParams";
import { searchWorstSSVC } from "../../../utils/func";
import { findMatchedVulnPackage } from "../../../utils/vulnUtils";

import VulnerabilitySplitDialog from "./VulnerabilitySplitDialog/VulnerabilitySplitDialog";
import { LoadingRow, ErrorRow, NoDataRow } from "./VulnerabilityTableRowState";
import { useVulnTableRowVuln, useVulnTableRowTickets, useVulnTableRowDependencies } from "./api";

export default function VulnerabilityTableRow({ vulnId }) {
  const [dialogOpen, setDialogOpen] = useState(false);

  const { packageId, pteamId, serviceId } = usePageParams();

  const {
    data: vulnData,
    isLoading: vulnIsLoading,
    error: vulnError,
  } = useVulnTableRowVuln(vulnId);

  const {
    tickets,
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useVulnTableRowTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const {
    serviceDependencies,
    isLoading: dependenciesIsLoading,
    error: dependenciesError,
  } = useVulnTableRowDependencies({
    pteamId,
    serviceId,
    packageId,
  });

  const currentPackage = {
    package_name: serviceDependencies?.[0]?.package_name,
    package_source_name: serviceDependencies?.[0]?.package_source_name,
    vuln_matching_ecosystem: serviceDependencies?.[0]?.vuln_matching_ecosystem,
  };
  const vulnerable_package = findMatchedVulnPackage(vulnData?.vulnerable_packages, currentPackage);
  const affectedVersions = vulnerable_package?.affected_versions;
  const patchedVersions = vulnerable_package?.fixed_versions;

  if (vulnIsLoading || dependenciesIsLoading) {
    return <LoadingRow colSpan={6} />;
  }

  if (vulnError) {
    return <ErrorRow error={vulnError} colSpan={6} message="Error loading vulnerability data" />;
  }

  if (dependenciesError) {
    return <ErrorRow error={dependenciesError} colSpan={6} message="Error loading dependencies" />;
  }

  if (!vulnData) {
    return <NoDataRow colSpan={6} message="No vulnerability data available" />;
  }

  if (!serviceDependencies || serviceDependencies.length === 0) {
    return <NoDataRow colSpan={6} message="No dependency data available" />;
  }

  // エラーがある場合はダイアログを開かない
  const hasDataError = ticketsError;
  const canOpenDialog = !hasDataError;

  return (
    <>
      <TableRow
        key={vulnId}
        onClick={() => canOpenDialog && setDialogOpen(true)}
        hover={canOpenDialog}
        sx={(theme) => ({
          // theme を引数に取る
          cursor: canOpenDialog ? "pointer" : "default",
          display: { xs: "block", sm: "table-row" },
          // xs: カード型の時の下線 (カード間の境界)
          borderBottom: { xs: `1px solid ${theme.palette.divider}`, sm: "none" },
          padding: { xs: "16px", sm: 0 },
          "&:last-of-type": {
            borderBottom: { xs: "none" }, // 最後のカードの下線は消す
          },

          // ▼▼▼ 修正点 ▼▼▼
          // sm以上の時、すべての子(TableCell)に強制的に下線を引く
          "& > .MuiTableCell-root": {
            borderBottom: { sm: `1px solid ${theme.palette.divider}` },
          },
          // ▲▲▲ 修正点 ▲▲▲
        })}
      >
        {/* Title */}
        <TableCell
          sx={{
            display: { xs: "block", sm: "table-cell" },
            padding: { xs: 0, sm: "16px" },
            // xsの時は borderBottom を 'none' に (親の指定を上書き)
            borderBottom: { xs: "none" },
            marginBottom: { xs: "12px", sm: 0 },
          }}
        >
          <Box
            component="span"
            sx={{
              display: { xs: "block", sm: "none" },
              fontWeight: "bold",
              fontSize: "0.75rem",
              color: "text.secondary",
              marginBottom: "2px",
            }}
          >
            Title
          </Box>
          {vulnData?.title || "No Title"}
        </TableCell>

        {/* Tasks (sm以上で表示) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "table-cell" },
            // borderBottomの指定は不要 (親のTableRowが設定してくれる)
          }}
        >
          {ticketsIsLoading ? "-" : ticketsError ? "Error" : (tickets?.length ?? 0)}
        </TableCell>

        {/* Highest SSVC */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "flex", sm: "table-cell" },
            padding: { xs: 0, sm: "16px" },
            // xsの時は borderBottom を 'none' に (親の指定を上書き)
            borderBottom: { xs: "none" },
            textAlign: { xs: "left", sm: "center" },
            alignItems: { xs: "center" },
          }}
        >
          <Box
            component="span"
            sx={{
              display: { xs: "block", sm: "none" },
              fontWeight: "bold",
              fontSize: "0.75rem",
              color: "text.secondary",
              mr: 2,
            }}
          >
            Highest SSVC
          </Box>
          {ticketsIsLoading ? (
            "-"
          ) : ticketsError ? (
            "Error"
          ) : tickets && tickets.length > 0 && searchWorstSSVC(tickets) ? (
            <Box sx={{ display: "flex", justifyContent: "center" }}>
              <SSVCPriorityStatusChip displaySSVCPriority={searchWorstSSVC(tickets)} />
            </Box>
          ) : (
            "-"
          )}
        </TableCell>

        {/* Last Updated (md以上で表示) */}
        <TableCell
          sx={{
            display: { xs: "none", sm: "none", md: "table-cell" },
            // borderBottomの指定は不要 (親のTableRowが設定してくれる)
          }}
        >
          {vulnData?.updated_at ? new Date(vulnData.updated_at).toLocaleDateString() : "-"}
        </TableCell>

        {/* Affected Version (lg以上で表示) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
            // borderBottomの指定は不要 (親のTableRowが設定してくれる)
          }}
        >
          {affectedVersions?.map((affectedVersion, index) =>
            index + 1 === affectedVersions.length ? (
              <span key={index}>{affectedVersion}</span>
            ) : (
              <span key={index}>
                {affectedVersion}
                <br />
              </span>
            ),
          )}
        </TableCell>

        {/* Patched Version (lg以上で表示) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
            // borderBottomの指定は不要 (親のTableRowが設定してくれる)
          }}
        >
          {patchedVersions?.map((patchedVersion, index) =>
            index + 1 === patchedVersions.length ? (
              <span key={index}>{patchedVersion}</span>
            ) : (
              <span key={index}>
                {patchedVersion}
                <br />
              </span>
            ),
          )}
        </TableCell>
      </TableRow>

      <VulnerabilitySplitDialog
        open={dialogOpen}
        onClose={() => setDialogOpen(false)}
        vulnData={vulnData}
        tickets={tickets ?? []}
        references={serviceDependencies ?? []}
      />
    </>
  );
}

VulnerabilityTableRow.propTypes = {
  vulnId: PropTypes.string.isRequired,
};
