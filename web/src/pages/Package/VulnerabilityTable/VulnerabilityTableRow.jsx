import { TableCell, TableRow, Box } from "@mui/material";
import PropTypes from "prop-types";
import { useState } from "react";

import { SSVCPriorityStatusChip } from "../../../components/SSVCPriorityStatusChip";
import { usePageParams } from "../../../hooks/usePageParams";
import { searchWorstSSVC, utcStringToLocalDate } from "../../../utils/func";
import { findMatchedVulnPackage } from "../../../utils/vulnUtils";

import VulnDialogContext from "./VulnDialogContext";
import { VulnerabilitySplitDialog } from "./VulnerabilitySplitDialog/VulnerabilitySplitDialog";
import { useGetVuln, useGetTickets, useGetDependencies } from "./api";

const COLUMN_SPAN = 6;
const MOBILE_LABEL_STYLES = {
  display: { xs: "block", sm: "none" },
  fontWeight: "bold",
  fontSize: "0.75rem",
  color: "text.secondary",
};

function renderVersionList(versions) {
  if (!versions || versions.length === 0) return null;

  return versions.map((version, index) => (
    <span key={`version-${version}-${index}`}>
      {version}
      {index < versions.length - 1 && <br />}
    </span>
  ));
}

export function VulnerabilityTableRow({ vulnId }) {
  const [dialogOpen, setDialogOpen] = useState(false);

  const { packageId, pteamId, serviceId } = usePageParams();

  const { data: vulnData, isLoading: vulnIsLoading, error: vulnError } = useGetVuln(vulnId);

  const {
    tickets,
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const {
    data: dependencies = [],
    isLoading: dependencyIsLoading,
    error: dependencyError,
  } = useGetDependencies({
    pteamId,
    serviceId,
    packageId,
  });

  const currentPackage = {
    package_name: dependencies[0]?.package_name,
    package_source_name: dependencies[0]?.package_source_name,
    vuln_matching_ecosystem: dependencies[0]?.vuln_matching_ecosystem,
  };

  const { affected_versions, fixed_versions } =
    findMatchedVulnPackage(vulnData?.vulnerable_packages, currentPackage) ?? {};

  const worstSSVC = tickets && tickets.length > 0 ? searchWorstSSVC(tickets) : null;
  const formattedDate = vulnData?.updated_at
    ? utcStringToLocalDate(vulnData.updated_at, false)
    : "-";

  const handleRowClick = () => {
    if (!ticketsError) {
      setDialogOpen(true);
    }
  };

  const handleDialogClose = () => {
    setDialogOpen(false);
  };

  const handleKeyDown = (event) => {
    if ((event.key === "Enter" || event.key === " ") && !ticketsError) {
      event.preventDefault();
      setDialogOpen(true);
    }
  };

  const isLoading = vulnIsLoading || dependencyIsLoading || ticketsIsLoading;
  if (isLoading) {
    return (
      <TableRow>
        <TableCell colSpan={COLUMN_SPAN} align="center">
          Loading...
        </TableCell>
      </TableRow>
    );
  }

  if (vulnError) {
    return (
      <TableRow>
        <TableCell colSpan={COLUMN_SPAN} align="center" sx={{ color: "error.main" }}>
          Failed to load vulnerability data. Please try again later.
        </TableCell>
      </TableRow>
    );
  }

  if (dependencyError) {
    return (
      <TableRow>
        <TableCell colSpan={COLUMN_SPAN} align="center" sx={{ color: "error.main" }}>
          Failed to load dependencies. Please try again later.
        </TableCell>
      </TableRow>
    );
  }

  if (!vulnData) {
    return (
      <TableRow>
        <TableCell colSpan={COLUMN_SPAN} align="center" sx={{ color: "warning.main" }}>
          No vulnerability data available
        </TableCell>
      </TableRow>
    );
  }

  if (dependencies.length === 0) {
    return (
      <TableRow>
        <TableCell colSpan={COLUMN_SPAN} align="center" sx={{ color: "warning.main" }}>
          No dependencies available
        </TableCell>
      </TableRow>
    );
  }

  const canOpenDialog = !ticketsError;

  return (
    <>
      <TableRow
        onClick={handleRowClick}
        onKeyDown={handleKeyDown}
        tabIndex={canOpenDialog ? 0 : -1}
        role={canOpenDialog ? "button" : undefined}
        aria-label={
          canOpenDialog ? `View details for vulnerability ${vulnData?.title || vulnId}` : undefined
        }
        hover={canOpenDialog}
        sx={(theme) => ({
          cursor: canOpenDialog ? "pointer" : "default",
          display: { xs: "block", sm: "table-row" },
          borderBottom: { xs: `1px solid ${theme.palette.divider}`, sm: "none" },
          padding: { xs: "16px", sm: 0 },
          "&:last-of-type": {
            borderBottom: { xs: "none" },
          },
          "& > .MuiTableCell-root": {
            borderBottom: { sm: `1px solid ${theme.palette.divider}` },
          },
          ...(canOpenDialog && {
            "&:focus": {
              outline: `2px solid ${theme.palette.primary.main}`,
              outlineOffset: "-2px",
            },
          }),
        })}
      >
        {/* Title */}
        <TableCell
          sx={{
            display: { xs: "block", sm: "table-cell" },
            padding: { xs: 0, sm: "16px" },
            borderBottom: { xs: "none" },
            marginBottom: { xs: "12px", sm: 0 },
          }}
        >
          <Box component="span" sx={{ ...MOBILE_LABEL_STYLES, marginBottom: "2px" }}>
            Title
          </Box>
          {vulnData?.title || "No Title"}
        </TableCell>

        {/* Tasks (visible on sm and up) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "table-cell" },
          }}
        >
          {ticketsIsLoading ? "-" : ticketsError ? "Error" : (tickets?.length ?? 0)}
        </TableCell>

        {/* Highest SSVC */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "flex", sm: "table-cell" },
            padding: { xs: 0, sm: "16px" },
            borderBottom: { xs: "none" },
            textAlign: { xs: "left", sm: "center" },
            alignItems: { xs: "center" },
          }}
        >
          <Box component="span" sx={{ ...MOBILE_LABEL_STYLES, mr: 2 }}>
            Highest SSVC
          </Box>
          {ticketsIsLoading ? (
            "-"
          ) : ticketsError ? (
            "Error"
          ) : worstSSVC ? (
            <Box sx={{ display: "flex", justifyContent: "center" }}>
              <SSVCPriorityStatusChip displaySSVCPriority={worstSSVC} />
            </Box>
          ) : (
            "-"
          )}
        </TableCell>

        {/* Last Updated (visible on md and up) */}
        <TableCell
          sx={{
            display: { xs: "none", sm: "none", md: "table-cell" },
          }}
        >
          {formattedDate}
        </TableCell>

        {/* Affected Version (visible on lg and up) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
          }}
        >
          {renderVersionList(affected_versions) || "-"}
        </TableCell>

        {/* Patched Version (visible on lg and up) */}
        <TableCell
          align="center"
          sx={{
            display: { xs: "none", sm: "none", md: "none", lg: "table-cell" },
          }}
        >
          {renderVersionList(fixed_versions) || "-"}
        </TableCell>
      </TableRow>

      <VulnDialogContext value={{ vulnId }}>
        <VulnerabilitySplitDialog open={dialogOpen} onClose={handleDialogClose} />
      </VulnDialogContext>
    </>
  );
}

VulnerabilityTableRow.propTypes = {
  vulnId: PropTypes.string.isRequired,
};
