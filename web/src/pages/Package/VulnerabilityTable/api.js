import { useSkipUntilAuthUserIsReady } from "../../../hooks/auth";
import {
  useGetPTeamQuery,
  useGetPTeamVulnIdsTiedToServicePackageQuery,
  useGetPTeamTicketCountsTiedToServicePackageQuery,
  useGetVulnQuery,
  useGetPteamTicketsQuery,
  useGetDependencyQuery,
  useGetPTeamMembersQuery,
} from "../../../services/tcApi";

/**
 * VulnerabilityTable component API hooks
 */

/**
 * Custom hook to get PTeam details and extract default Safety Impact
 * RTK Query hooks use new argument format ({ path: {} })
 */
export function useVulnTablePTeam(pteamId, serviceId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || skipByAuth;

  return useGetPTeamQuery(
    { path: { pteam_id: pteamId } },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        defaultSafetyImpact:
          data?.services?.find((service) => service.service_id === serviceId)
            ?.service_safety_impact || "Not Set",
        isLoading,
        error,
      }),
    },
  );
}

/**
 * Custom hook to get vulnerability ID list related to package
 * RTK Query hooks use new argument format ({ path: {}, query: {} })
 */
export function useVulnTableVulnIds({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamVulnIdsTiedToServicePackageQuery(
    {
      path: { pteam_id: pteamId },
      query: {
        service_id: serviceId,
        package_id: packageId,
        related_ticket_status: relatedTicketStatus,
      },
    },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        vulnIds: data?.vuln_ids || [],
        isLoading,
        error,
      }),
    },
  );
}

/**
 * Custom hook to get ticket counts (by SSVC priority) related to package
 * RTK Query hooks use new argument format ({ path: {}, query: {} })
 */
export function useVulnTableTicketCounts({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamTicketCountsTiedToServicePackageQuery(
    {
      path: { pteam_id: pteamId },
      query: {
        service_id: serviceId,
        package_id: packageId,
        related_ticket_status: relatedTicketStatus,
      },
    },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        ticketCounts: data?.ssvc_priority_count || {},
        isLoading,
        error,
      }),
    },
  );
}

/**
 * VulnerabilityTableRow - Custom hook for fetching vulnerability data
 * RTK Query hooks use new argument format ({ path: {} })
 */
export function useVulnTableRowVuln(vulnId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !vulnId;

  return useGetVulnQuery({ path: { vuln_id: vulnId } }, { skip });
}

/**
 * VulnerabilityTableRow - Custom hook for fetching ticket data
 * RTK Query hooks use new argument format ({ path: {}, query: {} })
 */
export function useVulnTableRowTickets({ pteamId, serviceId, vulnId, packageId }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId || !serviceId || !vulnId;

  return useGetPteamTicketsQuery(
    {
      path: { pteam_id: pteamId },
      query: { service_id: serviceId, vuln_id: vulnId, package_id: packageId },
    },
    {
      skip,
      selectFromResult: ({ data = [], isLoading, error }) => ({
        tickets: data,
        isLoading,
        error,
      }),
    },
  );
}

/**
 * Custom hook to get single dependency data
 * RTK Query hooks use new argument format ({ path: {} })
 */
export function useGetDependency({ pteamId, dependencyId }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId || !dependencyId;

  return useGetDependencyQuery(
    { path: { pteam_id: pteamId, dependency_id: dependencyId } },
    { skip },
  );
}

/**
 * AssigneesSelector - Custom hook for fetching PTeam members
 * RTK Query hooks use new argument format ({ path: {} })
 */
export function useAssigneesSelectorMembers(pteamId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId;

  return useGetPTeamMembersQuery({ path: { pteam_id: pteamId } }, { skip });
}
