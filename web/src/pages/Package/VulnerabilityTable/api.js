import { useSkipUntilAuthUserIsReady } from "../../../hooks/auth";
import {
  useGetPTeamQuery,
  useGetPTeamVulnIdsTiedToServicePackageQuery,
  useGetPTeamTicketCountsTiedToServicePackageQuery,
  useGetVulnQuery,
  useGetPteamTicketsQuery,
  useGetDependenciesQuery,
  useGetPTeamMembersQuery,
} from "../../../services/tcApi";

/**
 * VulnerabilityTable コンポーネント専用のAPIフック
 */

/**
 * PTeamの詳細情報を取得し、デフォルトのSafety Impactを抽出するカスタムフック
 */
export function useVulnTablePTeam(pteamId, serviceId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || skipByAuth;

  return useGetPTeamQuery(pteamId, {
    skip,
    selectFromResult: ({ data, isLoading, error }) => ({
      defaultSafetyImpact:
        data?.services?.find((service) => service.service_id === serviceId)
          ?.service_safety_impact || "Not Set",
      isLoading,
      error,
    }),
  });
}

/**
 * パッケージに関連する脆弱性IDリストを取得するカスタムフック
 */
export function useVulnTableVulnIds({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamVulnIdsTiedToServicePackageQuery(
    { pteamId, serviceId, packageId, relatedTicketStatus },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        vulnIds: data?.vuln_ids || [],
        isLoading,
        error,
      }),
    },
  );
}

/**
 * パッケージに関連するチケットカウント（SSVC優先度別）を取得するカスタムフック
 */
export function useVulnTableTicketCounts({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamTicketCountsTiedToServicePackageQuery(
    { pteamId, serviceId, packageId, relatedTicketStatus },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        ticketCounts: data?.ssvc_priority_count || {},
        isLoading,
        error,
      }),
    },
  );
}

/**
 * VulnerabilityTableRow - 脆弱性データ取得用カスタムフック
 */
export function useVulnTableRowVuln(vulnId) {
  return useGetVulnQuery(vulnId);
}

/**
 * VulnerabilityTableRow - チケットデータ取得用カスタムフック
 */
export function useVulnTableRowTickets({ pteamId, serviceId, vulnId, packageId }) {
  const skip = !pteamId || !serviceId || !vulnId;

  return useGetPteamTicketsQuery(
    { pteamId, serviceId, vulnId, packageId },
    {
      skip,
      selectFromResult: ({ data = [], isLoading, error }) => ({
        tickets: data,
        isLoading,
        error,
      }),
    },
  );
}

/**
 * VulnerabilityTableRow - 依存関係データ取得用カスタムフック
 */
export function useVulnTableRowDependencies({ pteamId, serviceId, packageId, offset = 0, limit = 1000 }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId || !serviceId || !packageId;

  return useGetDependenciesQuery(
    { pteamId, serviceId, packageId, offset, limit },
    {
      skip,
      selectFromResult: ({ data = [], isLoading, error }) => ({
        serviceDependencies: data,
        isLoading,
        error,
      }),
    },
  );
}

/**
 * PersonnelSelector - PTeamメンバー取得用カスタムフック
 */
export function usePersonnelSelectorMembers(pteamId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId;

  return useGetPTeamMembersQuery(pteamId, { skip });
}
