import { useSkipUntilAuthUserIsReady } from "../../../hooks/auth";
import {
  useGetPTeamQuery,
  useGetPTeamVulnIdsTiedToServicePackageQuery,
  useGetPTeamTicketCountsTiedToServicePackageQuery,
  useGetVulnQuery,
  useGetPteamTicketsQuery,
  useGetDependencyQuery,
  useGetPTeamMembersQuery,
} from "../../../services/tcApi";

/**
 * VulnerabilityTable コンポーネント専用のAPIフック
 */

/**
 * PTeamの詳細情報を取得し、デフォルトのSafety Impactを抽出するカスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {} }）で渡す
 */
export function useVulnTablePTeam(pteamId, serviceId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || skipByAuth;

  return useGetPTeamQuery(
    { path: { pteam_id: pteamId } },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        defaultSafetyImpact:
          data?.services?.find((service) => service.service_id === serviceId)
            ?.service_safety_impact || "Not Set",
        isLoading,
        error,
      }),
    },
  );
}

/**
 * パッケージに関連する脆弱性IDリストを取得するカスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {}, query: {} }）で渡す
 */
export function useVulnTableVulnIds({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamVulnIdsTiedToServicePackageQuery(
    {
      path: { pteam_id: pteamId },
      query: {
        service_id: serviceId,
        package_id: packageId,
        related_ticket_status: relatedTicketStatus,
      },
    },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        vulnIds: data?.vuln_ids || [],
        isLoading,
        error,
      }),
    },
  );
}

/**
 * パッケージに関連するチケットカウント（SSVC優先度別）を取得するカスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {}, query: {} }）で渡す
 */
export function useVulnTableTicketCounts({ pteamId, serviceId, packageId, relatedTicketStatus }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = !pteamId || !serviceId || !packageId || skipByAuth;

  return useGetPTeamTicketCountsTiedToServicePackageQuery(
    {
      path: { pteam_id: pteamId },
      query: {
        service_id: serviceId,
        package_id: packageId,
        related_ticket_status: relatedTicketStatus,
      },
    },
    {
      skip,
      selectFromResult: ({ data, isLoading, error }) => ({
        ticketCounts: data?.ssvc_priority_count || {},
        isLoading,
        error,
      }),
    },
  );
}

/**
 * VulnerabilityTableRow - 脆弱性データ取得用カスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {} }）で渡す
 */
export function useVulnTableRowVuln(vulnId) {
  return useGetVulnQuery({ path: { vuln_id: vulnId } });
}

/**
 * VulnerabilityTableRow - チケットデータ取得用カスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {}, query: {} }）で渡す
 */
export function useVulnTableRowTickets({ pteamId, serviceId, vulnId, packageId }) {
  const skip = !pteamId || !serviceId || !vulnId;

  return useGetPteamTicketsQuery(
    {
      path: { pteam_id: pteamId },
      query: { service_id: serviceId, vuln_id: vulnId, package_id: packageId },
    },
    {
      skip,
      selectFromResult: ({ data = [], isLoading, error }) => ({
        tickets: data,
        isLoading,
        error,
      }),
    },
  );
}

/**
 * 単一の依存関係データを取得するカスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {} }）で渡す
 */
export function useGetDependency({ pteamId, dependencyId }) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId || !dependencyId;

  return useGetDependencyQuery(
    { path: { pteam_id: pteamId, dependency_id: dependencyId } },
    { skip },
  );
}

/**
 * PersonnelSelector - PTeamメンバー取得用カスタムフック
 * RTK Queryフックには新しい引数形式（{ path: {} }）で渡す
 */
export function usePersonnelSelectorMembers(pteamId) {
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skip = skipByAuth || !pteamId;

  return useGetPTeamMembersQuery({ path: { pteam_id: pteamId } }, { skip });
}
