import { ExpandMore } from "@mui/icons-material";
import {
  Accordion,
  AccordionDetails,
  AccordionSummary,
  Box,
  Chip,
  List,
  ListItem,
  ListItemButton,
  ListItemText,
  Typography,
} from "@mui/material";
import { blue, green, grey } from "@mui/material/colors";
import PropTypes from "prop-types";
import React from "react";

import { usePageParams } from "../../../../hooks/usePageParams";
import { useGetDependenciesQuery } from "../../../../services/tcApi";
import { useVulnTableRowTickets } from "../api";

import { useVulnDialog } from "./VulnDialogContext";
import { getSsvcColor } from "./utils/utils";

const SECTION_CONFIG = {
  alerted: {
    title: "Todo",
    headerColor: grey[300],
    defaultExpanded: true,
  },
  "in-progress": {
    title: "In Progress",
    headerColor: blue[50],
    defaultExpanded: true,
  },
  completed: {
    title: "Done",
    headerColor: green[50],
    defaultExpanded: false,
  },
};

export function TicketListSection({ statusFilter, selectedId, onSelect }) {
  const { vulnId } = useVulnDialog();
  const { title, headerColor, defaultExpanded } = SECTION_CONFIG[statusFilter];
  const { pteamId, serviceId, packageId } = usePageParams();
  const { tickets: rawTickets = [], isLoading: ticketsLoading } = useVulnTableRowTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  // 全ての依存関係を取得
  const { data: allDependencies = [], isLoading: allDepsLoading } = useGetDependenciesQuery(
    { pteamId, serviceId, packageId, offset: 0, limit: 1000 },
    { skip: !pteamId || !serviceId || !packageId },
  );

  // dependency_id から target へのマッピングを作成
  const dependencyMap = React.useMemo(() => {
    const map = new Map();
    allDependencies.forEach((dep) => {
      map.set(dep.dependency_id, dep.target);
    });
    return map;
  }, [allDependencies]);

  const tickets =
    ticketsLoading || allDepsLoading
      ? []
      : rawTickets
          .filter((ticket) => {
            const status = ticket.ticket_status.ticket_handling_status || "alerted";
            if (statusFilter === "alerted") return status === "alerted";
            if (statusFilter === "in-progress")
              return status === "acknowledged" || status === "scheduled";
            if (statusFilter === "completed") return status === "completed";
            return false;
          })
          .map((ticket) => ({
            id: ticket.ticket_id,
            target: dependencyMap.get(ticket.dependency_id) || "Unknown Target",
            ssvc: ticket.ssvc_deployer_priority,
          }));

  return (
    <Accordion
      defaultExpanded={defaultExpanded}
      disableGutters
      elevation={0}
      square
      sx={{ "&:before": { display: "none" } }}
    >
      <AccordionSummary
        expandIcon={<ExpandMore />}
        sx={{
          bgcolor: headerColor,
          flexDirection: "row-reverse",
          "& .MuiAccordionSummary-expandIconWrapper.Mui-expanded": { transform: "rotate(90deg)" },
          "& .MuiAccordionSummary-content": { marginLeft: 1 },
          minHeight: 48,
        }}
      >
        <Typography variant="subtitle2" color="text.secondary" sx={{ fontWeight: "bold" }}>
          {title} ({tickets.length})
        </Typography>
      </AccordionSummary>

      <AccordionDetails sx={{ p: 0 }}>
        <List disablePadding>
          {tickets.map((ticket) => (
            <ListItem key={ticket.id} disablePadding>
              <ListItemButton
                selected={selectedId === ticket.id}
                onClick={() => onSelect(ticket.id)}
                sx={{
                  borderLeft: selectedId === ticket.id ? 4 : 4,
                  borderColor: selectedId === ticket.id ? blue[700] : "transparent",
                  pl: 4,
                  "&.Mui-selected": { bgcolor: blue[50] },
                }}
              >
                <ListItemText
                  primary={ticket.target}
                  secondary={
                    <Box component="span" sx={{ display: "flex", alignItems: "center", mt: 0.5 }}>
                      <Chip
                        label={ticket.ssvc}
                        size="small"
                        color={getSsvcColor(ticket.ssvc)}
                        variant="outlined"
                        sx={{ height: 20, fontSize: "0.7rem" }}
                      />
                    </Box>
                  }
                  slotProps={{
                    primary: {
                      component: "div",
                      variant: "body2",
                      fontWeight: selectedId === ticket.id ? "bold" : "normal",
                      noWrap: true,
                    },
                    secondary: { component: "div" },
                  }}
                />
              </ListItemButton>
            </ListItem>
          ))}
        </List>
      </AccordionDetails>
    </Accordion>
  );
}

TicketListSection.propTypes = {
  statusFilter: PropTypes.oneOf(["alerted", "in-progress", "completed"]).isRequired,
  selectedId: PropTypes.string,
  onSelect: PropTypes.func.isRequired,
};
