import { Alert, Box, CircularProgress, Grid } from "@mui/material";
import PropTypes from "prop-types";
import { useTranslation } from "react-i18next";

import { useVulnDialogContext } from "../../../../../components/VulnDialogContext.js";
import {
  useGetDefaultSafetyImpact,
  useGetTickets,
} from "../../../../../hooks/Package/useApiForVulnerabilityTable.js";
import { usePageParams } from "../../../../../hooks/usePageParams";

import { SafetyImpactCardView } from "./SafetyImpactCardView";

export function SafetyImpactCard({ ticketId }) {
  const { t } = useTranslation("package", {
    keyPrefix: "VulnerabilityTable.VulnerabilitySplitDialog.TicketDetailPanel.SafetyImpactCard",
  });
  const { vulnId } = useVulnDialogContext();
  const { pteamId, serviceId, packageId } = usePageParams();

  const { defaultSafetyImpact } = useGetDefaultSafetyImpact(pteamId, serviceId);

  const {
    tickets = [],
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  if (ticketsIsLoading) {
    return (
      <Grid size={{ xs: 12 }}>
        <Box sx={{ display: "flex", justifyContent: "center", py: 2 }}>
          <CircularProgress size={24} />
        </Box>
      </Grid>
    );
  }

  if (ticketsError) {
    return (
      <Grid size={{ xs: 12 }}>
        <Alert severity="error">{t("alert")}</Alert>
      </Grid>
    );
  }

  return (
    <SafetyImpactCardView
      ticketId={ticketId}
      tickets={tickets}
      defaultSafetyImpact={defaultSafetyImpact}
    />
  );
}

SafetyImpactCard.propTypes = {
  ticketId: PropTypes.string.isRequired,
};
