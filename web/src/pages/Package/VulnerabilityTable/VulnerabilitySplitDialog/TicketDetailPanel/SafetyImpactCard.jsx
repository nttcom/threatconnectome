import { CheckCircle, ExpandMore, HealthAndSafety, Notes, Save } from "@mui/icons-material";
import {
  Accordion,
  AccordionDetails,
  AccordionSummary,
  Alert,
  Box,
  Button,
  CircularProgress,
  Divider,
  FormControl,
  Grid,
  InputLabel,
  MenuItem,
  Select,
  Stack,
  TextField,
  Typography,
} from "@mui/material";
import { grey } from "@mui/material/colors";
import { useSnackbar } from "notistack";
import PropTypes from "prop-types";
import { useState, useEffect } from "react";

import { usePageParams } from "../../../../../hooks/usePageParams";
import { useUpdateTicketMutation } from "../../../../../services/tcApi";
import { maxReasonSafetyImpactLengthInHalf } from "../../../../../utils/const";
import { errorToString, countFullWidthAndHalfWidthCharacters } from "../../../../../utils/func";
import { useVulnDialogContext } from "../../VulnDialogContext";
import {
  useGetDefaultSafetyImpact,
  useGetTickets,
} from "../../../../../hooks/Package/useApiForVulnerabilityTable.js";

export function SafetyImpactCard({ ticketId }) {
  const { vulnId } = useVulnDialogContext();
  const { pteamId, serviceId, packageId } = usePageParams();

  const { defaultSafetyImpact } = useGetDefaultSafetyImpact(pteamId, serviceId);

  const {
    tickets = [],
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const selectedTicket = tickets.find((t) => t.ticket_id === ticketId);
  const safetyImpact = selectedTicket?.ticket_safety_impact || null;
  const safetyImpactChangeReason = selectedTicket?.ticket_safety_impact_change_reason || "";

  const [pendingReasonSafetyImpact, setPendingReasonSafetyImpact] = useState("");
  const [reasonAccordionExpanded, setReasonAccordionExpanded] = useState(false);

  const { enqueueSnackbar } = useSnackbar();
  const [updateTicket, { isLoading: isUpdatingTicket }] = useUpdateTicketMutation();

  // Initialize pending reason when ticket changes
  useEffect(() => {
    if (selectedTicket) {
      setPendingReasonSafetyImpact(safetyImpactChangeReason);
      setReasonAccordionExpanded(false);
    }
  }, [selectedTicket, safetyImpactChangeReason]);

  if (ticketsIsLoading) {
    return (
      <Grid size={{ xs: 12 }}>
        <Box sx={{ display: "flex", justifyContent: "center", py: 2 }}>
          <CircularProgress size={24} />
        </Box>
      </Grid>
    );
  }

  if (ticketsError) {
    return (
      <Grid size={{ xs: 12 }}>
        <Alert severity="error">Failed to load ticket data.</Alert>
      </Grid>
    );
  }

  const handleSafetyImpactChange = async (event) => {
    const newValue = event.target.value;

    const requestData = {
      ticket_safety_impact: newValue === "default" ? null : newValue,
    };

    await updateTicket({
      path: { pteam_id: pteamId, ticket_id: ticketId },
      body: requestData,
    })
      .unwrap()
      .then(() => {
        enqueueSnackbar("Change safety impact succeeded", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      );
  };

  const handleReasonSafetyImpactLengthCheck = (string) => {
    if (countFullWidthAndHalfWidthCharacters(string.trim()) > maxReasonSafetyImpactLengthInHalf) {
      enqueueSnackbar(
        `Too long ticket_safety_impact_change_reason. Max length is ${maxReasonSafetyImpactLengthInHalf} in half-width or ${Math.floor(maxReasonSafetyImpactLengthInHalf / 2)} in full-width`,
        { variant: "error" },
      );
    } else {
      setPendingReasonSafetyImpact(string);
    }
  };

  const handleSaveSafetyImpact = async () => {
    const requestData = {
      ticket_safety_impact_change_reason:
        pendingReasonSafetyImpact === "" ? null : pendingReasonSafetyImpact,
    };
    await updateTicket({
      path: { pteam_id: pteamId, ticket_id: ticketId },
      body: requestData,
    })
      .unwrap()
      .then(() => {
        enqueueSnackbar("Change safety impact reason succeeded", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      );
  };

  const isSaveDisabled = safetyImpactChangeReason === pendingReasonSafetyImpact;

  return (
    <>
      <Grid size={{ xs: 12 }}>
        <FormControl fullWidth size="small">
          <InputLabel>{isUpdatingTicket ? "Updating..." : "Safety Impact"}</InputLabel>
          <Select
            value={safetyImpact || "default"}
            label={isUpdatingTicket ? "Updating..." : "Safety Impact"}
            onChange={handleSafetyImpactChange}
            disabled={isUpdatingTicket}
          >
            <MenuItem value="default">
              <Stack direction="row" alignItems="center" spacing={1}>
                <HealthAndSafety fontSize="small" color="action" />
                <Typography variant="body2" fontStyle="italic">
                  Use Default ({defaultSafetyImpact.toUpperCase()})
                </Typography>
              </Stack>
            </MenuItem>
            <Divider />
            <MenuItem value="catastrophic">Catastrophic</MenuItem>
            <MenuItem value="critical">Critical</MenuItem>
            <MenuItem value="marginal">Marginal</MenuItem>
            <MenuItem value="negligible">Negligible</MenuItem>
          </Select>
        </FormControl>
      </Grid>
      <Grid size={{ xs: 12 }}>
        <Accordion
          disableGutters
          elevation={0}
          expanded={reasonAccordionExpanded}
          onChange={(e, isExpanded) => setReasonAccordionExpanded(isExpanded)}
          sx={{ border: 1, borderRadius: 1, borderColor: grey[300] }}
        >
          <AccordionSummary
            expandIcon={<ExpandMore />}
            sx={{ minHeight: 40, "& .MuiAccordionSummary-content": { my: 1 } }}
          >
            <Stack direction="row" spacing={1} sx={{ alignItems: "center" }}>
              <Notes fontSize="small" color="action" />
              <Typography variant="body2" color="text.secondary">
                Reason for Safety Impact Change
              </Typography>
              {safetyImpactChangeReason ? (
                <CheckCircle fontSize="small" color="success" />
              ) : (
                <Typography variant="caption" color="text.disabled" fontStyle="italic">
                  (Not provided)
                </Typography>
              )}
            </Stack>
          </AccordionSummary>
          <AccordionDetails sx={{ p: 2, pt: 0 }}>
            <Box
              sx={{
                display: "flex",
                flexDirection: "column",
                gap: 1,
                alignItems: "flex-end",
              }}
            >
              <TextField
                fullWidth
                multiline
                rows={3}
                placeholder="Enter the reason for changing Safety Impact..."
                variant="outlined"
                size="small"
                value={pendingReasonSafetyImpact || safetyImpactChangeReason}
                onChange={(e) => handleReasonSafetyImpactLengthCheck(e.target.value)}
                disabled={isUpdatingTicket}
                slotProps={{
                  input: {
                    "aria-label": "Enter the reason for changing Safety Impact...",
                  },
                }}
              />
              <Button
                variant="contained"
                size="small"
                startIcon={<Save />}
                sx={{ mt: 0.5 }}
                onClick={handleSaveSafetyImpact}
                disabled={isUpdatingTicket || isSaveDisabled}
              >
                {isUpdatingTicket ? "Saving..." : "Save Reason"}
              </Button>
            </Box>
          </AccordionDetails>
        </Accordion>
      </Grid>
    </>
  );
}

SafetyImpactCard.propTypes = {
  ticketId: PropTypes.string.isRequired,
};
