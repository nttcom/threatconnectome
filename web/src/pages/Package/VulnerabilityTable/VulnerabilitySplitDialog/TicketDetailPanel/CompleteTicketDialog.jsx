import { Close as CloseIcon } from "@mui/icons-material";
import {
  Box,
  Button,
  CircularProgress,
  Dialog,
  DialogContent,
  DialogTitle,
  IconButton,
  MenuItem,
  TextField,
  Typography,
} from "@mui/material";
import { grey } from "@mui/material/colors";
import { useSnackbar } from "notistack";
import PropTypes from "prop-types";
import { useState } from "react";

import { ActionTypeIcon } from "../../../../../components/ActionTypeIcon";
import dialogStyle from "../../../../../cssModule/dialog.module.css";
import { usePageParams } from "../../../../../hooks/usePageParams";
import {
  useCreateActionLogMutation,
  useUpdateTicketMutation,
  useGetUserMeQuery,
  useGetVulnQuery,
} from "../../../../../services/tcApi";
import { errorToString } from "../../../../../utils/func";
import { createUpdateAction, findMatchedVulnPackage } from "../../../../../utils/vulnUtils";
import { useVulnDialogContext } from "../../VulnDialogContext";
import {
  useGetTickets,
  useGetDependency,
} from "../../../../../hooks/Package/useApiForVulnerabilityTable.js";

export function CompleteTicketDialog(props) {
  const { ticketId, onClose, show } = props;

  const { pteamId, serviceId, packageId } = usePageParams();
  const { vulnId } = useVulnDialogContext();

  const [note, setNote] = useState("");
  const [selectedUpdateAction, setSelectedUpdateAction] = useState([]);
  const [activeStep, setActiveStep] = useState(0);

  const { enqueueSnackbar } = useSnackbar();
  const [createActionLog, { isLoading: isCreatingActionLog }] = useCreateActionLogMutation();
  const [updateTicket, { isLoading: isUpdatingTicket }] = useUpdateTicketMutation();

  // Get user info
  const { data: userMe, isLoading: isLoadingUserMe } = useGetUserMeQuery();

  // Get ticket info
  const { tickets = [], isLoading: isLoadingTickets } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });
  const selectedTicket = tickets.find((t) => t.ticket_id === ticketId);
  const dependencyId = selectedTicket?.dependency_id;

  // Get dependency info
  const { data: dependency, isLoading: isLoadingDependency } = useGetDependency({
    pteamId,
    dependencyId,
  });

  // Get vulnerability info
  const { data: vuln, isLoading: isLoadingVuln } = useGetVulnQuery({ path: { vuln_id: vulnId } });

  // Loading state
  const isLoading = isLoadingUserMe || isLoadingTickets || isLoadingDependency || isLoadingVuln;
  const isSubmitting = isCreatingActionLog || isUpdatingTicket;

  // Generate updateAction
  let updateAction = null;
  if (dependency && vuln?.vulnerable_packages) {
    const currentPackage = {
      package_name: dependency.package_name,
      package_source_name: dependency.package_source_name,
      vuln_matching_ecosystem: dependency.vuln_matching_ecosystem,
    };
    const vulnerablePackage = findMatchedVulnPackage(vuln.vulnerable_packages, currentPackage);
    if (vulnerablePackage) {
      updateAction = createUpdateAction(
        vulnerablePackage.affected_versions,
        vulnerablePackage.fixed_versions,
        vulnerablePackage.affected_name,
      );
    }
  }

  const handleClose = () => {
    setNote("");
    setSelectedUpdateAction([]);
    setActiveStep(0);
    onClose();
  };

  const handleSelectUpdateAction = (action) => {
    if (selectedUpdateAction.includes(action)) {
      setSelectedUpdateAction(selectedUpdateAction.filter((a) => a !== action));
    } else {
      setSelectedUpdateAction([...selectedUpdateAction, action]);
    }
  };

  const handleNext = () => {
    setActiveStep(1);
  };

  const handleBack = () => {
    setActiveStep(0);
  };

  const handleSubmit = async () => {
    // Create ActionLog
    await createActionLog({
      body: {
        action: updateAction,
        pteam_id: pteamId,
        service_id: serviceId,
        ticket_id: ticketId,
        vuln_id: vulnId,
        user_id: userMe?.user_id,
      },
    })
      .unwrap()
      .then((actionLog) => {
        enqueueSnackbar("Action succeeded", { variant: "success" });
        return actionLog;
      })
      .then(async (actionLog) => {
        // Update ticket to completed
        await updateTicket({
          path: { pteam_id: pteamId, ticket_id: ticketId },
          body: {
            ticket_status: {
              ticket_handling_status: "completed",
              logging_ids: [actionLog.logging_id],
              note: note.trim() || null,
              scheduled_at: null,
            },
          },
        }).unwrap();
      })
      .then(() => {
        handleClose();
        enqueueSnackbar("Ticket completed successfully", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      );
  };

  return (
    <Dialog open={show} onClose={handleClose} fullWidth maxWidth="sm">
      <DialogTitle>
        <Box alignItems="center" display="flex" flexDirection="row">
          <Typography flexGrow={1} className={dialogStyle.dialog_title}>
            {activeStep === 0
              ? "Select the actions you have completed"
              : "(Optional): Enter evidence of completion"}
          </Typography>
          <IconButton onClick={handleClose}>
            <CloseIcon />
          </IconButton>
        </Box>
      </DialogTitle>
      <DialogContent>
        {isLoading ? (
          <Box display="flex" justifyContent="center" alignItems="center" sx={{ py: 4 }}>
            <CircularProgress size={32} />
          </Box>
        ) : activeStep === 0 ? (
          <>
            {updateAction === null ? (
              <Box display="flex" flexDirection="row" alignItems="center" sx={{ color: grey[500] }}>
                <Typography variant="body2">No action available</Typography>
              </Box>
            ) : (
              <MenuItem
                onClick={() => handleSelectUpdateAction(updateAction)}
                selected={selectedUpdateAction.includes(updateAction)}
                sx={{
                  alignItems: "center",
                  display: "flex",
                  flexDirection: "row",
                }}
              >
                <ActionTypeIcon />
                <Box display="flex" flexDirection="column" sx={{ ml: 1 }}>
                  <Typography noWrap variant="body2" sx={{ maxWidth: 400 }}>
                    {updateAction}
                  </Typography>
                </Box>
              </MenuItem>
            )}
          </>
        ) : (
          <>
            <Box alignItems="center" display="flex" flexDirection="row" mb={1}>
              <Box display="flex" flexDirection="column">
                <Typography variant="body2">{updateAction}</Typography>
              </Box>
            </Box>
            <TextField
              fullWidth
              multiline
              rows={3}
              onChange={(event) => setNote(event.target.value)}
              placeholder="Evidence that you have completed the action, such as a report URL, event logs, file hashes, etc."
              variant="outlined"
              value={note}
            />
          </>
        )}
        <Box sx={{ display: "flex", flexDirection: "row", pt: 2 }}>
          {activeStep === 0 ? (
            <>
              <Box sx={{ flex: "1 1 auto" }} />
              <Button
                onClick={handleNext}
                variant="contained"
                disabled={selectedUpdateAction.length === 0}
              >
                {`Done ${selectedUpdateAction.length}`}
              </Button>
            </>
          ) : (
            <>
              <Button onClick={handleBack} disabled={isSubmitting} sx={{ ml: -1 }}>
                Back
              </Button>
              <Box sx={{ flex: "1 1 auto" }} />
              <Button onClick={handleSubmit} variant="contained" disabled={isSubmitting}>
                {isSubmitting ? "Submitting..." : "Submit"}
              </Button>
            </>
          )}
        </Box>
      </DialogContent>
    </Dialog>
  );
}

CompleteTicketDialog.propTypes = {
  ticketId: PropTypes.string.isRequired,
  onClose: PropTypes.func.isRequired,
  show: PropTypes.bool.isRequired,
};
