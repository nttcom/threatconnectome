import { Inventory2, Timeline } from "@mui/icons-material";
import { Box, Chip, Stack, Typography } from "@mui/material";
import PropTypes from "prop-types";
import { useTranslation } from "react-i18next";

import { useVulnDialogContext } from "../../../../../components/VulnDialogContext";
import {
  useGetTickets,
  useGetDependency,
} from "../../../../../hooks/Package/useApiForVulnerabilityTable.js";
import { usePageParams } from "../../../../../hooks/usePageParams";
import { getSsvcPriorityProps, getSsvcColor } from "../../../../../utils/ssvcUtils";

export function TicketHeader({ ticketId }) {
  const { t } = useTranslation("package", {
    keyPrefix: "VulnerabilityTable.VulnerabilitySplitDialog.TicketDetailPanel.TicketHeader",
  });
  const { vulnId } = useVulnDialogContext();
  const { pteamId, serviceId, packageId } = usePageParams();

  const {
    tickets = [],
    isLoading: ticketsIsLoading,
    error: ticketsError,
  } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const selectedTicket =
    ticketsIsLoading || ticketsError ? [] : tickets.find((t) => t.ticket_id === ticketId);

  const {
    data: dependency,
    isLoading: dependencyIsLoading,
    error: dependencyError,
  } = useGetDependency({
    pteamId,
    dependencyId: selectedTicket?.dependency_id,
  });

  const isLoading = ticketsIsLoading || dependencyIsLoading;
  const error = ticketsError || dependencyError;

  const ssvc = getSsvcPriorityProps()[selectedTicket?.ssvc_deployer_priority]?.displayName ?? "-";
  const target = isLoading
    ? t("loading")
    : error
      ? t("errorLoadingTarget")
      : dependency?.target || t("unknownTarget");
  const packageManager = dependency?.package_manager || "-";

  return (
    <Box>
      <Stack direction="row" alignItems="flex-start" spacing={1}>
        <Box>
          <Box>
            <Box mb={1}>
              <Chip label={`SSVC: ${ssvc}`} color={getSsvcColor(ssvc)} icon={<Timeline />} />
            </Box>
            <Box sx={{ mb: 1 }}>
              <Typography
                variant="caption"
                color="text.secondary"
                gutterBottom
                sx={{ display: "block" }}
              >
                {t("targetFile")}
              </Typography>
              <Typography
                variant="h6"
                component="h1"
                sx={{ fontWeight: "bold", wordBreak: "break-all", lineHeight: 1.3 }}
              >
                {target}
              </Typography>
            </Box>
            <Box>
              <Typography
                variant="caption"
                color="text.secondary"
                gutterBottom
                sx={{ display: "block" }}
              >
                {t("packageManager")}
              </Typography>
              <Stack direction="row" spacing={1} sx={{ alignItems: "center" }}>
                <Inventory2 fontSize="small" />
                <Typography variant="body2">{packageManager}</Typography>
              </Stack>
            </Box>
          </Box>
        </Box>
      </Stack>
    </Box>
  );
}

TicketHeader.propTypes = {
  ticketId: PropTypes.string.isRequired,
};
