import {
  CalendarToday,
  CheckCircleOutline,
  Event,
  NotificationsActive,
  Settings,
  Visibility,
} from "@mui/icons-material";
import {
  Box,
  Card,
  CardContent,
  CardHeader,
  Divider,
  FormControl,
  Grid,
  InputLabel,
  MenuItem,
  Select,
  Stack,
  Typography,
} from "@mui/material";
import { grey } from "@mui/material/colors";
import { useSnackbar } from "notistack";
import PropTypes from "prop-types";
import { useState } from "react";

import { usePageParams } from "../../../../../hooks/usePageParams";
import { useUpdateTicketMutation } from "../../../../../services/tcApi";
import { errorToString, utcStringToLocalDate } from "../../../../../utils/func";
import { useVulnDialog } from "../../VulnDialogContext";
import { useVulnTableRowTickets } from "../../api";

import { AssigneesSelector } from "./AssigneesSelector";
import { CompleteTicketDialog } from "./CompleteTicketDialog";
import { SafetyImpactCard } from "./SafetyImpactCard";
import { ScheduleTicketDialog } from "./ScheduleTicketDialog";

const STATUS_OPTIONS = [
  { value: "alerted", icon: NotificationsActive, color: "error", label: "Alerted" },
  { value: "acknowledged", icon: Visibility, color: "primary", label: "Acknowledged" },
  { value: "scheduled", icon: Event, color: "info", label: "Scheduled" },
  { value: "completed", icon: CheckCircleOutline, color: "success", label: "Completed" },
];

export function StatusManagementCard({ ticketId }) {
  const { vulnId } = useVulnDialog();
  const { pteamId, serviceId, packageId } = usePageParams();
  const { enqueueSnackbar } = useSnackbar();

  const [datepickerOpen, setDatepickerOpen] = useState(false);
  const [schedule, setSchedule] = useState(null);
  const [completeDialogOpen, setCompleteDialogOpen] = useState(false);

  const [updateTicket, { isLoading: isUpdatingTicket }] = useUpdateTicketMutation();

  const { tickets = [] } = useVulnTableRowTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const selectedTicket = tickets.find((t) => t.ticket_id === ticketId);
  const status = selectedTicket?.ticket_status.ticket_handling_status || "alerted";

  const modifyTicketStatus = async (selectedStatus) => {
    let requestParams = { ticket_handling_status: selectedStatus };
    if (selectedStatus === "scheduled") {
      if (!schedule) return;
      requestParams["scheduled_at"] = schedule.toISOString();
    } else if (selectedStatus === "acknowledged") {
      requestParams["scheduled_at"] = null;
    }
    await updateTicket({
      path: { pteam_id: pteamId, ticket_id: ticketId },
      body: { ticket_status: { ...requestParams } },
    })
      .unwrap()
      .then(() => {
        enqueueSnackbar("Change ticket status succeeded", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      );
  };

  const handleStatusChange = async (event) => {
    const selectedStatus = event.target.value;
    switch (selectedStatus) {
      case "completed":
        setCompleteDialogOpen(true);
        return;
      case "scheduled":
        setDatepickerOpen(true);
        return;
      default:
        break;
    }
    modifyTicketStatus(selectedStatus);
  };

  const handleUpdateSchedule = async () => {
    await modifyTicketStatus("scheduled");
    setDatepickerOpen(false);
  };

  const handleHideDatepicker = () => {
    setDatepickerOpen(false);
  };

  return (
    <Card sx={{ boxShadow: 1 }}>
      <CardHeader
        title={
          <Stack direction="row" spacing={1} sx={{ alignItems: "center" }}>
            <Settings />
            <Typography variant="h6">Ticket Management & Status</Typography>
          </Stack>
        }
        sx={{
          bgcolor: grey[50],
          borderBottom: 1,
          borderColor: grey[200],
          py: 1.5,
          position: "sticky",
          top: 0,
          zIndex: 5,
        }}
      />
      <CardContent>
        <Grid container spacing={3} sx={{ alignItems: "center" }}>
          <Grid size={{ xs: 12 }}>
            <FormControl fullWidth size="small">
              <InputLabel>{isUpdatingTicket ? "Updating..." : "Status"}</InputLabel>
              <Select
                value={status}
                label={isUpdatingTicket ? "Updating..." : "Status"}
                onChange={handleStatusChange}
                disabled={isUpdatingTicket}
                renderValue={(value) => {
                  const option = STATUS_OPTIONS.find((o) => o.value === value);
                  if (!option) return value;
                  return (
                    <Stack direction="row" spacing={1} sx={{ alignItems: "center" }}>
                      <option.icon fontSize="small" color={option.color} />
                      <span>{option.label}</span>
                    </Stack>
                  );
                }}
              >
                {STATUS_OPTIONS.filter((option) => option.value !== "alerted").map((option) => (
                  <MenuItem
                    key={option.value}
                    value={option.value}
                    disabled={option.value === status}
                  >
                    <Stack direction="row" spacing={1} sx={{ alignItems: "center" }}>
                      <option.icon fontSize="small" color={option.color} />
                      <span>{option.label}</span>
                    </Stack>
                  </MenuItem>
                ))}
              </Select>
            </FormControl>
          </Grid>
          <Grid size={{ xs: 12 }}>
            <AssigneesSelector
              ticketId={ticketId}
              currentAssigneeIds={selectedTicket?.ticket_status?.assignees || []}
            />
          </Grid>
          <Grid size={{ xs: 12 }}>
            <Divider />
          </Grid>
          <SafetyImpactCard ticketId={ticketId} />
          <Grid size={{ xs: 12 }}>
            <Divider />
          </Grid>
          <Grid size={{ xs: 12 }}>
            <Stack direction="row" spacing={1} alignItems="center">
              <CalendarToday fontSize="small" color="action" />
              <Box>
                <Typography variant="caption" color="text.secondary" sx={{ display: "block" }}>
                  Due date
                </Typography>
                <Typography variant="body2">
                  {utcStringToLocalDate(selectedTicket?.ticket_status?.scheduled_at, false) || "-"}
                </Typography>
              </Box>
            </Stack>
          </Grid>
        </Grid>
      </CardContent>
      <CompleteTicketDialog
        ticketId={ticketId}
        onClose={() => setCompleteDialogOpen(false)}
        show={completeDialogOpen}
      />
      <ScheduleTicketDialog
        open={datepickerOpen}
        schedule={schedule}
        onClose={handleHideDatepicker}
        onSchedule={handleUpdateSchedule}
        onScheduleChange={setSchedule}
        isLoading={isUpdatingTicket}
      />
    </Card>
  );
}

StatusManagementCard.propTypes = {
  ticketId: PropTypes.string.isRequired,
};
