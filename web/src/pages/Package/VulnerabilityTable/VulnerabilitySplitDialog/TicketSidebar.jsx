import { Info, KeyboardArrowRight } from "@mui/icons-material";
import { Box, Button } from "@mui/material";
import { amber, blue, green, grey, orange } from "@mui/material/colors";
import PropTypes from "prop-types";
import React, { useMemo } from "react";

import { usePageParams } from "../../../../hooks/usePageParams";
import { useVulnTableRowTickets, useVulnTableRowDependencies } from "../api";

import { TicketListSection } from "./TicketListSection";

export function TicketSidebar({
  vulnId,
  selectedTicketId,
  onSelect,
  onShowInfo,
  mobileView,
  isMobile,
}) {
  const { pteamId, serviceId, packageId } = usePageParams();
  const { tickets = [] } = useVulnTableRowTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });
  const { dependencies = [] } = useVulnTableRowDependencies({ pteamId, serviceId, packageId });

  const dependencyMap = useMemo(() => {
    return dependencies.reduce((map, dep) => {
      map[dep.dependency_id] = dep;
      return map;
    }, {});
  }, [dependencies]);

  const allTickets = useMemo(() => {
    return tickets.map((ticket) => {
      const dependency = dependencyMap[ticket.dependency_id] || {};
      return {
        id: ticket.ticket_id,
        target: dependency.target || "Unknown Target",
        status: ticket.ticket_status.ticket_handling_status || "alerted",
        assignee: ticket.ticket_status.assignees?.[0] || "未割当",
        deadline: ticket.ticket_status.scheduled_at,
        ssvc: ticket.ssvc_deployer_priority,
        safetyImpact: ticket.ticket_status.current_safety_impact || "-",
        packageManager: dependency.package_manager || "-",
      };
    });
  }, [tickets, dependencyMap]);

  const todoTickets = allTickets.filter((ticket) => ticket.status === "alerted");
  const inProgressTickets = allTickets.filter((ticket) => {
    const status = ticket.status;
    return status === "acknowledged" || status === "scheduled";
  });
  const doneTickets = allTickets.filter((ticket) => ticket.status === "completed");

  const activeSelectedId = isMobile && mobileView === "list" ? null : selectedTicketId;

  const sections = [
    { title: "Todo", tickets: todoTickets, headerColor: grey[300], defaultExpanded: true },
    {
      title: "In Progress",
      tickets: inProgressTickets,
      headerColor: blue[50],
      defaultExpanded: true,
    },
    { title: "Done", tickets: doneTickets, headerColor: green[50], defaultExpanded: false },
  ];
  return (
    <>
      {isMobile && (
        <Box sx={{ p: 2, bgcolor: orange[50], borderBottom: 1, borderColor: orange[200] }}>
          <Button
            fullWidth
            variant="outlined"
            color="warning"
            startIcon={<Info />}
            endIcon={<KeyboardArrowRight />}
            onClick={onShowInfo}
            sx={{
              justifyContent: "space-between",
              fontWeight: "bold",
              borderColor: orange[200],
              "&:hover": {
                bgcolor: amber[50],
                borderColor: orange[300],
              },
            }}
          >
            Check Vulnerability Details
          </Button>
        </Box>
      )}

      {sections.map((section) => (
        <React.Fragment key={section.title}>
          <TicketListSection
            title={section.title}
            tickets={section.tickets}
            selectedId={activeSelectedId}
            onSelect={onSelect}
            headerColor={section.headerColor}
            defaultExpanded={section.defaultExpanded}
          />
        </React.Fragment>
      ))}
    </>
  );
}

TicketSidebar.propTypes = {
  vulnId: PropTypes.string.isRequired,
  selectedTicketId: PropTypes.string,
  onSelect: PropTypes.func.isRequired,
  onShowInfo: PropTypes.func.isRequired,
  mobileView: PropTypes.string,
  isMobile: PropTypes.bool.isRequired,
};
