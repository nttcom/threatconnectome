import { Info, KeyboardArrowRight } from "@mui/icons-material";
import { Box, Button } from "@mui/material";
import { amber, blue, green, grey, orange } from "@mui/material/colors";
import PropTypes from "prop-types";
import React, { useMemo } from "react";

import { TicketListSection } from "./TicketListSection";
import { useTicketsWithDetails } from "./useTicketsWithDetails";

export function TicketSidebar({
  vulnId,
  selectedTicketId,
  onSelect,
  onShowInfo,
  mobileView,
  isMobile,
}) {
  const tickets = useTicketsWithDetails(vulnId);

  const todoTickets = useMemo(() => {
    return tickets.filter((ticket) => ticket.status === "alerted");
  }, [tickets]);

  const inProgressTickets = useMemo(() => {
    return tickets.filter((ticket) => {
      const status = ticket.status;
      return status === "acknowledged" || status === "scheduled";
    });
  }, [tickets]);

  const doneTickets = useMemo(() => {
    return tickets.filter((ticket) => ticket.status === "completed");
  }, [tickets]);

  const activeSelectedId = isMobile && mobileView === "list" ? null : selectedTicketId;

  const sections = [
    { title: "Todo", tickets: todoTickets, headerColor: grey[300], defaultExpanded: true },
    {
      title: "In Progress",
      tickets: inProgressTickets,
      headerColor: blue[50],
      defaultExpanded: true,
    },
    { title: "Done", tickets: doneTickets, headerColor: green[50], defaultExpanded: false },
  ];
  return (
    <>
      {isMobile && (
        <Box sx={{ p: 2, bgcolor: orange[50], borderBottom: 1, borderColor: orange[200] }}>
          <Button
            fullWidth
            variant="outlined"
            color="warning"
            startIcon={<Info />}
            endIcon={<KeyboardArrowRight />}
            onClick={onShowInfo}
            sx={{
              justifyContent: "space-between",
              fontWeight: "bold",
              borderColor: orange[200],
              "&:hover": {
                bgcolor: amber[50],
                borderColor: orange[300],
              },
            }}
          >
            Check Vulnerability Details
          </Button>
        </Box>
      )}

      {sections.map((section) => (
        <React.Fragment key={section.title}>
          <TicketListSection
            title={section.title}
            tickets={section.tickets}
            selectedId={activeSelectedId}
            onSelect={onSelect}
            headerColor={section.headerColor}
            defaultExpanded={section.defaultExpanded}
          />
        </React.Fragment>
      ))}
    </>
  );
}

TicketSidebar.propTypes = {
  vulnId: PropTypes.string.isRequired,
  selectedTicketId: PropTypes.string,
  onSelect: PropTypes.func.isRequired,
  onShowInfo: PropTypes.func.isRequired,
  mobileView: PropTypes.string,
  isMobile: PropTypes.bool.isRequired,
};
