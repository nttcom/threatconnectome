import { ExpandMore } from "@mui/icons-material";
import { Accordion, AccordionDetails, AccordionSummary, List, Typography } from "@mui/material";
import { blue, green, grey } from "@mui/material/colors";
import PropTypes from "prop-types";

import { usePageParams } from "../../../../../hooks/usePageParams";
import { useVulnDialogContext } from "../../VulnDialogContext";
import { useGetTickets } from "../../api";

import { TicketListItem } from "./TicketListItem";

const SECTION_CONFIG = {
  alerted: {
    title: "Todo",
    headerColor: grey[300],
    defaultExpanded: true,
  },
  "in-progress": {
    title: "In Progress",
    headerColor: blue[50],
    defaultExpanded: true,
  },
  completed: {
    title: "Done",
    headerColor: green[50],
    defaultExpanded: false,
  },
};

export function TicketListSection({ statusFilter, selectedId, onSelect }) {
  const { vulnId } = useVulnDialogContext();
  const { title, headerColor, defaultExpanded } = SECTION_CONFIG[statusFilter];
  const { pteamId, serviceId, packageId } = usePageParams();
  const {
    tickets: rawTickets = [],
    isLoading: ticketsLoading,
    error: ticketsError,
  } = useGetTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const tickets = ticketsLoading
    ? []
    : rawTickets.filter((ticket) => {
        const status = ticket.ticket_status.ticket_handling_status || "alerted";
        if (statusFilter === "alerted") return status === "alerted";
        if (statusFilter === "in-progress")
          return status === "acknowledged" || status === "scheduled";
        if (statusFilter === "completed") return status === "completed";
        return false;
      });

  return (
    <Accordion
      defaultExpanded={defaultExpanded}
      disableGutters
      elevation={0}
      square
      sx={{ "&:before": { display: "none" } }}
    >
      <AccordionSummary
        expandIcon={<ExpandMore />}
        sx={{
          bgcolor: headerColor,
          flexDirection: "row-reverse",
          "& .MuiAccordionSummary-expandIconWrapper.Mui-expanded": { transform: "rotate(90deg)" },
          "& .MuiAccordionSummary-content": { marginLeft: 1 },
          minHeight: 48,
        }}
      >
        <Typography variant="subtitle2" color="text.secondary" sx={{ fontWeight: "bold" }}>
          {title} ({tickets.length})
        </Typography>
      </AccordionSummary>

      <AccordionDetails sx={{ p: 0 }}>
        {ticketsError ? (
          <Typography variant="body2" color="error" sx={{ p: 2 }}>
            Failed to load tickets
          </Typography>
        ) : (
          <List disablePadding>
            {tickets.map((ticket) => (
              <TicketListItem
                key={ticket.ticket_id}
                ticket={ticket}
                isSelected={selectedId === ticket.ticket_id}
                onSelect={onSelect}
              />
            ))}
          </List>
        )}
      </AccordionDetails>
    </Accordion>
  );
}

TicketListSection.propTypes = {
  statusFilter: PropTypes.oneOf(["alerted", "in-progress", "completed"]).isRequired,
  selectedId: PropTypes.string,
  onSelect: PropTypes.func.isRequired,
};
