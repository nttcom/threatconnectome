import { useMemo } from "react";

import { usePageParams } from "../../../../hooks/usePageParams";
import { useVulnTableRowTickets, useVulnTableRowDependency } from "../api";

export function useTicketsWithDetails(vulnId) {
  const { pteamId, serviceId, packageId } = usePageParams();

  const { tickets = [] } = useVulnTableRowTickets({ pteamId, serviceId, vulnId, packageId });
  const { serviceDependency } = useVulnTableRowDependency({ pteamId, serviceId, packageId });

  const ticketsWithDetails = useMemo(() => {
    return tickets.map((ticket) => ({
      id: ticket.ticket_id,
      target: serviceDependency?.target || "Unknown Target",
      status: ticket.ticket_status.ticket_handling_status || "alerted",
      assignee: ticket.ticket_status.assignees?.[0] || "未割当",
      deadline: ticket.ticket_status.scheduled_at,
      ssvc: ticket.ssvc_deployer_priority,
      safetyImpact: ticket.ticket_status.current_safety_impact || "-",
      packageManager: serviceDependency?.package_manager || "-",
      ticket: ticket,
    }));
  }, [tickets, serviceDependency]);

  return ticketsWithDetails;
}
