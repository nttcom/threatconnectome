import CheckIcon from "@mui/icons-material/Check";
import CloseIcon from "@mui/icons-material/Close";
import SearchIcon from "@mui/icons-material/Search";
import {
  Box,
  Divider,
  IconButton,
  InputAdornment,
  List,
  ListItem,
  ListItemButton,
  ListItemText,
  Paper,
  Stack,
  TextField,
  Typography,
} from "@mui/material";
import { useSnackbar } from "notistack";
import PropTypes from "prop-types";
import { useEffect, useState } from "react";

import { usePageParams } from "../../../../hooks/usePageParams";
import { useUpdateTicketMutation } from "../../../../services/tcApi";
import { errorToString, setEquals } from "../../../../utils/func";
import { usePersonnelSelectorMembers } from "../api";

export function PersonnelSelector({ ticketId, currentAssigneeIds }) {
  const { pteamId } = usePageParams();
  const {
    data: members,
    error: membersError,
    isLoading: membersIsLoading,
  } = usePersonnelSelectorMembers(pteamId);

  const [assigneeUserIds, setAssigneeUserIds] = useState([]);
  const [isFocused, setIsFocused] = useState(false);
  const [search, setSearch] = useState("");
  const [isUpdating, setIsUpdating] = useState(false);

  const { enqueueSnackbar } = useSnackbar();
  const [updateTicket] = useUpdateTicketMutation();

  // Initialize assigneeUserIds from currentAssigneeIds
  useEffect(() => {
    if (members && currentAssigneeIds) {
      const userIds = Object.values(members)
        .filter((member) => currentAssigneeIds.includes(member.user_id))
        .map((member) => member.user_id);
      setAssigneeUserIds(userIds);
    }
  }, [members, currentAssigneeIds]);

  const handleApply = async (newAssigneeIds = null) => {
    if (!members || !pteamId || !ticketId) return;

    const idsToApply = newAssigneeIds !== null ? newAssigneeIds : assigneeUserIds;
    const assigneeIdsToSend = Object.values(members)
      .filter((member) => idsToApply.includes(member.user_id))
      .map((member) => member.user_id);

    if (setEquals(new Set(assigneeIdsToSend), new Set(currentAssigneeIds || []))) return; // not modified

    setIsUpdating(true);
    await updateTicket({
      pteamId,
      ticketId,
      data: { ticket_status: { assignees: assigneeIdsToSend } },
    })
      .unwrap()
      .then(() => {
        enqueueSnackbar("Change assignees succeeded", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      )
      .finally(() => {
        setIsUpdating(false);
      });
  };

  const handleRemoveMember = async (userId) => {
    if (isUpdating) return; // Prevent duplicate requests
    const newIds = assigneeUserIds.filter((id) => id !== userId);
    setAssigneeUserIds(newIds);
    // Apply changes immediately with new IDs
    await handleApply(newIds);
  };

  const handleAddMember = async (userId) => {
    if (isUpdating) return; // Prevent duplicate requests
    if (!assigneeUserIds.includes(userId)) {
      const newIds = [...assigneeUserIds, userId].sort();
      setAssigneeUserIds(newIds);
      // Apply changes immediately with new IDs
      await handleApply(newIds);
    }
    setSearch("");
    setIsFocused(false);
  };

  const handleBlur = () => {
    // Just close the dropdown
    setTimeout(() => {
      setIsFocused(false);
    }, 200); // Delay to allow click events to register
  };

  if (!pteamId || !ticketId || !members) return <></>;

  // Filter members based on search (use currentAssigneeIds from API)
  const filteredMembers = Object.values(members).filter((member) => {
    const isNotSelected = !(currentAssigneeIds || []).includes(member.user_id);
    const matchesSearch = member.email.toLowerCase().includes(search.toLowerCase());
    return isNotSelected && matchesSearch;
  });

  // Get selected members from API data (currentAssigneeIds)
  const selectedMembers = Object.values(members).filter((member) =>
    (currentAssigneeIds || []).includes(member.user_id),
  );

  return (
    <Box sx={{ width: "100%", p: 0 }}>
      <Stack direction="row" sx={{ justifyContent: "space-between", alignItems: "center", mb: 1 }}>
        <Typography
          variant="caption"
          sx={{ fontWeight: "bold", color: "text.secondary", textTransform: "uppercase" }}
        >
          Assignees
          {` (${selectedMembers.length})`}
        </Typography>
      </Stack>
      <Paper
        elevation={0}
        variant="outlined"
        sx={{
          position: "relative",
          borderColor: isFocused ? "primary.main" : "divider",
          transition: "border-color 0.2s",
          flexDirection: "column",
        }}
      >
        <Box sx={{ p: 1, bgcolor: "background.paper", flexShrink: 0 }}>
          <TextField
            fullWidth
            variant="standard"
            placeholder={"Search by email"}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onFocus={() => setIsFocused(true)}
            onBlur={handleBlur}
            disabled={
              Object.keys(members || {}).length === assigneeUserIds.length ||
              isUpdating ||
              membersIsLoading
            }
            slotProps={{
              input: {
                "aria-label": "Search by email",
                disableUnderline: true,
                startAdornment: (
                  <InputAdornment>
                    <SearchIcon
                      color={Object.keys(members || {}).length === 0 ? "disabled" : "action"}
                      fontSize="small"
                    />
                  </InputAdornment>
                ),
                sx: { fontSize: "0.875rem" },
              },
            }}
          />
        </Box>
        <Divider />
        <Box
          sx={{
            bgcolor: "action.hover",
            minHeight: 40,
            flexGrow: 1,
            overflowY: "auto",
            maxHeight: 200,
          }}
        >
          {selectedMembers.length === 0 ? (
            <Typography
              variant="body2"
              color="text.secondary"
              sx={{ p: 2, fontStyle: "italic", fontSize: "0.75rem" }}
            >
              No selection
            </Typography>
          ) : (
            <List dense disablePadding>
              {selectedMembers.map((member) => (
                <ListItem
                  key={member.user_id}
                  secondaryAction={
                    <IconButton
                      edge="end"
                      aria-label="delete"
                      size="small"
                      onClick={() => handleRemoveMember(member.user_id)}
                      disabled={isUpdating}
                    >
                      <CloseIcon />
                    </IconButton>
                  }
                  sx={{
                    pl: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                    bgcolor: "background.paper",
                    "&:last-child": { borderBottom: "none" },
                    opacity: isUpdating ? 0.6 : 1,
                  }}
                >
                  <ListItemText
                    primary={
                      <Stack
                        direction="row"
                        spacing={1}
                        sx={{ alignItems: "center", width: "100%" }}
                      >
                        <Typography
                          variant="body2"
                          noWrap
                          sx={{
                            fontWeight: 500,
                            flex: 1,
                            fontSize: { xs: "0.75rem", sm: "0.875rem" },
                          }}
                        >
                          {member.email}
                        </Typography>
                        <CheckIcon color="primary" sx={{ fontSize: 16, flexShrink: 0 }} />
                      </Stack>
                    }
                  />
                </ListItem>
              ))}
            </List>
          )}
        </Box>
        {isFocused && filteredMembers.length > 0 && (
          <Box
            sx={{
              position: "absolute",
              top: "100%",
              left: -1,
              right: -1,
              zIndex: 10,
              maxHeight: 200,
              overflowY: "auto",
              bgcolor: "background.paper",
              boxShadow: 3,
              border: 1,
              borderColor: "divider",
              borderRadius: "0 0 4px 4px",
              mt: "1px",
            }}
            onMouseDown={(e) => e.preventDefault()}
          >
            <List dense disablePadding>
              {filteredMembers.map((member) => (
                <ListItemButton
                  key={member.user_id}
                  onClick={() => handleAddMember(member.user_id)}
                  disabled={isUpdating}
                >
                  <ListItemText
                    primary={member.email}
                    slotProps={{
                      primary: {
                        variant: "body2",
                        noWrap: true,
                        sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                      },
                    }}
                  />
                </ListItemButton>
              ))}
            </List>
          </Box>
        )}
      </Paper>
    </Box>
  );
}

PersonnelSelector.propTypes = {
  ticketId: PropTypes.string.isRequired,
  currentAssigneeIds: PropTypes.array.isRequired,
};
