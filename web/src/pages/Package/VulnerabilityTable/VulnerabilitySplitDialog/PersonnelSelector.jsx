import SearchIcon from "@mui/icons-material/Search";
import { Box, Divider, InputAdornment, Paper, Stack, TextField, Typography } from "@mui/material";
import { useState } from "react";
import { useLocation } from "react-router-dom";

import { useSkipUntilAuthUserIsReady } from "../../../../hooks/auth";
import { useGetPTeamMembersQuery } from "../../../../services/tcApi";

export function PersonnelSelector() {
  const params = new URLSearchParams(useLocation().search);
  const pteamId = params.get("pteamId");
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skipByPTeamId = pteamId === undefined;
  const {
    data: members,
    error: membersError,
    isLoading: membersIsLoading,
  } = useGetPTeamMembersQuery(pteamId, { skip: skipByAuth || skipByPTeamId });
  const [selectedMembers, setSelectedMembers] = useState([]);
  const [isFocused, setIsFocused] = useState(false);
  const [search, setSearch] = useState("");

  return (
    <Box sx={{ width: "100%", p: 0 }}>
      <Stack direction="row" sx={{ justifyContent: "space-between", alignItems: "center", mb: 1 }}>
        <Typography
          variant="caption"
          sx={{ fontWeight: "bold", color: "text.secondary", textTransform: "uppercase" }}
        >
          Assignees
          {`(${Object.keys(members || {}).length})`}
        </Typography>
      </Stack>
      <Paper
        elevation={0}
        variant="outlined"
        sx={{
          position: "relative",
          borderColor: isFocused ? "primary.main" : "divider",
          transition: "border-color 0.2s",
          flexDirection: "column",
        }}
      >
        <Box sx={{ p: 1, bgcolor: "background.paper", flexShrink: 0 }}>
          <TextField
            fullWidth
            variant="standard"
            placeholder={"Search by email"}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onFocus={() => setIsFocused(true)}
            onBlur={() => setIsFocused(false)}
            disabled={Object.keys(members || {}).length === selectedMembers.length}
            slotProps={{
              input: {
                "aria-label": "Search by email",
                disableUnderline: true,
                startAdornment: (
                  <InputAdornment>
                    <SearchIcon
                      color={Object.keys(members || {}).length === 0 ? "disabled" : "action"}
                      fontSize="small"
                    />
                  </InputAdornment>
                ),
                sx: { fontSize: "0.875rem" },
              },
            }}
          />
        </Box>
        <Divider />
        <Box
          sx={{
            bgcolor: "action.hover",
            minHeight: 40,
            flexGrow: 1,
            overflowY: "auto",
            maxHeight: 200,
          }}
        >
          {selectedMembers.length === 0 && (
            <Typography
              variant="body2"
              color="text.secondary"
              sx={{ p: 2, fontStyle: "italic", fontSize: "0.75rem" }}
            >
              No selection
            </Typography>
          )}
        </Box>
      </Paper>
    </Box>
  );
}
