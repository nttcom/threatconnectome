import CheckIcon from "@mui/icons-material/Check";
import CloseIcon from "@mui/icons-material/Close";
import SearchIcon from "@mui/icons-material/Search";
import {
  Box,
  Divider,
  IconButton,
  InputAdornment,
  List,
  ListItem,
  ListItemButton,
  ListItemText,
  Paper,
  Stack,
  TextField,
  Typography,
} from "@mui/material";
import { useState } from "react";
import { useLocation } from "react-router-dom";

import { useSkipUntilAuthUserIsReady } from "../../../../hooks/auth";
import { useGetPTeamMembersQuery } from "../../../../services/tcApi";

export function PersonnelSelector() {
  const params = new URLSearchParams(useLocation().search);
  const pteamId = params.get("pteamId");
  const skipByAuth = useSkipUntilAuthUserIsReady();
  const skipByPTeamId = pteamId === undefined;
  const {
    data: members,
    error: membersError,
    isLoading: membersIsLoading,
  } = useGetPTeamMembersQuery(pteamId, { skip: skipByAuth || skipByPTeamId });
  const [selectedMembers, setSelectedMembers] = useState([]);
  const [isFocused, setIsFocused] = useState(false);
  const [search, setSearch] = useState("");

  return (
    <Box sx={{ width: "100%", p: 0 }}>
      <Stack direction="row" sx={{ justifyContent: "space-between", alignItems: "center", mb: 1 }}>
        <Typography
          variant="caption"
          sx={{ fontWeight: "bold", color: "text.secondary", textTransform: "uppercase" }}
        >
          Assignees
          {`(${Object.keys(members || {}).length})`}
        </Typography>
      </Stack>
      <Paper
        elevation={0}
        variant="outlined"
        sx={{
          position: "relative",
          borderColor: isFocused ? "primary.main" : "divider",
          transition: "border-color 0.2s",
          flexDirection: "column",
        }}
      >
        <Box sx={{ p: 1, bgcolor: "background.paper", flexShrink: 0 }}>
          <TextField
            fullWidth
            variant="standard"
            placeholder={"Search by email"}
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onFocus={() => setIsFocused(true)}
            onBlur={() => setIsFocused(false)}
            disabled={Object.keys(members || {}).length === selectedMembers.length}
            slotProps={{
              input: {
                "aria-label": "Search by email",
                disableUnderline: true,
                startAdornment: (
                  <InputAdornment>
                    <SearchIcon
                      color={Object.keys(members || {}).length === 0 ? "disabled" : "action"}
                      fontSize="small"
                    />
                  </InputAdornment>
                ),
                sx: { fontSize: "0.875rem" },
              },
            }}
          />
        </Box>
        <Divider />
        <Box
          sx={{
            bgcolor: "action.hover",
            minHeight: 40,
            flexGrow: 1,
            overflowY: "auto",
            maxHeight: 200,
          }}
        >
          {/* {selectedMembers.length === 0 && ( */}
          {false ? (
            <Typography
              variant="body2"
              color="text.secondary"
              sx={{ p: 2, fontStyle: "italic", fontSize: "0.75rem" }}
            >
              No selection
            </Typography>
          ) : (
            <List dense disablePadding>
              <ListItem
                secondaryAction={
                  <IconButton edge="end" aria-label="delete" size="small">
                    <CloseIcon />
                  </IconButton>
                }
                sx={{
                  pl: 2,
                  borderBottom: 1,
                  borderColor: "divider",
                  bgcolor: "background.paper",
                  "&:last-child": { borderBottom: "none" },
                }}
              >
                <ListItemText
                  primary={
                    <Stack direction="row" spacing={1} sx={{ alignItems: "center", width: "100%" }}>
                      <Typography
                        variant="body2"
                        noWrap
                        sx={{
                          fontWeight: 500,
                          flex: 1,
                          fontSize: { xs: "0.75rem", sm: "0.875rem" },
                        }}
                      >
                        test@example.com
                      </Typography>
                      <CheckIcon color="primary" sx={{ fontSize: 16, flexShrink: 0 }} />
                    </Stack>
                  }
                />
              </ListItem>
              <ListItem
                secondaryAction={
                  <IconButton edge="end" aria-label="delete" size="small">
                    <CloseIcon />
                  </IconButton>
                }
                sx={{
                  pl: 2,
                  borderBottom: 1,
                  borderColor: "divider",
                  bgcolor: "background.paper",
                  "&:last-child": { borderBottom: "none" },
                }}
              >
                <ListItemText
                  primary={
                    <Stack direction="row" spacing={1} sx={{ alignItems: "center", width: "100%" }}>
                      <Typography
                        variant="body2"
                        noWrap
                        sx={{
                          fontWeight: 500,
                          flex: 1,
                          fontSize: { xs: "0.75rem", sm: "0.875rem" },
                        }}
                      >
                        test2@example.com
                      </Typography>
                      <CheckIcon color="primary" sx={{ fontSize: 16, flexShrink: 0 }} />
                    </Stack>
                  }
                />
              </ListItem>
            </List>
          )}
        </Box>
        {isFocused && (
          <Box
            sx={{
              position: "absolute",
              top: "100%",
              left: -1,
              right: -1,
              zIndex: 10,
              maxHeight: 200,
              overflowY: "auto",
              bgcolor: "background.paper",
              boxShadow: 3,
              border: 1,
              borderColor: "divider",
              borderRadius: "0 0 4px 4px",
              mt: "1px",
            }}
            onMouseDown={(e) => e.preventDefault()}
          >
            <List dense disablePadding>
              <ListItemButton>
                <ListItemText
                  primary={"test1@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test2@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test3@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test4@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test5@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test6@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test7@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test8@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
              <ListItemButton>
                <ListItemText
                  primary={"test9@example.com"}
                  slotProps={{
                    primary: {
                      variant: "body2",
                      noWrap: true,
                      sx: { fontSize: { xs: "0.75rem", sm: "0.875rem" } },
                    },
                  }}
                />
              </ListItemButton>
            </List>
          </Box>
        )}
      </Paper>
    </Box>
  );
}
