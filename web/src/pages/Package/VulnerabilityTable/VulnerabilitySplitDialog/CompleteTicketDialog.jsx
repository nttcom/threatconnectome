import { Close as CloseIcon } from "@mui/icons-material";
import {
  Box,
  Button,
  Dialog,
  DialogContent,
  DialogTitle,
  IconButton,
  TextField,
  Typography,
  MenuItem,
} from "@mui/material";
import { grey } from "@mui/material/colors";
import { useSnackbar } from "notistack";
import PropTypes from "prop-types";
import { useState } from "react";

import { ActionTypeIcon } from "../../../../components/ActionTypeIcon";
import dialogStyle from "../../../../cssModule/dialog.module.css";
import { useSkipUntilAuthUserIsReady } from "../../../../hooks/auth";
import { usePageParams } from "../../../../hooks/usePageParams";
import {
  useCreateActionLogMutation,
  useUpdateTicketMutation,
  useGetUserMeQuery,
} from "../../../../services/tcApi";
import { APIError } from "../../../../utils/APIError";
import { errorToString } from "../../../../utils/func";
import { useVulnTableRowTickets } from "../api";

import { useVulnDialog } from "./VulnDialogContext";

export function CompleteTicketDialog(props) {
  const { ticketId, onClose, show } = props;

  const { pteamId, serviceId, packageId } = usePageParams();
  const { vulnId } = useVulnDialog();

  const [note, setNote] = useState("");
  const [selectedUpdateAction, setSelectedUpdateAction] = useState([]);
  const [activeStep, setActiveStep] = useState(0);
  const [skipped, setSkipped] = useState(new Set());

  const { enqueueSnackbar } = useSnackbar();

  const skip = useSkipUntilAuthUserIsReady();
  const {
    data: userMe,
    error: userMeError,
    isLoading: userMeIsLoading,
  } = useGetUserMeQuery(undefined, { skip });
  const [createActionLog] = useCreateActionLogMutation();
  const [updateTicket] = useUpdateTicketMutation();

  const { tickets = [], isLoading: ticketsLoading } = useVulnTableRowTickets({
    pteamId,
    serviceId,
    vulnId,
    packageId,
  });

  const selectedTicket = tickets.find((t) => t.ticket_id === ticketId);

  if (skip) return <></>;
  if (skip) return <></>;
  if (userMeError) throw new APIError(errorToString(userMeError), { api: "getUserMe" });

  const actionByFixedVersions = selectedTicket?.action_by_fixed_versions || {};
  const vulnActions = selectedTicket?.vuln_actions || [];

  const updateAction =
    Object.keys(actionByFixedVersions).length > 0
      ? Object.values(actionByFixedVersions)[0]
      : vulnActions.length > 0
        ? vulnActions[0]
        : null;

  const handleAction = async () =>
    await createActionLog({
      action: updateAction,
      pteam_id: pteamId,
      service_id: serviceId,
      ticket_id: ticketId,
      vuln_id: vulnId,
      user_id: userMe.user_id,
    })
      .unwrap()
      .then((actionLog) => {
        enqueueSnackbar("Action succeeded", { variant: "success" });
        return actionLog;
      })
      .then(
        async (actionLog) =>
          await updateTicket({
            pteamId,
            ticketId,
            data: {
              ticket_status: {
                ticket_handling_status: "completed",
                logging_ids: [actionLog.logging_id],
                note: note.trim() || null,
                scheduled_at: null, // clear scheduled date
              },
            },
          }).unwrap(),
      )
      .then(() => {
        handleClose();
        setNote("");
        enqueueSnackbar("Set ticketstatus 'completed' succeeded", { variant: "success" });
      })
      .catch((error) =>
        enqueueSnackbar(`Operation failed: ${errorToString(error)}`, { variant: "error" }),
      );

  if (!pteamId || !serviceId || !ticketId || !vulnId) return <></>;

  const handleClose = () => {
    onClose();
  };

  const handleSelectUpdateAction = async (uiId) => {
    if (selectedUpdateAction.includes(uiId))
      selectedUpdateAction.splice(selectedUpdateAction.indexOf(uiId), 1);
    else selectedUpdateAction.push(uiId);
    setSelectedUpdateAction([...selectedUpdateAction]);
  };

  const isStepSkipped = (step) => {
    return skipped.has(step);
  };

  const handleNext = () => {
    let newSkipped = skipped;
    if (isStepSkipped(activeStep)) {
      newSkipped = new Set(newSkipped.values());
      newSkipped.delete(activeStep);
    }
    setActiveStep((prevActiveStep) => prevActiveStep + 1);
    setSkipped(newSkipped);
  };

  const handleBack = () => {
    setActiveStep((prevActiveStep) => prevActiveStep - 1);
  };

  return (
    <Dialog open={show} onClose={handleClose} fullWidth>
      <DialogTitle>
        <Box alignItems="center" display="flex" flexDirection="row">
          {activeStep === 0 && (
            <Typography flexGrow={1} className={dialogStyle.dialog_title}>
              Select the actions you have completed
            </Typography>
          )}
          {activeStep === 1 && (
            <Typography flexGrow={1} className={dialogStyle.dialog_title}>
              (Optional): Enter evidence of completion
            </Typography>
          )}
          <IconButton onClick={handleClose}>
            <CloseIcon />
          </IconButton>
        </Box>
      </DialogTitle>
      <DialogContent>
        {userMeIsLoading ? (
          <Typography variant="body2" color="text.secondary">
            Now loading...
          </Typography>
        ) : (
          <>
            {activeStep === 0 && (
              <>
                {updateAction === null ? (
                  <Box
                    display="flex"
                    flexDirection="row"
                    alignItems="center"
                    sx={{ color: grey[500] }}
                  >
                    <Typography variant="body2">No action</Typography>
                  </Box>
                ) : (
                  <>
                    <MenuItem
                      onClick={() => handleSelectUpdateAction(updateAction)}
                      selected={selectedUpdateAction.includes(updateAction)}
                      sx={{
                        alignItems: "center",
                        display: "flex",
                        flexDirection: "row",
                      }}
                    >
                      <ActionTypeIcon />
                      <Box display="flex" flexDirection="column">
                        <Typography noWrap variant="body" width={400}>
                          {updateAction}
                        </Typography>
                      </Box>
                    </MenuItem>
                  </>
                )}
              </>
            )}
            {activeStep === 1 && (
              <>
                <Box alignItems="center" display="flex" flexDirection="row" mb={1}>
                  <Box display="flex" flexDirection="column">
                    <Typography>{updateAction}</Typography>
                  </Box>
                </Box>
                <TextField
                  fullWidth
                  multiline
                  onChange={(event) => setNote(event.target.value)}
                  placeholder={
                    "Evidence that you have completed the action, such as a report URL, " +
                    "event logs, file hashes, etc."
                  }
                  variant="outlined"
                  value={note}
                />
              </>
            )}
            <Box sx={{ display: "flex", flexDirection: "row", pt: 2 }}>
              {activeStep === 0 ? (
                <>
                  <Box sx={{ flex: "1 1 auto" }} />
                  <Button
                    onClick={handleNext}
                    className={dialogStyle.submit_btn}
                    disabled={selectedUpdateAction.length === 0}
                  >
                    {`Done ${selectedUpdateAction.length}`}
                  </Button>
                </>
              ) : (
                <>
                  <Button
                    onClick={handleBack}
                    className={dialogStyle.submit_btn}
                    disabled={activeStep === 0}
                    sx={{ ml: -2 }}
                  >
                    Back
                  </Button>
                  <Box sx={{ flex: "1 1 auto" }} />
                  <Button onClick={handleAction} className={dialogStyle.submit_btn}>
                    Submit
                  </Button>
                </>
              )}
            </Box>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}

CompleteTicketDialog.propTypes = {
  ticketId: PropTypes.string.isRequired,
  onClose: PropTypes.func.isRequired,
  show: PropTypes.bool.isRequired,
};
