import { ArrowBack, Close, ExpandMore, Warning } from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  Slide,
  ClickAwayListener,
  Typography,
  Chip,
  Paper,
  Button,
  Divider,
} from "@mui/material";
import { grey, orange } from "@mui/material/colors";
import PropTypes from "prop-types";
import { useState, useMemo } from "react";

import { createActionByFixedVersions } from "../../../../utils/vulnUtils";

import { PackageInfoContent } from "./PackageInfoContent";
import { TicketSidebar } from "./TicketSidebar";
import { DetailPanel } from "./components/DetailPanel";
import { ListPanel } from "./components/ListPanel";
import { getCvssColor } from "./utils/utils";

export default function VulnerabilitySplitDialog({
  open,
  onClose,
  vulnData,
  vulnActions = [],
  tickets = [],
  references = [],
}) {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  const [selectedIndex, setSelectedIndex] = useState(-1);
  const [selectedStatus, setSelectedStatus] = useState(null);

  // 緩和策を生成
  const actionsWithUiId = useMemo(() => {
    if (!vulnData?.vulnerable_packages?.[0]) return [];

    const matchedVulnPackage = vulnData.vulnerable_packages[0];
    const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
    const patchedVersions = matchedVulnPackage?.fixed_versions ?? [];
    const actionByFixedVersions = createActionByFixedVersions(
      affectedVersions,
      patchedVersions,
      matchedVulnPackage?.affected_name ?? "",
    );

    const actions = actionByFixedVersions ? [actionByFixedVersions, ...vulnActions] : vulnActions;
    return actions.map((action, index) => ({
      ...action,
      uiId: `action-${index}`,
    }));
  }, [vulnData, vulnActions]);

  // チケットをreferencesと結合して表示用データを生成
  const ticketsWithDetails = useMemo(() => {
    return tickets.map((ticket) => {
      const matchedReference = references.find(
        (reference) => reference.dependency_id === ticket.dependency_id,
      );
      return {
        id: ticket.ticket_id,
        target: matchedReference?.target || "Unknown Target",
        status: ticket.ticket_status.ticket_handling_status || "alerted",
        assignee: ticket.ticket_status.assignees?.[0] || "未割当",
        deadline: ticket.ticket_status.scheduled_at,
        ssvc: ticket.ssvc_deployer_priority,
        safetyImpact: ticket.ticket_status.current_safety_impact || "-",
        packageManager: matchedReference?.package_manager || "-",
        ticket: ticket, // 元のticketデータも保持
      };
    });
  }, [tickets, references]);

  // ステータスのグループ定義
  const statusGroups = useMemo(
    () => ({
      未着手: ["alerted"],
      対応中: ["acknowledged", "scheduled"],
      完了: ["completed"],
    }),
    [],
  );

  // チケットをグループごとに分類
  const groupedTicketsData = useMemo(() => {
    const grouped = {
      未着手: [],
      対応中: [],
      完了: [],
    };

    ticketsWithDetails.forEach((ticket) => {
      const status = ticket.status;
      if (statusGroups.未着手.includes(status)) {
        grouped.未着手.push(ticket);
      } else if (statusGroups.対応中.includes(status)) {
        grouped.対応中.push(ticket);
      } else if (statusGroups.完了.includes(status)) {
        grouped.完了.push(ticket);
      }
    });

    return grouped;
  }, [ticketsWithDetails, statusGroups]);

  // 表示用のステータスグループ一覧
  const statusGroupNames = useMemo(() => ["未着手", "対応中", "完了"], []);

  const selectedTicket =
    selectedStatus && groupedTicketsData[selectedStatus] && selectedIndex >= 0
      ? groupedTicketsData[selectedStatus][selectedIndex]
      : null;

  const handleListItemClick = (status, index) => {
    setSelectedStatus(status);
    setSelectedIndex(index);
  };

  const handleCloseDetailView = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  const handleExited = () => {
    setSelectedStatus(null);
    setSelectedIndex(-1);
  };

  const [pcInfoOpen, setPcInfoOpen] = useState(false);
  const [mobileView, setMobileView] = useState("list");
  const handleBackToList = () => setMobileView("list");
  const handleShowInfo = () => setMobileView("info");
  const [selectedTicketId, setSelectedTicketId] = useState(tickets[0]?.ticket_id || null);
  const handleTicketSelect = (ticketId) => {
    setSelectedTicketId(ticketId);
    if (isMobile) setMobileView("task");
  };

  return (
    <Dialog
      open={open}
      onClose={onClose}
      fullWidth
      maxWidth="lg"
      aria-labelledby="task-dialog-title"
      slotProps={{ transition: { onExited: handleExited } }}
    >
      <DialogTitle
        id="task-dialog-title"
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        Ticket List & Details
        <IconButton onClick={onClose} aria-label="close">
          <Close />
        </IconButton>
      </DialogTitle>
      <DialogContent
        dividers
        sx={{ p: 0, height: "85vh", display: "flex", flexDirection: "column" }}
      >
        {!isMobile && (
          <ClickAwayListener onClickAway={() => setPcInfoOpen(false)}>
            <Box sx={{ position: "relative", zIndex: 20 }}>
              <Box
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: 1,
                  p: 1.5,
                  px: 2,
                  bgcolor: orange[50],
                  borderBottom: 1,
                  borderColor: orange[200],
                  cursor: "pointer",
                  "&:hover": { bgcolor: orange[100] },
                }}
                onClick={() => setPcInfoOpen(!pcInfoOpen)}
                role="button"
                tabIndex={0}
                aria-label="Toggle Details"
                aria-expanded={pcInfoOpen}
              >
                <Warning color="warning" fontSize="small" />
                <Typography
                  variant="subtitle1"
                  noWrap
                  sx={{ fontWeight: "bold", flexGrow: 1, color: "warning.dark" }}
                >
                  {vulnData?.cve_id}: {vulnData?.title}
                </Typography>
                <Chip
                  label={`CVSS: ${vulnData?.cvss_v3_score || "N/A"}`}
                  size="small"
                  sx={{
                    mr: 1,
                    bgcolor: getCvssColor(vulnData?.cvss_v3_score),
                    color: "white",
                    fontWeight: "bold",
                  }}
                />
                <ExpandMore
                  sx={{
                    transform: pcInfoOpen ? "rotate(180deg)" : "rotate(0deg)",
                    transition: "transform 0.3s",
                    flexShrink: 0,
                  }}
                />
              </Box>
              {pcInfoOpen && (
                <Paper
                  elevation={4}
                  square
                  sx={{
                    position: "absolute",
                    top: "100%",
                    left: 0,
                    right: 0,
                    maxHeight: "60vh",
                    overflowY: "auto",
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                    boxShadow: 2,
                  }}
                >
                  <PackageInfoContent vulnData={vulnData} actionsWithUiId={actionsWithUiId} />
                </Paper>
              )}
            </Box>
          </ClickAwayListener>
        )}
        <Box sx={{ display: "flex", flex: 1, overflow: "hidden", flexDirection: "row" }}>
          <Box
            sx={{
              display: isMobile && mobileView === "task" ? "none" : "block",
              width: { xs: "100%", md: "45%" },
              borderRight: 1,
              borderColor: "divider",
              overflowY: "auto",
              flexShrink: 0,
            }}
          >
            {isMobile && mobileView === "info" ? (
              <Box sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                <Box
                  sx={{
                    position: "sticky",
                    top: 0,
                    zIndex: 10,
                    bgcolor: grey[50],
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                  }}
                >
                  <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                    Back to List
                  </Button>
                </Box>
                <Box sx={{ p: 3 }}>
                  <Typography
                    variant="h6"
                    gutterBottom
                    color="warning.main"
                    sx={{ fontWeight: "bold", display: "flex", alignItems: "center", gap: 1 }}
                  >
                    <Warning />
                    Vulnerability Details
                  </Typography>
                  <Divider sx={{ mb: 2 }} />
                  <PackageInfoContent vulnData={vulnData} actionsWithUiId={actionsWithUiId} />
                </Box>
              </Box>
            ) : (
              <>
                <TicketSidebar
                  tickets={ticketsWithDetails}
                  selectedTicketId={selectedTicketId}
                  onSelect={handleTicketSelect}
                  onShowInfo={handleShowInfo}
                  isMobile={isMobile}
                  mobileView={mobileView}
                />
              </>
            )}
          </Box>
        </Box>
        {false && (
          <Box sx={{ height: "85vh", display: "flex", flexDirection: "column" }}>
            {/* 可変エリア (リスト/詳細) */}
            <Box sx={{ flexGrow: 1, overflow: "hidden" }}>
              {isMobile ? (
                // モバイル表示
                <Box sx={{ height: "100%", position: "relative" }}>
                  {/* ステージ1: タスク一覧 */}
                  <Box
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      height: "100%",
                    }}
                  >
                    <ListPanel
                      groupedTicketsData={groupedTicketsData}
                      statusGroups={statusGroupNames}
                      selectedStatus={selectedStatus}
                      selectedIndex={selectedIndex}
                      onListItemClick={handleListItemClick}
                    />
                  </Box>

                  {/* ステージ2: タスク詳細 */}
                  <Slide direction="left" in={!!selectedTicket} mountOnEnter unmountOnExit>
                    <Box
                      sx={{
                        position: "absolute",
                        top: 0,
                        left: 0,
                        width: "100%",
                        height: "100%",
                      }}
                    >
                      <DetailPanel
                        selectedTicket={selectedTicket}
                        vulnData={vulnData}
                        isMobile={isMobile}
                        onCloseDetailView={handleCloseDetailView}
                      />
                    </Box>
                  </Slide>
                </Box>
              ) : (
                // PC表示
                <Box sx={{ display: "flex", height: "100%" }}>
                  <ListPanel
                    groupedTicketsData={groupedTicketsData}
                    statusGroups={statusGroupNames}
                    selectedStatus={selectedStatus}
                    selectedIndex={selectedIndex}
                    onListItemClick={handleListItemClick}
                  />
                  <DetailPanel
                    selectedTicket={selectedTicket}
                    vulnData={vulnData}
                    isMobile={isMobile}
                    onCloseDetailView={handleCloseDetailView}
                  />
                </Box>
              )}
            </Box>
          </Box>
        )}
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
  vulnData: PropTypes.object,
  vulnActions: PropTypes.array,
  tickets: PropTypes.array,
  references: PropTypes.array,
};
