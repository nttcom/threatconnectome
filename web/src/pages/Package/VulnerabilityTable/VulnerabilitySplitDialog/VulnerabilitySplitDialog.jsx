import { ArrowBack, Close, ExpandMore, Warning } from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  ClickAwayListener,
  Typography,
  Chip,
  Paper,
  Button,
  Divider,
} from "@mui/material";
import { grey, orange } from "@mui/material/colors";
import PropTypes from "prop-types";
import { useState } from "react";

import { useVulnTableRowVuln } from "../api";

import { PackageInfoContent } from "./PackageInfoContent";
import { TicketDetailPanel } from "./TicketDetailPanel";
import { TicketSidebar } from "./TicketSidebar";
import { useVulnDialog } from "./VulnDialogContext";
import { getCvssColor } from "./utils/utils";

export function VulnerabilitySplitDialog({ open, onClose }) {
  const { vulnId } = useVulnDialog();
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  // Fetch data
  const { data: vulnData } = useVulnTableRowVuln(vulnId);

  const [pcInfoOpen, setPcInfoOpen] = useState(false);
  const [mobileView, setMobileView] = useState("list");
  const handleBackToList = () => setMobileView("list");
  const handleShowInfo = () => setMobileView("info");
  const [selectedTicketId, setSelectedTicketId] = useState(null);

  const handleTicketSelect = (ticketId) => {
    setSelectedTicketId(ticketId);
    if (isMobile) setMobileView("ticket");
  };

  const handleExited = () => {
    setSelectedTicketId(null);
    setPcInfoOpen(false);
    setMobileView("list");
  };

  return (
    <Dialog
      open={open}
      onClose={onClose}
      fullWidth
      maxWidth="lg"
      aria-labelledby="ticket-dialog-title"
      slotProps={{
        transition: {
          onExited: handleExited,
        },
      }}
    >
      <DialogTitle
        id="ticket-dialog-title"
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        Ticket List & Details
        <IconButton onClick={onClose} aria-label="close">
          <Close />
        </IconButton>
      </DialogTitle>
      <DialogContent
        dividers
        sx={{ p: 0, height: "85vh", display: "flex", flexDirection: "column" }}
      >
        {!isMobile && (
          <ClickAwayListener onClickAway={() => setPcInfoOpen(false)}>
            <Box sx={{ position: "relative", zIndex: 20 }}>
              <Box
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: 1,
                  p: 1.5,
                  px: 2,
                  bgcolor: orange[50],
                  borderBottom: 1,
                  borderColor: orange[200],
                  cursor: "pointer",
                  "&:hover": { bgcolor: orange[100] },
                }}
                onClick={() => setPcInfoOpen(!pcInfoOpen)}
                role="button"
                tabIndex={0}
                aria-label="Toggle Details"
                aria-expanded={pcInfoOpen}
              >
                <Warning color="warning" fontSize="small" />
                <Typography
                  variant="subtitle1"
                  noWrap
                  sx={{ fontWeight: "bold", flexGrow: 1, color: "warning.dark" }}
                >
                  {vulnData?.cve_id}: {vulnData?.title}
                </Typography>
                <Chip
                  label={`CVSS: ${vulnData?.cvss_v3_score || "N/A"}`}
                  size="small"
                  sx={{
                    mr: 1,
                    bgcolor: getCvssColor(vulnData?.cvss_v3_score),
                    color: "white",
                    fontWeight: "bold",
                  }}
                />
                <ExpandMore
                  sx={{
                    transform: pcInfoOpen ? "rotate(180deg)" : "rotate(0deg)",
                    transition: "transform 0.3s",
                    flexShrink: 0,
                  }}
                />
              </Box>
              {pcInfoOpen && (
                <Paper
                  elevation={4}
                  square
                  sx={{
                    position: "absolute",
                    top: "100%",
                    left: 0,
                    right: 0,
                    maxHeight: "60vh",
                    overflowY: "auto",
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                    boxShadow: 2,
                  }}
                >
                  <PackageInfoContent />
                </Paper>
              )}
            </Box>
          </ClickAwayListener>
        )}
        <Box sx={{ display: "flex", flex: 1, overflow: "hidden", flexDirection: "row" }}>
          <Box
            sx={{
              display: isMobile && mobileView === "ticket" ? "none" : "block",
              width: { xs: "100%", md: "45%" },
              borderRight: 1,
              borderColor: "divider",
              overflowY: "auto",
              flexShrink: 0,
            }}
          >
            {isMobile && mobileView === "info" ? (
              <Box sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                <Box
                  sx={{
                    position: "sticky",
                    top: 0,
                    zIndex: 10,
                    bgcolor: grey[50],
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                  }}
                >
                  <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                    Back to List
                  </Button>
                </Box>
                <Box sx={{ p: 3 }}>
                  <Typography
                    variant="h6"
                    gutterBottom
                    color="warning.main"
                    sx={{ fontWeight: "bold", display: "flex", alignItems: "center", gap: 1 }}
                  >
                    <Warning />
                    Vulnerability Details
                  </Typography>
                  <Divider sx={{ mb: 2 }} />
                  <PackageInfoContent />
                </Box>
              </Box>
            ) : (
              <TicketSidebar
                selectedTicketId={selectedTicketId}
                onSelect={handleTicketSelect}
                onShowInfo={handleShowInfo}
                mobileView={mobileView}
                isMobile={isMobile}
              />
            )}
          </Box>
          <Box
            sx={{
              display: isMobile && mobileView !== "ticket" ? "none" : "block",
              flex: 1,
              overflowY: "auto",
              bgcolor: grey[100],
              position: "relative",
            }}
          >
            {isMobile && (
              <Box
                sx={{
                  position: "sticky",
                  top: 0,
                  zIndex: 10,
                  bgcolor: grey[100],
                  p: 2,
                  borderBottom: 1,
                  borderColor: "divider",
                  boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                }}
              >
                <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                  Back to List
                </Button>
              </Box>
            )}

            <Box sx={{ p: 3 }}>
              <TicketDetailPanel ticketId={selectedTicketId} />
            </Box>
          </Box>
        </Box>
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
};
