import { ArrowBack, Close, ExpandMore, Warning } from "@mui/icons-material";
import {
  Box,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  ClickAwayListener,
  Typography,
  Chip,
  Paper,
  Button,
  Divider,
} from "@mui/material";
import { grey, orange } from "@mui/material/colors";
import PropTypes from "prop-types";
import { useState, useEffect } from "react";

import { usePageParams } from "../../../../hooks/usePageParams";
import { createActionByFixedVersions, findMatchedVulnPackage } from "../../../../utils/vulnUtils";
import { useVulnTableRowVuln, useVulnTableRowTickets, useVulnTableRowDependency } from "../api";

import { PackageInfoContent } from "./PackageInfoContent";
import { TaskDetailPanel } from "./TaskDetailPanel";
import { TicketSidebar } from "./TicketSidebar";
import { getCvssColor } from "./utils/utils";

export default function VulnerabilitySplitDialog({ open, onClose, vulnId }) {
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  const { pteamId, serviceId, packageId } = usePageParams();

  // データ取得
  const { data: vulnData } = useVulnTableRowVuln(vulnId);
  const { tickets = [] } = useVulnTableRowTickets({ pteamId, serviceId, vulnId, packageId });
  const { serviceDependency } = useVulnTableRowDependency({ pteamId, serviceId, packageId });

  // 緩和策を生成
  const getActionsWithUiId = () => {
    if (!vulnData?.vulnerable_packages) return [];

    const currentPackage = {
      package_name: serviceDependency?.package_name,
      package_source_name: serviceDependency?.package_source_name,
      vuln_matching_ecosystem: serviceDependency?.vuln_matching_ecosystem,
    };

    const matchedVulnPackage = findMatchedVulnPackage(vulnData.vulnerable_packages, currentPackage);
    if (!matchedVulnPackage) return [];

    const affectedVersions = matchedVulnPackage?.affected_versions ?? [];
    const patchedVersions = matchedVulnPackage?.fixed_versions ?? [];
    const actionByFixedVersions = createActionByFixedVersions(
      affectedVersions,
      patchedVersions,
      matchedVulnPackage?.affected_name ?? "",
    );

    return actionByFixedVersions ? [{ ...actionByFixedVersions, uiId: "action-0" }] : [];
  };

  const actionsWithUiId = getActionsWithUiId();

  const ticketsWithDetails = tickets.map((ticket) => ({
    id: ticket.ticket_id,
    target: serviceDependency?.target || "Unknown Target",
    status: ticket.ticket_status.ticket_handling_status || "alerted",
    assignee: ticket.ticket_status.assignees?.[0] || "未割当",
    deadline: ticket.ticket_status.scheduled_at,
    ssvc: ticket.ssvc_deployer_priority,
    safetyImpact: ticket.ticket_status.current_safety_impact || "-",
    packageManager: serviceDependency?.package_manager || "-",
    ticket: ticket,
  }));

  const [pcInfoOpen, setPcInfoOpen] = useState(false);
  const [mobileView, setMobileView] = useState("list");
  const handleBackToList = () => setMobileView("list");
  const handleShowInfo = () => setMobileView("info");
  const [selectedTicketId, setSelectedTicketId] = useState(null);

  // ticketsが変更されたら最初のチケットを選択
  useEffect(() => {
    if (tickets.length > 0) {
      setSelectedTicketId(tickets[0].ticket_id);
    }
  }, [tickets]);

  const handleTicketSelect = (ticketId) => {
    setSelectedTicketId(ticketId);
    if (isMobile) setMobileView("task");
  };
  const selectedTicketData = ticketsWithDetails.find((t) => t.id === selectedTicketId);

  return (
    <Dialog
      open={open}
      onClose={onClose}
      fullWidth
      maxWidth="lg"
      aria-labelledby="task-dialog-title"
    >
      <DialogTitle
        id="task-dialog-title"
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        Ticket List & Details
        <IconButton onClick={onClose} aria-label="close">
          <Close />
        </IconButton>
      </DialogTitle>
      <DialogContent
        dividers
        sx={{ p: 0, height: "85vh", display: "flex", flexDirection: "column" }}
      >
        {!isMobile && (
          <ClickAwayListener onClickAway={() => setPcInfoOpen(false)}>
            <Box sx={{ position: "relative", zIndex: 20 }}>
              <Box
                sx={{
                  display: "flex",
                  alignItems: "center",
                  gap: 1,
                  p: 1.5,
                  px: 2,
                  bgcolor: orange[50],
                  borderBottom: 1,
                  borderColor: orange[200],
                  cursor: "pointer",
                  "&:hover": { bgcolor: orange[100] },
                }}
                onClick={() => setPcInfoOpen(!pcInfoOpen)}
                role="button"
                tabIndex={0}
                aria-label="Toggle Details"
                aria-expanded={pcInfoOpen}
              >
                <Warning color="warning" fontSize="small" />
                <Typography
                  variant="subtitle1"
                  noWrap
                  sx={{ fontWeight: "bold", flexGrow: 1, color: "warning.dark" }}
                >
                  {vulnData?.cve_id}: {vulnData?.title}
                </Typography>
                <Chip
                  label={`CVSS: ${vulnData?.cvss_v3_score || "N/A"}`}
                  size="small"
                  sx={{
                    mr: 1,
                    bgcolor: getCvssColor(vulnData?.cvss_v3_score),
                    color: "white",
                    fontWeight: "bold",
                  }}
                />
                <ExpandMore
                  sx={{
                    transform: pcInfoOpen ? "rotate(180deg)" : "rotate(0deg)",
                    transition: "transform 0.3s",
                    flexShrink: 0,
                  }}
                />
              </Box>
              {pcInfoOpen && (
                <Paper
                  elevation={4}
                  square
                  sx={{
                    position: "absolute",
                    top: "100%",
                    left: 0,
                    right: 0,
                    maxHeight: "60vh",
                    overflowY: "auto",
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                    boxShadow: 2,
                  }}
                >
                  <PackageInfoContent vulnData={vulnData} actionsWithUiId={actionsWithUiId} />
                </Paper>
              )}
            </Box>
          </ClickAwayListener>
        )}
        <Box sx={{ display: "flex", flex: 1, overflow: "hidden", flexDirection: "row" }}>
          <Box
            sx={{
              display: isMobile && mobileView === "task" ? "none" : "block",
              width: { xs: "100%", md: "45%" },
              borderRight: 1,
              borderColor: "divider",
              overflowY: "auto",
              flexShrink: 0,
            }}
          >
            {isMobile && mobileView === "info" ? (
              <Box sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                <Box
                  sx={{
                    position: "sticky",
                    top: 0,
                    zIndex: 10,
                    bgcolor: grey[50],
                    p: 2,
                    borderBottom: 1,
                    borderColor: "divider",
                  }}
                >
                  <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                    Back to List
                  </Button>
                </Box>
                <Box sx={{ p: 3 }}>
                  <Typography
                    variant="h6"
                    gutterBottom
                    color="warning.main"
                    sx={{ fontWeight: "bold", display: "flex", alignItems: "center", gap: 1 }}
                  >
                    <Warning />
                    Vulnerability Details
                  </Typography>
                  <Divider sx={{ mb: 2 }} />
                  <PackageInfoContent vulnData={vulnData} actionsWithUiId={actionsWithUiId} />
                </Box>
              </Box>
            ) : (
              <TicketSidebar
                tickets={ticketsWithDetails}
                selectedTicketId={selectedTicketId}
                onSelect={handleTicketSelect}
                onShowInfo={handleShowInfo}
                isMobile={isMobile}
                mobileView={mobileView}
              />
            )}
          </Box>
          <Box
            sx={{
              display: isMobile && mobileView !== "task" ? "none" : "block",
              flex: 1,
              overflowY: "auto",
              bgcolor: grey[100],
              position: "relative",
            }}
          >
            {isMobile && (
              <Box
                sx={{
                  position: "sticky",
                  top: 0,
                  zIndex: 10,
                  bgcolor: grey[100],
                  p: 2,
                  borderBottom: 1,
                  borderColor: "divider",
                  boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                }}
              >
                <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                  Back to List
                </Button>
              </Box>
            )}

            <Box sx={{ p: 3 }}>
              {selectedTicketData ? (
                <TaskDetailPanel ticket={selectedTicketData} />
              ) : (
                <Box
                  sx={{
                    display: "flex",
                    justifyContent: "center",
                    alignItems: "center",
                    height: "100%",
                    minHeight: "200px",
                  }}
                >
                  <Typography variant="body1" color="text.secondary">
                    Select a ticket from the list on the left
                  </Typography>
                </Box>
              )}
            </Box>
          </Box>
        </Box>
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
  vulnId: PropTypes.string.isRequired,
};
