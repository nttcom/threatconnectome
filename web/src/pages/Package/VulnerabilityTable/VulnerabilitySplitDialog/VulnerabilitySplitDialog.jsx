import { ArrowBack, Close, ExpandMore, Warning } from "@mui/icons-material";
import {
  alpha,
  Box,
  CircularProgress,
  Dialog,
  DialogTitle,
  DialogContent,
  useTheme,
  useMediaQuery,
  IconButton,
  ClickAwayListener,
  Typography,
  Chip,
  Paper,
  Button,
  Divider,
} from "@mui/material";
import { grey } from "@mui/material/colors";
import PropTypes from "prop-types";
import { useState } from "react";

import {
  useGetDependencies,
  useGetVuln,
} from "../../../../hooks/Package/useApiForVulnerabilityTable.js";
import { usePageParams } from "../../../../hooks/usePageParams";
import { getCvssColor } from "../../../../utils/cvssUtils";
import { findMatchedVulnPackage } from "../../../../utils/vulnUtils";
import { useVulnDialogContext } from "../VulnDialogContext";

import { TicketDetailPanel } from "./TicketDetailPanel/TicketDetailPanel";
import { TicketSidebar } from "./TicketSidebar/TicketSidebar";
import { VulnInfoContent } from "./VulnInfoContent";

export function VulnerabilitySplitDialog({ open, onClose }) {
  const { vulnId } = useVulnDialogContext();
  const { pteamId, serviceId, packageId } = usePageParams();
  const theme = useTheme();
  const isMobile = useMediaQuery(theme.breakpoints.down("md"));

  const { data: vulnData, error: vulnError, isLoading: vulnIsLoading } = useGetVuln(vulnId);
  const {
    data: dependencies,
    error: dependenciesError,
    isLoading: dependenciesIsLoading,
  } = useGetDependencies({
    pteamId,
    serviceId,
    packageId,
  });

  const isLoading = vulnIsLoading || dependenciesIsLoading;
  const hasError = vulnError || dependenciesError;

  const currentPackage = {
    package_name: dependencies?.[0]?.package_name,
    package_source_name: dependencies?.[0]?.package_source_name,
    vuln_matching_ecosystem: dependencies?.[0]?.vuln_matching_ecosystem,
  };
  const matchedVulnPackage = findMatchedVulnPackage(vulnData?.vulnerable_packages, currentPackage);
  const fixedVersions = matchedVulnPackage?.fixed_versions ?? [];
  const fixedVersionDisplay = fixedVersions[0];

  const severityColorToken = getCvssColor(vulnData?.cvss_v3_score);
  const getActualColor = (token) => {
    const [palette, shade] = token.split(".");
    return theme.palette[palette]?.[shade] || token;
  };
  const severityColor = getActualColor(severityColorToken);

  const [pcVulnInfoOpen, setPcVulnInfoOpen] = useState(false);
  const [mobileView, setMobileView] = useState("list");
  const handleBackToList = () => setMobileView("list");
  const handleShowVulnInfo = () => setMobileView("info");
  const [selectedTicketId, setSelectedTicketId] = useState(null);

  const handleTicketSelect = (ticketId) => {
    setSelectedTicketId(ticketId);
    if (isMobile) setMobileView("ticket");
  };

  const handleExited = () => {
    setSelectedTicketId(null);
    setPcVulnInfoOpen(false);
    setMobileView("list");
  };

  return (
    <Dialog
      open={open}
      onClose={onClose}
      fullWidth
      maxWidth="lg"
      aria-labelledby="ticket-dialog-title"
      slotProps={{
        transition: {
          onExited: handleExited,
        },
      }}
    >
      <DialogTitle
        id="ticket-dialog-title"
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "center",
        }}
      >
        Ticket List & Details
        <IconButton onClick={onClose} aria-label="close">
          <Close />
        </IconButton>
      </DialogTitle>
      <DialogContent
        dividers
        sx={{ p: 0, height: "85vh", display: "flex", flexDirection: "column" }}
      >
        {isLoading ? (
          <Box
            sx={{
              display: "flex",
              justifyContent: "center",
              alignItems: "center",
              height: "100%",
            }}
          >
            <CircularProgress />
          </Box>
        ) : hasError ? (
          <Box
            sx={{
              display: "flex",
              justifyContent: "center",
              alignItems: "center",
              height: "100%",
              p: 3,
            }}
          >
            <Typography color="error">
              Failed to load vulnerability data. Please try again later.
            </Typography>
          </Box>
        ) : (
          <>
            {!isMobile && (
              <ClickAwayListener onClickAway={() => setPcVulnInfoOpen(false)}>
                <Box sx={{ position: "relative", zIndex: 20 }}>
                  <Box
                    sx={{
                      display: "flex",
                      alignItems: "center",
                      gap: 1,
                      p: 1.5,
                      px: 2,
                      bgcolor: alpha(severityColor, 0.08),
                      borderBottom: 1,
                      borderColor: "divider",
                      cursor: "pointer",
                      transition: "background-color 0.2s",
                      "&:hover": { bgcolor: grey[100] },
                    }}
                    onClick={() => setPcVulnInfoOpen(!pcVulnInfoOpen)}
                    role="button"
                    tabIndex={0}
                    aria-label="Toggle Details"
                    aria-expanded={pcVulnInfoOpen}
                  >
                    <Warning sx={{ color: severityColor }} fontSize="small" />
                    <Typography
                      variant="subtitle1"
                      noWrap
                      sx={{ fontWeight: "bold", flexGrow: 1, color: "text.primary" }}
                    >
                      {vulnData?.cve_id}: {vulnData?.title}
                    </Typography>
                    <Chip
                      label={fixedVersionDisplay ? `Fixed: v${fixedVersionDisplay}` : "No fix yet"}
                      size="small"
                      variant="outlined"
                      color={fixedVersionDisplay ? "success" : "default"}
                      sx={{ mr: 1, fontWeight: "bold", bgcolor: "background.paper" }}
                    />
                    <Chip
                      label={`CVSS: ${vulnData?.cvss_v3_score || "N/A"}`}
                      size="small"
                      sx={{
                        mr: 1,
                        bgcolor: severityColor,
                        color: "white",
                        fontWeight: "bold",
                      }}
                    />
                    <ExpandMore
                      sx={{
                        transform: pcVulnInfoOpen ? "rotate(180deg)" : "rotate(0deg)",
                        transition: "transform 0.3s",
                        flexShrink: 0,
                      }}
                    />
                  </Box>
                  {pcVulnInfoOpen && (
                    <Paper
                      elevation={4}
                      square
                      sx={{
                        position: "absolute",
                        top: "100%",
                        left: 0,
                        right: 0,
                        maxHeight: "60vh",
                        overflowY: "auto",
                        p: 2,
                        borderBottom: 1,
                        borderColor: "divider",
                        boxShadow: 2,
                      }}
                    >
                      <VulnInfoContent />
                    </Paper>
                  )}
                </Box>
              </ClickAwayListener>
            )}
            <Box sx={{ display: "flex", flex: 1, overflow: "hidden", flexDirection: "row" }}>
              <Box
                sx={{
                  display: isMobile && mobileView === "ticket" ? "none" : "block",
                  width: { xs: "100%", md: "45%" },
                  borderRight: 1,
                  borderColor: "divider",
                  overflowY: "auto",
                  flexShrink: 0,
                }}
              >
                {isMobile && mobileView === "info" ? (
                  <Box sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
                    <Box
                      sx={{
                        position: "sticky",
                        top: 0,
                        zIndex: 10,
                        bgcolor: grey[50],
                        p: 2,
                        borderBottom: 1,
                        borderColor: "divider",
                      }}
                    >
                      <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                        Back to List
                      </Button>
                    </Box>
                    <Box sx={{ p: 3 }}>
                      <Typography
                        variant="h6"
                        gutterBottom
                        color="warning.main"
                        sx={{ fontWeight: "bold", display: "flex", alignItems: "center", gap: 1 }}
                      >
                        <Warning />
                        Vulnerability Details
                      </Typography>
                      <Divider sx={{ mb: 2 }} />
                      <VulnInfoContent />
                    </Box>
                  </Box>
                ) : (
                  <TicketSidebar
                    selectedTicketId={selectedTicketId}
                    onSelect={handleTicketSelect}
                    onShowVulnInfo={handleShowVulnInfo}
                    mobileView={mobileView}
                    isMobile={isMobile}
                    cveId={vulnData?.cve_id}
                  />
                )}
              </Box>
              <Box
                sx={{
                  display: isMobile && mobileView !== "ticket" ? "none" : "block",
                  flex: 1,
                  overflowY: "auto",
                  bgcolor: grey[100],
                  position: "relative",
                }}
              >
                {isMobile && (
                  <Box
                    sx={{
                      position: "sticky",
                      top: 0,
                      zIndex: 10,
                      bgcolor: grey[100],
                      p: 2,
                      borderBottom: 1,
                      borderColor: "divider",
                      boxShadow: "0 2px 4px rgba(0,0,0,0.05)",
                    }}
                  >
                    <Button startIcon={<ArrowBack />} onClick={handleBackToList} variant="text">
                      Back to List
                    </Button>
                  </Box>
                )}

                <Box sx={{ p: 3 }}>
                  <TicketDetailPanel ticketId={selectedTicketId} />
                </Box>
              </Box>
            </Box>
          </>
        )}
      </DialogContent>
    </Dialog>
  );
}

VulnerabilitySplitDialog.propTypes = {
  open: PropTypes.bool.isRequired,
  onClose: PropTypes.func.isRequired,
};
