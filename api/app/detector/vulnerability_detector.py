from sqlalchemy.orm import Session

from app import models, persistence
from app.detector import version
from app.detector.version import PackageFamily, VulnerableRange


def detect_vulnerability_by_dependency(db: Session, dependency: models.Dependency) -> list[str]:
    """
    Vulnerability Detection when created dependency.
    """
    package_version = dependency.package_version

    affects = persistence.get_affect_by_package_id(db, package_version.package_id)
    matched_vuln_ids: set[str] = set()
    for affect in affects:
        matched_package_version_ids: set[str] = detect_vulnerability_by_affect(affect)
        if package_version.package_version_id in matched_package_version_ids:
            matched_vuln_ids.add(affect.vuln_id)

    return list(matched_vuln_ids)


def detect_vulnerability_by_vuln(vuln: models.Vuln) -> list[str]:
    """
    Vulnerability Detection when created vuln.
    """
    matched_package_version_ids: set[str] = set()
    for affect in vuln.affects:
        matched_package_version_ids.union(detect_vulnerability_by_affect(affect))
    return list(matched_package_version_ids)


def detect_vulnerability_by_affect(affect: models.Affect) -> set[str]:
    matched_package_version_ids: set[str] = set()
    for package_version in affect.package.package_versions:
        if _detect_matched(package_version, affect):
            matched_package_version_ids.add(package_version.package_version_id)
    return matched_package_version_ids


def _detect_matched(package_version: models.PackageVersion, affect: models.Affect) -> bool:
    package_family = PackageFamily.from_registry(package_version.package.ecosystem)
    dependency_version = version.gen_version_instance(package_family, package_version.version)

    for affected_version in _get_affected_versions(affect):
        try:
            vulnerableRange = VulnerableRange.from_string(package_family, affected_version)
            if vulnerableRange.detect_matched({dependency_version}):
                return True
        except ValueError:
            pass  # ignore unexpected range strings
    return False


def _get_affected_versions(affect: models.Affect) -> list[str]:
    if len(affect.affected_versions) > 0:
        return affect.affected_versions
    if len(affect.fixed_versions) > 0:
        return _change_versions_from_fixed_to_affected(affect.fixed_versions)
    return []


def _change_versions_from_fixed_to_affected(fixed_versions: list[str]) -> list[str]:
    if len(fixed_versions) != 1 or "," in fixed_versions[0]:
        return []

    # guess vulnerable version only if we can
    fixed_version = fixed_versions[0]
    if fixed_version.startswith(">="):
        affected_version = fixed_version.replace(">=", "<", 1)
    elif fixed_version.startswith(">"):
        affected_version = fixed_version.replace(">", "<=", 1)
    elif fixed_version.startswith("~>="):
        affected_version = fixed_version.replace("~>=", "<", 1)
    elif fixed_version.startswith("~>"):
        affected_version = fixed_version.replace("~>", "<=", 1)
    else:
        affected_version = f"< {fixed_version}"
    return [affected_version]
